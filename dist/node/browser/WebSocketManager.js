"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketManager = exports.AuthMethod = exports.WebSocketState = void 0;
const eventemitter3_1 = __importDefault(require("eventemitter3"));
const BrowserConsoleStrategy_1 = require("./BrowserConsoleStrategy");
var WebSocketState;
(function (WebSocketState) {
    WebSocketState[WebSocketState["CONNECTING"] = 0] = "CONNECTING";
    WebSocketState[WebSocketState["OPEN"] = 1] = "OPEN";
    WebSocketState[WebSocketState["CLOSING"] = 2] = "CLOSING";
    WebSocketState[WebSocketState["CLOSED"] = 3] = "CLOSED";
})(WebSocketState || (exports.WebSocketState = WebSocketState = {}));
var AuthMethod;
(function (AuthMethod) {
    AuthMethod["TOKEN"] = "token";
    AuthMethod["CREDENTIALS"] = "credentials";
    AuthMethod["ANONYMOUS"] = "anonymous";
})(AuthMethod || (exports.AuthMethod = AuthMethod = {}));
class WebSocketManager extends eventemitter3_1.default {
    constructor(config) {
        super();
        this.reconnectAttempts = 0;
        this.state = WebSocketState.CLOSED;
        this.protocols = [];
        this.logger = new BrowserConsoleStrategy_1.BrowserConsoleStrategy();
        this.url = config.url;
        this.secure = config.secure || false;
        this.auth = config.auth;
        this.maxReconnectAttempts = config.maxReconnectAttempts || 5;
        this.reconnectInterval = config.reconnectInterval || 5000;
        this.connectionTimeout = config.connectionTimeout || 10000;
        this.setupAuthProtocols();
        this.connect();
    }
    setupAuthProtocols() {
        if (!this.auth)
            return;
        switch (this.auth.method) {
            case AuthMethod.TOKEN:
                if (this.auth.token) {
                    this.protocols.push(`token-${this.auth.token}`);
                }
                break;
            case AuthMethod.CREDENTIALS:
                if (this.auth.credentials) {
                    const { username, password } = this.auth.credentials;
                    const credentials = btoa(encodeURIComponent(password)).replace(/=/g, "");
                    this.protocols.push(`auth-${username}-${credentials}`);
                    this.logger.debug(`Auth protocol`, this.protocols);
                }
                break;
        }
    }
    connect() {
        this.state = WebSocketState.CONNECTING;
        const secureUrl = this.getSecureUrl(this.url, this.secure);
        // Add token to URL if using query parameter authentication
        const urlWithAuth = this.auth?.method === AuthMethod.TOKEN && this.auth.token
            ? `${secureUrl}?token=${this.auth.token}`
            : secureUrl;
        this.logger.info(`Attempting to connect to ${urlWithAuth}`);
        try {
            this.ws = new WebSocket(urlWithAuth, this.protocols);
            this.setHooks();
            this.setConnectionTimeout();
        }
        catch (error) {
            this.handleConnectionError(error);
        }
    }
    handleConnectionError(error) {
        this.logger.error("Connection error:", error);
        this.emit("error", {
            type: "CONNECTION_ERROR",
            message: "Failed to establish WebSocket connection",
            error,
        });
    }
    getSecureUrl(url, secure) {
        return secure ? url.replace(/^ws:/, "wss:") : url;
    }
    setHooks() {
        this.ws.onopen = () => {
            this.clearConnectionTimeout();
            this.state = WebSocketState.OPEN;
            this.reconnectAttempts = 0;
            this.logger.info(`WebSocket opened. ReadyState: ${this.ws.readyState}`);
            this.emit("open");
        };
        this.ws.onerror = (error) => {
            const wsError = error.target;
            if (wsError.readyState === WebSocket.CLOSED) {
                const errorDetails = {
                    type: "CONNECTION_ERROR",
                    message: "Connection failed",
                    readyState: wsError.readyState,
                    url: wsError.url,
                };
                if (this.reconnectAttempts === 0) {
                    // First connection attempt failed immediately - likely auth failure
                    errorDetails.type = "AUTH_ERROR";
                    errorDetails.message = "Authentication required";
                }
                this.logger.error("WebSocket error:", errorDetails);
                this.emit("error", errorDetails);
            }
            else {
                this.logger.error("WebSocket error:", error);
                this.emit("error", error);
            }
        };
        this.ws.onclose = (event) => {
            this.clearConnectionTimeout();
            this.state = WebSocketState.CLOSED;
            // Handle all potential authentication-related close codes
            if (event.code === 1001 || // Going Away
                event.code === 1006 || // Abnormal Closure (what browsers often use for 401)
                event.code === 1008) {
                // Policy Violation
                const error = {
                    type: "AUTH_ERROR",
                    code: event.code,
                    reason: event.reason || "Authentication required",
                };
                this.emit("error", error);
                return;
            }
            this.logger.info(`WebSocket closed. ReadyState: ${this.ws.readyState}. Code: ${event.code}, Reason: ${event.reason}`);
            this.emit("close", event);
            this.handleReconnection();
        };
        this.ws.onmessage = (event) => {
            const parsedData = this.parseMessage(event.data);
            this.emit("message", parsedData);
        };
    }
    handleReconnection() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            const minDelay = 1000;
            const delay = Math.max(minDelay, this.reconnectInterval * Math.pow(2, this.reconnectAttempts - 1));
            this.logger.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${delay}ms...`);
            setTimeout(() => this.connect(), delay);
        }
        else {
            this.logger.error("Max reconnection attempts reached. Please reconnect manually.");
            this.emit("maxReconnectAttemptsReached");
        }
    }
    setConnectionTimeout() {
        this.connectionTimer = window.setTimeout(() => {
            if (this.state === WebSocketState.CONNECTING) {
                this.logger.error("Connection attempt timed out");
                this.ws.close();
            }
        }, this.connectionTimeout);
    }
    clearConnectionTimeout() {
        if (this.connectionTimer) {
            window.clearTimeout(this.connectionTimer);
        }
    }
    parseMessage(data) {
        try {
            return JSON.parse(data);
        }
        catch (error) {
            return data;
        }
    }
    send(message) {
        if (this.state === WebSocketState.OPEN) {
            const data = typeof message === "string" ? message : JSON.stringify(message);
            this.ws.send(data);
        }
        else {
            const error = new Error("WebSocket is not open");
            this.emit("error", error);
        }
    }
    close() {
        this.state = WebSocketState.CLOSING;
        this.ws.close();
    }
    reconnect() {
        this.logger.debug("Manual reconnection initiated.");
        this.reconnectAttempts = 0;
        this.close();
        this.connect();
    }
    getState() {
        return this.state;
    }
    getReadyState() {
        return this.ws.readyState;
    }
    setAuthConfig(authConfig) {
        this.auth = authConfig;
        this.setupAuthProtocols();
    }
    isAuthenticated() {
        return this.state === WebSocketState.OPEN;
    }
    reconnectWithNewAuth(authConfig) {
        this.setAuthConfig(authConfig);
        this.reconnect();
    }
    destroy() {
        // Clear the connection timeout if it exists
        this.clearConnectionTimeout();
        // Close WebSocket connection if it exists
        if (this.ws) {
            // Remove all WebSocket event listeners
            this.ws.onopen = null;
            this.ws.onclose = null;
            this.ws.onerror = null;
            this.ws.onmessage = null;
            // Close the connection if it's not already closed
            if (this.state !== WebSocketState.CLOSED) {
                this.close();
            }
            this.ws = null;
        }
        // Clear all event listeners
        this.removeAllListeners();
        // Clear references
        this.logger = null;
        this.auth = undefined;
        this.protocols = [];
    }
}
exports.WebSocketManager = WebSocketManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0TWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL1dlYlNvY2tldE1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0VBQXlDO0FBQ3pDLHFFQUFrRTtBQUVsRSxJQUFZLGNBS1g7QUFMRCxXQUFZLGNBQWM7SUFDeEIsK0RBQVUsQ0FBQTtJQUNWLG1EQUFJLENBQUE7SUFDSix5REFBTyxDQUFBO0lBQ1AsdURBQU0sQ0FBQTtBQUNSLENBQUMsRUFMVyxjQUFjLDhCQUFkLGNBQWMsUUFLekI7QUFFRCxJQUFZLFVBSVg7QUFKRCxXQUFZLFVBQVU7SUFDcEIsNkJBQWUsQ0FBQTtJQUNmLHlDQUEyQixDQUFBO0lBQzNCLHFDQUF1QixDQUFBO0FBQ3pCLENBQUMsRUFKVyxVQUFVLDBCQUFWLFVBQVUsUUFJckI7QUFvQkQsTUFBYSxnQkFBaUIsU0FBUSx1QkFBWTtJQWNoRCxZQUFZLE1BQStCO1FBQ3pDLEtBQUssRUFBRSxDQUFDO1FBVEYsc0JBQWlCLEdBQVcsQ0FBQyxDQUFDO1FBRzlCLFVBQUssR0FBbUIsY0FBYyxDQUFDLE1BQU0sQ0FBQztRQUc5QyxjQUFTLEdBQWEsRUFBRSxDQUFDO1FBSS9CLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSwrQ0FBc0IsRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUN0QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQztRQUMxRCxJ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RXpCLGtEQUFrRDtZQUNsRCxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssY0FBYyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUN6QyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDZixDQUFDO1lBRUQsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFLLENBQUM7UUFDbEIsQ0FBQztRQUVELDRCQUE0QjtRQUM1QixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUUxQixtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFLLENBQUM7UUFDcEIsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUM7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBM1FELDRDQTJRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSBcImV2ZW50ZW1pdHRlcjNcIjtcbmltcG9ydCB7IEJyb3dzZXJDb25zb2xlU3RyYXRlZ3kgfSBmcm9tIFwiLi9Ccm93c2VyQ29uc29sZVN0cmF0ZWd5XCI7XG5cbmV4cG9ydCBlbnVtIFdlYlNvY2tldFN0YXRlIHtcbiAgQ09OTkVDVElORyxcbiAgT1BFTixcbiAgQ0xPU0lORyxcbiAgQ0xPU0VELFxufVxuXG5leHBvcnQgZW51bSBBdXRoTWV0aG9kIHtcbiAgVE9LRU4gPSBcInRva2VuXCIsXG4gIENSRURFTlRJQUxTID0gXCJjcmVkZW50aWFsc1wiLFxuICBBTk9OWU1PVVMgPSBcImFub255bW91c1wiLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElXZWJTb2NrZXRBdXRoQ29uZmlnIHtcbiAgbWV0aG9kOiBBdXRoTWV0aG9kO1xuICB0b2tlbj86IHN0cmluZztcbiAgY3JlZGVudGlhbHM/OiB7XG4gICAgdXNlcm5hbWU6IHN0cmluZztcbiAgICBwYXNzd29yZDogc3RyaW5nO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElXZWJTb2NrZXRNYW5hZ2VyQ29uZmlnIHtcbiAgdXJsOiBzdHJpbmc7XG4gIHNlY3VyZT86IGJvb2xlYW47XG4gIGF1dGg/OiBJV2ViU29ja2V0QXV0aENvbmZpZztcbiAgbWF4UmVjb25uZWN0QXR0ZW1wdHM/OiBudW1iZXI7XG4gIHJlY29ubmVjdEludGVydmFsPzogbnVtYmVyO1xuICBjb25uZWN0aW9uVGltZW91dD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldE1hbmFnZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBwcml2YXRlIGxvZ2dlcjogQnJvd3NlckNvbnNvbGVTdHJhdGVneTtcbiAgcHJpdmF0ZSB3cyE6IFdlYlNvY2tldDtcbiAgcHJpdmF0ZSB1cmw6IHN0cmluZztcbiAgcHJpdmF0ZSBzZWN1cmU6IGJvb2xlYW47XG4gIHByaXZhdGUgYXV0aD86IElXZWJTb2NrZXRBdXRoQ29uZmlnO1xuICBwcml2YXRlIHJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIG1heFJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXI7XG4gIHByaXZhdGUgcmVjb25uZWN0SW50ZXJ2YWw6IG51bWJlcjtcbiAgcHJpdmF0ZSBzdGF0ZTogV2ViU29ja2V0U3RhdGUgPSBXZWJTb2NrZXRTdGF0ZS5DTE9TRUQ7XG4gIHByaXZhdGUgY29ubmVjdGlvblRpbWVvdXQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBjb25uZWN0aW9uVGltZXI/OiBudW1iZXI7XG4gIHByaXZhdGUgcHJvdG9jb2xzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogSVdlYlNvY2tldE1hbmFnZXJDb25maWcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMubG9nZ2VyID0gbmV3IEJyb3dzZXJDb25zb2xlU3RyYXRlZ3koKTtcbiAgICB0aGlzLnVybCA9IGNvbmZpZy51cmw7XG4gICAgdGhpcy5zZWN1cmUgPSBjb25maWcuc2VjdXJlIHx8IGZhbHNlO1xuICAgIHRoaXMuYXV0aCA9IGNvbmZpZy5hdXRoO1xuICAgIHRoaXMubWF4UmVjb25uZWN0QXR0ZW1wdHMgPSBjb25maWcubWF4UmVjb25uZWN0QXR0ZW1wdHMgfHwgNTtcbiAgICB0aGlzLnJlY29ubmVjdEludGVydmFsID0gY29uZmlnLnJlY29ubmVjdEludGVydmFsIHx8IDUwMDA7XG4gICAgdGhpcy5jb25uZWN0aW9uVGltZW91dCA9IGNvbmZpZy5jb25uZWN0aW9uVGltZW91dCB8fCAxMDAwMDtcblxuICAgIHRoaXMuc2V0dXBBdXRoUHJvdG9jb2xzKCk7XG4gICAgdGhpcy5jb25uZWN0KCk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwQXV0aFByb3RvY29scygpIHtcbiAgICBpZiAoIXRoaXMuYXV0aCkgcmV0dXJuO1xuICAgIHN3aXRjaCAodGhpcy5hdXRoLm1ldGhvZCkge1xuICAgICAgY2FzZSBBdXRoTWV0aG9kLlRPS0VOOlxuICAgICAgICBpZiAodGhpcy5hdXRoLnRva2VuKSB7XG4gICAgICAgICAgdGhpcy5wcm90b2NvbHMucHVzaChgdG9rZW4tJHt0aGlzLmF1dGgudG9rZW59YCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEF1dGhNZXRob2QuQ1JFREVOVElBTFM6XG4gICAgICAgIGlmICh0aGlzLmF1dGguY3JlZGVudGlhbHMpIHtcbiAgICAgICAgICBjb25zdCB7IHVzZXJuYW1lLCBwYXNzd29yZCB9ID0gdGhpcy5hdXRoLmNyZWRlbnRpYWxzO1xuICAgICAgICAgIGNvbnN0IGNyZWRlbnRpYWxzID0gYnRvYShlbmNvZGVVUklDb21wb25lbnQocGFzc3dvcmQpKS5yZXBsYWNlKFxuICAgICAgICAgICAgLz0vZyxcbiAgICAgICAgICAgIFwiXCJcbiAgICAgICAgICApO1xuICAgICAgICAgIHRoaXMucHJvdG9jb2xzLnB1c2goYGF1dGgtJHt1c2VybmFtZX0tJHtjcmVkZW50aWFsc31gKTtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgQXV0aCBwcm90b2NvbGAsIHRoaXMucHJvdG9jb2xzKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNvbm5lY3QoKSB7XG4gICAgdGhpcy5zdGF0ZSA9IFdlYlNvY2tldFN0YXRlLkNPTk5FQ1RJTkc7XG5cbiAgICBjb25zdCBzZWN1cmVVcmwgPSB0aGlzLmdldFNlY3VyZVVybCh0aGlzLnVybCwgdGhpcy5zZWN1cmUpO1xuXG4gICAgLy8gQWRkIHRva2VuIHRvIFVSTCBpZiB1c2luZyBxdWVyeSBwYXJhbWV0ZXIgYXV0aGVudGljYXRpb25cbiAgICBjb25zdCB1cmxXaXRoQXV0aCA9XG4gICAgICB0aGlzLmF1dGg/Lm1ldGhvZCA9PT0gQXV0aE1ldGhvZC5UT0tFTiAmJiB0aGlzLmF1dGgudG9rZW5cbiAgICAgICAgPyBgJHtzZWN1cmVVcmx9P3Rva2VuPSR7dGhpcy5hdXRoLnRva2VufWBcbiAgICAgICAgOiBzZWN1cmVVcmw7XG5cbiAgICB0aGlzLmxvZ2dlci5pbmZvKGBBdHRlbXB0aW5nIHRvIGNvbm5lY3QgdG8gJHt1cmxXaXRoQXV0aH1gKTtcbiAgICB0cnkge1xuICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQodXJsV2l0aEF1dGgsIHRoaXMucHJvdG9jb2xzKTtcbiAgICAgIHRoaXMuc2V0SG9va3MoKTtcbiAgICAgIHRoaXMuc2V0Q29ubmVjdGlvblRpbWVvdXQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5oYW5kbGVDb25uZWN0aW9uRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlQ29ubmVjdGlvbkVycm9yKGVycm9yOiBhbnkpIHtcbiAgICB0aGlzLmxvZ2dlci5lcnJvcihcIkNvbm5lY3Rpb24gZXJyb3I6XCIsIGVycm9yKTtcbiAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCB7XG4gICAgICB0eXBlOiBcIkNPTk5FQ1RJT05fRVJST1JcIixcbiAgICAgIG1lc3NhZ2U6IFwiRmFpbGVkIHRvIGVzdGFibGlzaCBXZWJTb2NrZXQgY29ubmVjdGlvblwiLFxuICAgICAgZXJyb3IsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldFNlY3VyZVVybCh1cmw6IHN0cmluZywgc2VjdXJlOiBib29sZWFuKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc2VjdXJlID8gdXJsLnJlcGxhY2UoL153czovLCBcIndzczpcIikgOiB1cmw7XG4gIH1cblxuICBwcml2YXRlIHNldEhvb2tzKCkge1xuICAgIHRoaXMud3Mub25vcGVuID0gKCkgPT4ge1xuICAgICAgdGhpcy5jbGVhckNvbm5lY3Rpb25UaW1lb3V0KCk7XG4gICAgICB0aGlzLnN0YXRlID0gV2ViU29ja2V0U3RhdGUuT1BFTjtcbiAgICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgICAgdGhpcy5sb2dnZXIuaW5mbyhgV2ViU29ja2V0IG9wZW5lZC4gUmVhZHlTdGF0ZTogJHt0aGlzLndzLnJlYWR5U3RhdGV9YCk7XG4gICAgICB0aGlzLmVtaXQoXCJvcGVuXCIpO1xuICAgIH07XG5cbiAgICB0aGlzLndzLm9uZXJyb3IgPSAoZXJyb3I6IEV2ZW50KSA9PiB7XG4gICAgICBjb25zdCB3c0Vycm9yID0gZXJyb3IudGFyZ2V0IGFzIFdlYlNvY2tldDtcblxuICAgICAgaWYgKHdzRXJyb3IucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNMT1NFRCkge1xuICAgICAgICBjb25zdCBlcnJvckRldGFpbHMgPSB7XG4gICAgICAgICAgdHlwZTogXCJDT05ORUNUSU9OX0VSUk9SXCIsXG4gICAgICAgICAgbWVzc2FnZTogXCJDb25uZWN0aW9uIGZhaWxlZFwiLFxuICAgICAgICAgIHJlYWR5U3RhdGU6IHdzRXJyb3IucmVhZHlTdGF0ZSxcbiAgICAgICAgICB1cmw6IHdzRXJyb3IudXJsLFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aGlzLnJlY29ubmVjdEF0dGVtcHRzID09PSAwKSB7XG4gICAgICAgICAgLy8gRmlyc3QgY29ubmVjdGlvbiBhdHRlbXB0IGZhaWxlZCBpbW1lZGlhdGVseSAtIGxpa2VseSBhdXRoIGZhaWx1cmVcbiAgICAgICAgICBlcnJvckRldGFpbHMudHlwZSA9IFwiQVVUSF9FUlJPUlwiO1xuICAgICAgICAgIGVycm9yRGV0YWlscy5tZXNzYWdlID0gXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXCJXZWJTb2NrZXQgZXJyb3I6XCIsIGVycm9yRGV0YWlscyk7XG4gICAgICAgIHRoaXMuZW1pdChcImVycm9yXCIsIGVycm9yRGV0YWlscyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcIldlYlNvY2tldCBlcnJvcjpcIiwgZXJyb3IpO1xuICAgICAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnJvcik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMud3Mub25jbG9zZSA9IChldmVudCkgPT4ge1xuICAgICAgdGhpcy5jbGVhckNvbm5lY3Rpb25UaW1lb3V0KCk7XG4gICAgICB0aGlzLnN0YXRlID0gV2ViU29ja2V0U3RhdGUuQ0xPU0VEO1xuXG4gICAgICAvLyBIYW5kbGUgYWxsIHBvdGVudGlhbCBhdXRoZW50aWNhdGlvbi1yZWxhdGVkIGNsb3NlIGNvZGVzXG4gICAgICBpZiAoXG4gICAgICAgIGV2ZW50LmNvZGUgPT09IDEwMDEgfHwgLy8gR29pbmcgQXdheVxuICAgICAgICBldmVudC5jb2RlID09PSAxMDA2IHx8IC8vIEFibm9ybWFsIENsb3N1cmUgKHdoYXQgYnJvd3NlcnMgb2Z0ZW4gdXNlIGZvciA0MDEpXG4gICAgICAgIGV2ZW50LmNvZGUgPT09IDEwMDhcbiAgICAgICkge1xuICAgICAgICAvLyBQb2xpY3kgVmlvbGF0aW9uXG4gICAgICAgIGNvbnN0IGVycm9yID0ge1xuICAgICAgICAgIHR5cGU6IFwiQVVUSF9FUlJPUlwiLFxuICAgICAgICAgIGNvZGU6IGV2ZW50LmNvZGUsXG4gICAgICAgICAgcmVhc29uOiBldmVudC5yZWFzb24gfHwgXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnJvcik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIuaW5mbyhcbiAgICAgICAgYFdlYlNvY2tldCBjbG9zZWQuIFJlYWR5U3RhdGU6ICR7dGhpcy53cy5yZWFkeVN0YXRlfS4gQ29kZTogJHtldmVudC5jb2RlfSwgUmVhc29uOiAke2V2ZW50LnJlYXNvbn1gXG4gICAgICApO1xuICAgICAgdGhpcy5lbWl0KFwiY2xvc2VcIiwgZXZlbnQpO1xuICAgICAgdGhpcy5oYW5kbGVSZWNvbm5lY3Rpb24oKTtcbiAgICB9O1xuXG4gICAgdGhpcy53cy5vbm1lc3NhZ2UgPSAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHBhcnNlZERhdGEgPSB0aGlzLnBhcnNlTWVzc2FnZShldmVudC5kYXRhKTtcbiAgICAgIHRoaXMuZW1pdChcIm1lc3NhZ2VcIiwgcGFyc2VkRGF0YSk7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlUmVjb25uZWN0aW9uKCkge1xuICAgIGlmICh0aGlzLnJlY29ubmVjdEF0dGVtcHRzIDwgdGhpcy5tYXhSZWNvbm5lY3RBdHRlbXB0cykge1xuICAgICAgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cysrO1xuICAgICAgY29uc3QgbWluRGVsYXkgPSAxMDAwO1xuICAgICAgY29uc3QgZGVsYXkgPSBNYXRoLm1heChcbiAgICAgICAgbWluRGVsYXksXG4gICAgICAgIHRoaXMucmVjb25uZWN0SW50ZXJ2YWwgKiBNYXRoLnBvdygyLCB0aGlzLnJlY29ubmVjdEF0dGVtcHRzIC0gMSlcbiAgICAgICk7XG4gICAgICB0aGlzLmxvZ2dlci5pbmZvKFxuICAgICAgICBgQXR0ZW1wdGluZyB0byByZWNvbm5lY3QgKCR7dGhpcy5yZWNvbm5lY3RBdHRlbXB0c30vJHt0aGlzLm1heFJlY29ubmVjdEF0dGVtcHRzfSkgaW4gJHtkZWxheX1tcy4uLmBcbiAgICAgICk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuY29ubmVjdCgpLCBkZWxheSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBcIk1heCByZWNvbm5lY3Rpb24gYXR0ZW1wdHMgcmVhY2hlZC4gUGxlYXNlIHJlY29ubmVjdCBtYW51YWxseS5cIlxuICAgICAgKTtcbiAgICAgIHRoaXMuZW1pdChcIm1heFJlY29ubmVjdEF0dGVtcHRzUmVhY2hlZFwiKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldENvbm5lY3Rpb25UaW1lb3V0KCkge1xuICAgIHRoaXMuY29ubmVjdGlvblRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuc3RhdGUgPT09IFdlYlNvY2tldFN0YXRlLkNPTk5FQ1RJTkcpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXCJDb25uZWN0aW9uIGF0dGVtcHQgdGltZWQgb3V0XCIpO1xuICAgICAgICB0aGlzLndzLmNsb3NlKCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5jb25uZWN0aW9uVGltZW91dCk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFyQ29ubmVjdGlvblRpbWVvdXQoKSB7XG4gICAgaWYgKHRoaXMuY29ubmVjdGlvblRpbWVyKSB7XG4gICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuY29ubmVjdGlvblRpbWVyKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlTWVzc2FnZShkYXRhOiBhbnkpOiBhbnkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlbmQobWVzc2FnZTogc3RyaW5nIHwgb2JqZWN0KSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgPT09IFdlYlNvY2tldFN0YXRlLk9QRU4pIHtcbiAgICAgIGNvbnN0IGRhdGEgPVxuICAgICAgICB0eXBlb2YgbWVzc2FnZSA9PT0gXCJzdHJpbmdcIiA/IG1lc3NhZ2UgOiBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTtcbiAgICAgIHRoaXMud3Muc2VuZChkYXRhKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoXCJXZWJTb2NrZXQgaXMgbm90IG9wZW5cIik7XG4gICAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNsb3NlKCkge1xuICAgIHRoaXMuc3RhdGUgPSBXZWJTb2NrZXRTdGF0ZS5DTE9TSU5HO1xuICAgIHRoaXMud3MuY2xvc2UoKTtcbiAgfVxuXG4gIHB1YmxpYyByZWNvbm5lY3QoKSB7XG4gICAgdGhpcy5sb2dnZXIuZGVidWcoXCJNYW51YWwgcmVjb25uZWN0aW9uIGluaXRpYXRlZC5cIik7XG4gICAgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyA9IDA7XG4gICAgdGhpcy5jbG9zZSgpO1xuICAgIHRoaXMuY29ubmVjdCgpO1xuICB9XG5cbiAgcHVibGljIGdldFN0YXRlKCk6IFdlYlNvY2tldFN0YXRlIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRSZWFkeVN0YXRlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMud3MucmVhZHlTdGF0ZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRBdXRoQ29uZmlnKGF1dGhDb25maWc6IElXZWJTb2NrZXRBdXRoQ29uZmlnKSB7XG4gICAgdGhpcy5hdXRoID0gYXV0aENvbmZpZztcbiAgICB0aGlzLnNldHVwQXV0aFByb3RvY29scygpO1xuICB9XG5cbiAgcHVibGljIGlzQXV0aGVudGljYXRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSA9PT0gV2ViU29ja2V0U3RhdGUuT1BFTjtcbiAgfVxuXG4gIHB1YmxpYyByZWNvbm5lY3RXaXRoTmV3QXV0aChhdXRoQ29uZmlnOiBJV2ViU29ja2V0QXV0aENvbmZpZykge1xuICAgIHRoaXMuc2V0QXV0aENvbmZpZyhhdXRoQ29uZmlnKTtcbiAgICB0aGlzLnJlY29ubmVjdCgpO1xuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKTogdm9pZCB7XG4gICAgLy8gQ2xlYXIgdGhlIGNvbm5lY3Rpb24gdGltZW91dCBpZiBpdCBleGlzdHNcbiAgICB0aGlzLmNsZWFyQ29ubmVjdGlvblRpbWVvdXQoKTtcblxuICAgIC8vIENsb3NlIFdlYlNvY2tldCBjb25uZWN0aW9uIGlmIGl0IGV4aXN0c1xuICAgIGlmICh0aGlzLndzKSB7XG4gICAgICAvLyBSZW1vdmUgYWxsIFdlYlNvY2tldCBldmVudCBsaXN0ZW5lcnNcbiAgICAgIHRoaXMud3Mub25vcGVuID0gbnVsbDtcbiAgICAgIHRoaXMud3Mub25jbG9zZSA9IG51bGw7XG4gICAgICB0aGlzLndzLm9uZXJyb3IgPSBudWxsO1xuICAgICAgdGhpcy53cy5vbm1lc3NhZ2UgPSBudWxsO1xuXG4gICAgICAvLyBDbG9zZSB0aGUgY29ubmVjdGlvbiBpZiBpdCdzIG5vdCBhbHJlYWR5IGNsb3NlZFxuICAgICAgaWYgKHRoaXMuc3RhdGUgIT09IFdlYlNvY2tldFN0YXRlLkNMT1NFRCkge1xuICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMud3MgPSBudWxsITtcbiAgICB9XG5cbiAgICAvLyBDbGVhciBhbGwgZXZlbnQgbGlzdGVuZXJzXG4gICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcblxuICAgIC8vIENsZWFyIHJlZmVyZW5jZXNcbiAgICB0aGlzLmxvZ2dlciA9IG51bGwhO1xuICAgIHRoaXMuYXV0aCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLnByb3RvY29scyA9IFtdO1xuICB9XG59XG4iXX0=