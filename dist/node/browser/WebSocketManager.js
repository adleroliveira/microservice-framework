"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocketManager = exports.AuthMethod = exports.WebSocketState = void 0;
const eventemitter3_1 = __importDefault(require("eventemitter3"));
const BrowserConsoleStrategy_1 = require("./BrowserConsoleStrategy");
var WebSocketState;
(function (WebSocketState) {
    WebSocketState[WebSocketState["CONNECTING"] = 0] = "CONNECTING";
    WebSocketState[WebSocketState["OPEN"] = 1] = "OPEN";
    WebSocketState[WebSocketState["CLOSING"] = 2] = "CLOSING";
    WebSocketState[WebSocketState["CLOSED"] = 3] = "CLOSED";
})(WebSocketState || (exports.WebSocketState = WebSocketState = {}));
var AuthMethod;
(function (AuthMethod) {
    AuthMethod["TOKEN"] = "token";
    AuthMethod["CREDENTIALS"] = "auth";
})(AuthMethod || (exports.AuthMethod = AuthMethod = {}));
class WebSocketManager extends eventemitter3_1.default {
    constructor(config) {
        super();
        this.reconnectAttempts = 0;
        this.state = WebSocketState.CLOSED;
        this.protocols = [];
        this.logger = new BrowserConsoleStrategy_1.BrowserConsoleStrategy();
        this.url = config.url;
        this.secure = config.secure || false;
        this.auth = config.auth;
        this.maxReconnectAttempts = config.maxReconnectAttempts || 5;
        this.reconnectInterval = config.reconnectInterval || 5000;
        this.connectionTimeout = config.connectionTimeout || 10000;
        this.setupAuthProtocols();
        this.connect();
    }
    setupAuthProtocols() {
        if (!this.auth)
            return;
        switch (this.auth.method) {
            case AuthMethod.TOKEN:
                if (this.auth.token) {
                    this.protocols.push(`token.${this.auth.token}`);
                }
                break;
            case AuthMethod.CREDENTIALS:
                if (this.auth.credentials) {
                    const { username, password } = this.auth.credentials;
                    const credentials = btoa(encodeURIComponent(password)).replace(/=/g, "");
                    this.protocols.push(`auth-${username}-${credentials}`);
                    this.logger.debug(`Auth protocol`, this.protocols);
                }
                break;
        }
    }
    connect() {
        this.state = WebSocketState.CONNECTING;
        const secureUrl = this.getSecureUrl(this.url, this.secure);
        // Add token to URL if using query parameter authentication
        const urlWithAuth = this.auth?.method === AuthMethod.TOKEN && this.auth.token
            ? `${secureUrl}?token=${this.auth.token}`
            : secureUrl;
        this.logger.info(`Attempting to connect to ${urlWithAuth}`);
        try {
            this.ws = new WebSocket(urlWithAuth, this.protocols);
            this.setHooks();
            this.setConnectionTimeout();
        }
        catch (error) {
            this.handleConnectionError(error);
        }
    }
    handleConnectionError(error) {
        this.logger.error("Connection error:", error);
        this.emit("error", {
            type: "CONNECTION_ERROR",
            message: "Failed to establish WebSocket connection",
            error,
        });
    }
    getSecureUrl(url, secure) {
        return secure ? url.replace(/^ws:/, "wss:") : url;
    }
    setHooks() {
        this.ws.onopen = () => {
            this.clearConnectionTimeout();
            this.state = WebSocketState.OPEN;
            this.reconnectAttempts = 0;
            this.logger.info(`WebSocket opened. ReadyState: ${this.ws.readyState}`);
            this.emit("open");
        };
        this.ws.onerror = (error) => {
            const wsError = error.target;
            if (wsError.readyState === WebSocket.CLOSED) {
                const errorDetails = {
                    type: "CONNECTION_ERROR",
                    message: "Connection failed",
                    readyState: wsError.readyState,
                    url: wsError.url,
                };
                if (this.reconnectAttempts === 0) {
                    // First connection attempt failed immediately - likely auth failure
                    errorDetails.type = "AUTH_ERROR";
                    errorDetails.message = "Authentication required";
                }
                this.logger.error("WebSocket error:", errorDetails);
                this.emit("error", errorDetails);
            }
            else {
                this.logger.error("WebSocket error:", error);
                this.emit("error", error);
            }
        };
        this.ws.onclose = (event) => {
            this.clearConnectionTimeout();
            this.state = WebSocketState.CLOSED;
            // Handle all potential authentication-related close codes
            if (event.code === 1001 || // Going Away
                event.code === 1006 || // Abnormal Closure (what browsers often use for 401)
                event.code === 1008) {
                // Policy Violation
                const error = {
                    type: "AUTH_ERROR",
                    code: event.code,
                    reason: event.reason || "Authentication required",
                };
                this.emit("error", error);
                return;
            }
            this.logger.info(`WebSocket closed. ReadyState: ${this.ws.readyState}. Code: ${event.code}, Reason: ${event.reason}`);
            this.emit("close", event);
            this.handleReconnection();
        };
        this.ws.onmessage = (event) => {
            const parsedData = this.parseMessage(event.data);
            this.emit("message", parsedData);
        };
    }
    async checkAuthRequirement() {
        try {
            // Make a regular HTTP request to check auth requirements
            const response = await fetch(this.url.replace(/^ws/, "http"));
            if (response.status === 401) {
                const error = {
                    type: "AUTH_ERROR",
                    message: "Authentication required",
                    status: response.status,
                };
                this.emit("error", error);
                return false;
            }
            return true;
        }
        catch (error) {
            // Network error or other issues - proceed with WebSocket connection
            return true;
        }
    }
    handleReconnection() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            const minDelay = 1000;
            const delay = Math.max(minDelay, this.reconnectInterval * Math.pow(2, this.reconnectAttempts - 1));
            this.logger.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${delay}ms...`);
            setTimeout(() => this.connect(), delay);
        }
        else {
            this.logger.error("Max reconnection attempts reached. Please reconnect manually.");
            this.emit("maxReconnectAttemptsReached");
        }
    }
    setConnectionTimeout() {
        this.connectionTimer = window.setTimeout(() => {
            if (this.state === WebSocketState.CONNECTING) {
                this.logger.error("Connection attempt timed out");
                this.ws.close();
            }
        }, this.connectionTimeout);
    }
    clearConnectionTimeout() {
        if (this.connectionTimer) {
            window.clearTimeout(this.connectionTimer);
        }
    }
    parseMessage(data) {
        try {
            return JSON.parse(data);
        }
        catch (error) {
            return data;
        }
    }
    send(message) {
        if (this.state === WebSocketState.OPEN) {
            const data = typeof message === "string" ? message : JSON.stringify(message);
            this.ws.send(data);
        }
        else {
            const error = new Error("WebSocket is not open");
            this.emit("error", error);
        }
    }
    close() {
        this.state = WebSocketState.CLOSING;
        this.ws.close();
    }
    reconnect() {
        this.logger.debug("Manual reconnection initiated.");
        this.reconnectAttempts = 0;
        this.close();
        this.connect();
    }
    getState() {
        return this.state;
    }
    getReadyState() {
        return this.ws.readyState;
    }
    setAuthConfig(authConfig) {
        this.auth = authConfig;
        this.setupAuthProtocols();
    }
    isAuthenticated() {
        return this.state === WebSocketState.OPEN;
    }
    reconnectWithNewAuth(authConfig) {
        this.setAuthConfig(authConfig);
        this.reconnect();
    }
}
exports.WebSocketManager = WebSocketManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0TWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL1dlYlNvY2tldE1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0VBQXlDO0FBQ3pDLHFFQUFrRTtBQUVsRSxJQUFZLGNBS1g7QUFMRCxXQUFZLGNBQWM7SUFDeEIsK0RBQVUsQ0FBQTtJQUNWLG1EQUFJLENBQUE7SUFDSix5REFBTyxDQUFBO0lBQ1AsdURBQU0sQ0FBQTtBQUNSLENBQUMsRUFMVyxjQUFjLDhCQUFkLGNBQWMsUUFLekI7QUFFRCxJQUFZLFVBR1g7QUFIRCxXQUFZLFVBQVU7SUFDcEIsNkJBQWUsQ0FBQTtJQUNmLGtDQUFvQixDQUFBO0FBQ3RCLENBQUMsRUFIVyxVQUFVLDBCQUFWLFVBQVUsUUFHckI7QUFvQkQsTUFBYSxnQkFBaUIsU0FBUSx1QkFBWTtJQWNoRCxZQUFZLE1BQStCO1FBQ3pDLEtBQUssRUFBRSxDQUFDO1FBVEYsc0JBQWlCLEdBQVcsQ0FBQyxDQUFDO1FBRzlCLFVBQUssR0FBbUIsY0FBYyxDQUFDLE1BQU0sQ0FBQztRQUc5QyxjQUFTLEdBQWEsRUFBRSxDQUFDO1FBSS9CLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSwrQ0FBc0IsRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztRQUN0QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixJQUFJLElBQUksQ0FBQztRQUMxRCxJQUFJLENBQUMsaUJBQWlCLEdB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LGVBQWU7UUFDcEIsT0FBTyxJQUFJLENBQUMsS0FBSyxLQUFLLGNBQWMsQ0FBQyxJQUFJLENBQUM7SUFDNUMsQ0FBQztJQUVNLG9CQUFvQixDQUFDLFVBQWdDO1FBQzFELElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQW5RRCw0Q0FtUUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gXCJldmVudGVtaXR0ZXIzXCI7XG5pbXBvcnQgeyBCcm93c2VyQ29uc29sZVN0cmF0ZWd5IH0gZnJvbSBcIi4vQnJvd3NlckNvbnNvbGVTdHJhdGVneVwiO1xuXG5leHBvcnQgZW51bSBXZWJTb2NrZXRTdGF0ZSB7XG4gIENPTk5FQ1RJTkcsXG4gIE9QRU4sXG4gIENMT1NJTkcsXG4gIENMT1NFRCxcbn1cblxuZXhwb3J0IGVudW0gQXV0aE1ldGhvZCB7XG4gIFRPS0VOID0gXCJ0b2tlblwiLFxuICBDUkVERU5USUFMUyA9IFwiYXV0aFwiLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElXZWJTb2NrZXRBdXRoQ29uZmlnIHtcbiAgbWV0aG9kOiBBdXRoTWV0aG9kO1xuICB0b2tlbj86IHN0cmluZztcbiAgY3JlZGVudGlhbHM/OiB7XG4gICAgdXNlcm5hbWU6IHN0cmluZztcbiAgICBwYXNzd29yZDogc3RyaW5nO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElXZWJTb2NrZXRNYW5hZ2VyQ29uZmlnIHtcbiAgdXJsOiBzdHJpbmc7XG4gIHNlY3VyZT86IGJvb2xlYW47XG4gIGF1dGg/OiBJV2ViU29ja2V0QXV0aENvbmZpZztcbiAgbWF4UmVjb25uZWN0QXR0ZW1wdHM/OiBudW1iZXI7XG4gIHJlY29ubmVjdEludGVydmFsPzogbnVtYmVyO1xuICBjb25uZWN0aW9uVGltZW91dD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIFdlYlNvY2tldE1hbmFnZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBwcml2YXRlIGxvZ2dlcjogQnJvd3NlckNvbnNvbGVTdHJhdGVneTtcbiAgcHJpdmF0ZSB3cyE6IFdlYlNvY2tldDtcbiAgcHJpdmF0ZSB1cmw6IHN0cmluZztcbiAgcHJpdmF0ZSBzZWN1cmU6IGJvb2xlYW47XG4gIHByaXZhdGUgYXV0aD86IElXZWJTb2NrZXRBdXRoQ29uZmlnO1xuICBwcml2YXRlIHJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIG1heFJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXI7XG4gIHByaXZhdGUgcmVjb25uZWN0SW50ZXJ2YWw6IG51bWJlcjtcbiAgcHJpdmF0ZSBzdGF0ZTogV2ViU29ja2V0U3RhdGUgPSBXZWJTb2NrZXRTdGF0ZS5DTE9TRUQ7XG4gIHByaXZhdGUgY29ubmVjdGlvblRpbWVvdXQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBjb25uZWN0aW9uVGltZXI/OiBudW1iZXI7XG4gIHByaXZhdGUgcHJvdG9jb2xzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogSVdlYlNvY2tldE1hbmFnZXJDb25maWcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMubG9nZ2VyID0gbmV3IEJyb3dzZXJDb25zb2xlU3RyYXRlZ3koKTtcbiAgICB0aGlzLnVybCA9IGNvbmZpZy51cmw7XG4gICAgdGhpcy5zZWN1cmUgPSBjb25maWcuc2VjdXJlIHx8IGZhbHNlO1xuICAgIHRoaXMuYXV0aCA9IGNvbmZpZy5hdXRoO1xuICAgIHRoaXMubWF4UmVjb25uZWN0QXR0ZW1wdHMgPSBjb25maWcubWF4UmVjb25uZWN0QXR0ZW1wdHMgfHwgNTtcbiAgICB0aGlzLnJlY29ubmVjdEludGVydmFsID0gY29uZmlnLnJlY29ubmVjdEludGVydmFsIHx8IDUwMDA7XG4gICAgdGhpcy5jb25uZWN0aW9uVGltZW91dCA9IGNvbmZpZy5jb25uZWN0aW9uVGltZW91dCB8fCAxMDAwMDtcblxuICAgIHRoaXMuc2V0dXBBdXRoUHJvdG9jb2xzKCk7XG4gICAgdGhpcy5jb25uZWN0KCk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwQXV0aFByb3RvY29scygpIHtcbiAgICBpZiAoIXRoaXMuYXV0aCkgcmV0dXJuO1xuICAgIHN3aXRjaCAodGhpcy5hdXRoLm1ldGhvZCkge1xuICAgICAgY2FzZSBBdXRoTWV0aG9kLlRPS0VOOlxuICAgICAgICBpZiAodGhpcy5hdXRoLnRva2VuKSB7XG4gICAgICAgICAgdGhpcy5wcm90b2NvbHMucHVzaChgdG9rZW4uJHt0aGlzLmF1dGgudG9rZW59YCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEF1dGhNZXRob2QuQ1JFREVOVElBTFM6XG4gICAgICAgIGlmICh0aGlzLmF1dGguY3JlZGVudGlhbHMpIHtcbiAgICAgICAgICBjb25zdCB7IHVzZXJuYW1lLCBwYXNzd29yZCB9ID0gdGhpcy5hdXRoLmNyZWRlbnRpYWxzO1xuICAgICAgICAgIGNvbnN0IGNyZWRlbnRpYWxzID0gYnRvYShlbmNvZGVVUklDb21wb25lbnQocGFzc3dvcmQpKS5yZXBsYWNlKFxuICAgICAgICAgICAgLz0vZyxcbiAgICAgICAgICAgIFwiXCJcbiAgICAgICAgICApO1xuICAgICAgICAgIHRoaXMucHJvdG9jb2xzLnB1c2goYGF1dGgtJHt1c2VybmFtZX0tJHtjcmVkZW50aWFsc31gKTtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgQXV0aCBwcm90b2NvbGAsIHRoaXMucHJvdG9jb2xzKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNvbm5lY3QoKSB7XG4gICAgdGhpcy5zdGF0ZSA9IFdlYlNvY2tldFN0YXRlLkNPTk5FQ1RJTkc7XG5cbiAgICBjb25zdCBzZWN1cmVVcmwgPSB0aGlzLmdldFNlY3VyZVVybCh0aGlzLnVybCwgdGhpcy5zZWN1cmUpO1xuXG4gICAgLy8gQWRkIHRva2VuIHRvIFVSTCBpZiB1c2luZyBxdWVyeSBwYXJhbWV0ZXIgYXV0aGVudGljYXRpb25cbiAgICBjb25zdCB1cmxXaXRoQXV0aCA9XG4gICAgICB0aGlzLmF1dGg/Lm1ldGhvZCA9PT0gQXV0aE1ldGhvZC5UT0tFTiAmJiB0aGlzLmF1dGgudG9rZW5cbiAgICAgICAgPyBgJHtzZWN1cmVVcmx9P3Rva2VuPSR7dGhpcy5hdXRoLnRva2VufWBcbiAgICAgICAgOiBzZWN1cmVVcmw7XG5cbiAgICB0aGlzLmxvZ2dlci5pbmZvKGBBdHRlbXB0aW5nIHRvIGNvbm5lY3QgdG8gJHt1cmxXaXRoQXV0aH1gKTtcbiAgICB0cnkge1xuICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQodXJsV2l0aEF1dGgsIHRoaXMucHJvdG9jb2xzKTtcbiAgICAgIHRoaXMuc2V0SG9va3MoKTtcbiAgICAgIHRoaXMuc2V0Q29ubmVjdGlvblRpbWVvdXQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5oYW5kbGVDb25uZWN0aW9uRXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlQ29ubmVjdGlvbkVycm9yKGVycm9yOiBhbnkpIHtcbiAgICB0aGlzLmxvZ2dlci5lcnJvcihcIkNvbm5lY3Rpb24gZXJyb3I6XCIsIGVycm9yKTtcbiAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCB7XG4gICAgICB0eXBlOiBcIkNPTk5FQ1RJT05fRVJST1JcIixcbiAgICAgIG1lc3NhZ2U6IFwiRmFpbGVkIHRvIGVzdGFibGlzaCBXZWJTb2NrZXQgY29ubmVjdGlvblwiLFxuICAgICAgZXJyb3IsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldFNlY3VyZVVybCh1cmw6IHN0cmluZywgc2VjdXJlOiBib29sZWFuKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc2VjdXJlID8gdXJsLnJlcGxhY2UoL153czovLCBcIndzczpcIikgOiB1cmw7XG4gIH1cblxuICBwcml2YXRlIHNldEhvb2tzKCkge1xuICAgIHRoaXMud3Mub25vcGVuID0gKCkgPT4ge1xuICAgICAgdGhpcy5jbGVhckNvbm5lY3Rpb25UaW1lb3V0KCk7XG4gICAgICB0aGlzLnN0YXRlID0gV2ViU29ja2V0U3RhdGUuT1BFTjtcbiAgICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgICAgdGhpcy5sb2dnZXIuaW5mbyhgV2ViU29ja2V0IG9wZW5lZC4gUmVhZHlTdGF0ZTogJHt0aGlzLndzLnJlYWR5U3RhdGV9YCk7XG4gICAgICB0aGlzLmVtaXQoXCJvcGVuXCIpO1xuICAgIH07XG5cbiAgICB0aGlzLndzLm9uZXJyb3IgPSAoZXJyb3I6IEV2ZW50KSA9PiB7XG4gICAgICBjb25zdCB3c0Vycm9yID0gZXJyb3IudGFyZ2V0IGFzIFdlYlNvY2tldDtcblxuICAgICAgaWYgKHdzRXJyb3IucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNMT1NFRCkge1xuICAgICAgICBjb25zdCBlcnJvckRldGFpbHMgPSB7XG4gICAgICAgICAgdHlwZTogXCJDT05ORUNUSU9OX0VSUk9SXCIsXG4gICAgICAgICAgbWVzc2FnZTogXCJDb25uZWN0aW9uIGZhaWxlZFwiLFxuICAgICAgICAgIHJlYWR5U3RhdGU6IHdzRXJyb3IucmVhZHlTdGF0ZSxcbiAgICAgICAgICB1cmw6IHdzRXJyb3IudXJsLFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aGlzLnJlY29ubmVjdEF0dGVtcHRzID09PSAwKSB7XG4gICAgICAgICAgLy8gRmlyc3QgY29ubmVjdGlvbiBhdHRlbXB0IGZhaWxlZCBpbW1lZGlhdGVseSAtIGxpa2VseSBhdXRoIGZhaWx1cmVcbiAgICAgICAgICBlcnJvckRldGFpbHMudHlwZSA9IFwiQVVUSF9FUlJPUlwiO1xuICAgICAgICAgIGVycm9yRGV0YWlscy5tZXNzYWdlID0gXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXCJXZWJTb2NrZXQgZXJyb3I6XCIsIGVycm9yRGV0YWlscyk7XG4gICAgICAgIHRoaXMuZW1pdChcImVycm9yXCIsIGVycm9yRGV0YWlscyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcIldlYlNvY2tldCBlcnJvcjpcIiwgZXJyb3IpO1xuICAgICAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnJvcik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMud3Mub25jbG9zZSA9IChldmVudCkgPT4ge1xuICAgICAgdGhpcy5jbGVhckNvbm5lY3Rpb25UaW1lb3V0KCk7XG4gICAgICB0aGlzLnN0YXRlID0gV2ViU29ja2V0U3RhdGUuQ0xPU0VEO1xuXG4gICAgICAvLyBIYW5kbGUgYWxsIHBvdGVudGlhbCBhdXRoZW50aWNhdGlvbi1yZWxhdGVkIGNsb3NlIGNvZGVzXG4gICAgICBpZiAoXG4gICAgICAgIGV2ZW50LmNvZGUgPT09IDEwMDEgfHwgLy8gR29pbmcgQXdheVxuICAgICAgICBldmVudC5jb2RlID09PSAxMDA2IHx8IC8vIEFibm9ybWFsIENsb3N1cmUgKHdoYXQgYnJvd3NlcnMgb2Z0ZW4gdXNlIGZvciA0MDEpXG4gICAgICAgIGV2ZW50LmNvZGUgPT09IDEwMDhcbiAgICAgICkge1xuICAgICAgICAvLyBQb2xpY3kgVmlvbGF0aW9uXG4gICAgICAgIGNvbnN0IGVycm9yID0ge1xuICAgICAgICAgIHR5cGU6IFwiQVVUSF9FUlJPUlwiLFxuICAgICAgICAgIGNvZGU6IGV2ZW50LmNvZGUsXG4gICAgICAgICAgcmVhc29uOiBldmVudC5yZWFzb24gfHwgXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnJvcik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2dnZXIuaW5mbyhcbiAgICAgICAgYFdlYlNvY2tldCBjbG9zZWQuIFJlYWR5U3RhdGU6ICR7dGhpcy53cy5yZWFkeVN0YXRlfS4gQ29kZTogJHtldmVudC5jb2RlfSwgUmVhc29uOiAke2V2ZW50LnJlYXNvbn1gXG4gICAgICApO1xuICAgICAgdGhpcy5lbWl0KFwiY2xvc2VcIiwgZXZlbnQpO1xuICAgICAgdGhpcy5oYW5kbGVSZWNvbm5lY3Rpb24oKTtcbiAgICB9O1xuXG4gICAgdGhpcy53cy5vbm1lc3NhZ2UgPSAoZXZlbnQpID0+IHtcbiAgICAgIGNvbnN0IHBhcnNlZERhdGEgPSB0aGlzLnBhcnNlTWVzc2FnZShldmVudC5kYXRhKTtcbiAgICAgIHRoaXMuZW1pdChcIm1lc3NhZ2VcIiwgcGFyc2VkRGF0YSk7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2hlY2tBdXRoUmVxdWlyZW1lbnQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIE1ha2UgYSByZWd1bGFyIEhUVFAgcmVxdWVzdCB0byBjaGVjayBhdXRoIHJlcXVpcmVtZW50c1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh0aGlzLnVybC5yZXBsYWNlKC9ed3MvLCBcImh0dHBcIikpO1xuXG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDEpIHtcbiAgICAgICAgY29uc3QgZXJyb3IgPSB7XG4gICAgICAgICAgdHlwZTogXCJBVVRIX0VSUk9SXCIsXG4gICAgICAgICAgbWVzc2FnZTogXCJBdXRoZW50aWNhdGlvbiByZXF1aXJlZFwiLFxuICAgICAgICAgIHN0YXR1czogcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnJvcik7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBOZXR3b3JrIGVycm9yIG9yIG90aGVyIGlzc3VlcyAtIHByb2NlZWQgd2l0aCBXZWJTb2NrZXQgY29ubmVjdGlvblxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVSZWNvbm5lY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPCB0aGlzLm1heFJlY29ubmVjdEF0dGVtcHRzKSB7XG4gICAgICB0aGlzLnJlY29ubmVjdEF0dGVtcHRzKys7XG4gICAgICBjb25zdCBtaW5EZWxheSA9IDEwMDA7XG4gICAgICBjb25zdCBkZWxheSA9IE1hdGgubWF4KFxuICAgICAgICBtaW5EZWxheSxcbiAgICAgICAgdGhpcy5yZWNvbm5lY3RJbnRlcnZhbCAqIE1hdGgucG93KDIsIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgLSAxKVxuICAgICAgKTtcbiAgICAgIHRoaXMubG9nZ2VyLmluZm8oXG4gICAgICAgIGBBdHRlbXB0aW5nIHRvIHJlY29ubmVjdCAoJHt0aGlzLnJlY29ubmVjdEF0dGVtcHRzfS8ke3RoaXMubWF4UmVjb25uZWN0QXR0ZW1wdHN9KSBpbiAke2RlbGF5fW1zLi4uYFxuICAgICAgKTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5jb25uZWN0KCksIGRlbGF5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgIFwiTWF4IHJlY29ubmVjdGlvbiBhdHRlbXB0cyByZWFjaGVkLiBQbGVhc2UgcmVjb25uZWN0IG1hbnVhbGx5LlwiXG4gICAgICApO1xuICAgICAgdGhpcy5lbWl0KFwibWF4UmVjb25uZWN0QXR0ZW1wdHNSZWFjaGVkXCIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0Q29ubmVjdGlvblRpbWVvdXQoKSB7XG4gICAgdGhpcy5jb25uZWN0aW9uVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gV2ViU29ja2V0U3RhdGUuQ09OTkVDVElORykge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcIkNvbm5lY3Rpb24gYXR0ZW1wdCB0aW1lZCBvdXRcIik7XG4gICAgICAgIHRoaXMud3MuY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9LCB0aGlzLmNvbm5lY3Rpb25UaW1lb3V0KTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYXJDb25uZWN0aW9uVGltZW91dCgpIHtcbiAgICBpZiAodGhpcy5jb25uZWN0aW9uVGltZXIpIHtcbiAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGhpcy5jb25uZWN0aW9uVGltZXIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VNZXNzYWdlKGRhdGE6IGFueSk6IGFueSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VuZChtZXNzYWdlOiBzdHJpbmcgfCBvYmplY3QpIHtcbiAgICBpZiAodGhpcy5zdGF0ZSA9PT0gV2ViU29ja2V0U3RhdGUuT1BFTikge1xuICAgICAgY29uc3QgZGF0YSA9XG4gICAgICAgIHR5cGVvZiBtZXNzYWdlID09PSBcInN0cmluZ1wiID8gbWVzc2FnZSA6IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpO1xuICAgICAgdGhpcy53cy5zZW5kKGRhdGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihcIldlYlNvY2tldCBpcyBub3Qgb3BlblwiKTtcbiAgICAgIHRoaXMuZW1pdChcImVycm9yXCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xvc2UoKSB7XG4gICAgdGhpcy5zdGF0ZSA9IFdlYlNvY2tldFN0YXRlLkNMT1NJTkc7XG4gICAgdGhpcy53cy5jbG9zZSgpO1xuICB9XG5cbiAgcHVibGljIHJlY29ubmVjdCgpIHtcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcIk1hbnVhbCByZWNvbm5lY3Rpb24gaW5pdGlhdGVkLlwiKTtcbiAgICB0aGlzLnJlY29ubmVjdEF0dGVtcHRzID0gMDtcbiAgICB0aGlzLmNsb3NlKCk7XG4gICAgdGhpcy5jb25uZWN0KCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U3RhdGUoKTogV2ViU29ja2V0U3RhdGUge1xuICAgIHJldHVybiB0aGlzLnN0YXRlO1xuICB9XG5cbiAgcHVibGljIGdldFJlYWR5U3RhdGUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy53cy5yZWFkeVN0YXRlO1xuICB9XG5cbiAgcHVibGljIHNldEF1dGhDb25maWcoYXV0aENvbmZpZzogSVdlYlNvY2tldEF1dGhDb25maWcpIHtcbiAgICB0aGlzLmF1dGggPSBhdXRoQ29uZmlnO1xuICAgIHRoaXMuc2V0dXBBdXRoUHJvdG9jb2xzKCk7XG4gIH1cblxuICBwdWJsaWMgaXNBdXRoZW50aWNhdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnN0YXRlID09PSBXZWJTb2NrZXRTdGF0ZS5PUEVOO1xuICB9XG5cbiAgcHVibGljIHJlY29ubmVjdFdpdGhOZXdBdXRoKGF1dGhDb25maWc6IElXZWJTb2NrZXRBdXRoQ29uZmlnKSB7XG4gICAgdGhpcy5zZXRBdXRoQ29uZmlnKGF1dGhDb25maWcpO1xuICAgIHRoaXMucmVjb25uZWN0KCk7XG4gIH1cbn1cbiJdfQ==