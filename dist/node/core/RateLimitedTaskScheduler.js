"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimitedTaskScheduler = void 0;
const events_1 = require("events");
const Loggable_1 = require("../logging/Loggable");
const InMemoryQueueStrategy_1 = require("./InMemoryQueueStrategy");
class RateLimitedTaskScheduler extends Loggable_1.Loggable {
    constructor(concurrencyLimit = 10, tasksPerInterval = 5, interval = 1000, queue = new InMemoryQueueStrategy_1.InMemoryQueueStrategy()) {
        super();
        this.concurrencyLimit = concurrencyLimit;
        this.tasksPerInterval = tasksPerInterval;
        this.interval = interval;
        this.queue = queue;
        this.runningTasks = 0;
        this.tasksInitiatedInWindow = 0;
        this.windowStartTime = Date.now();
        this.emitter = new events_1.EventEmitter();
        this.taskProcessedCount = 0;
        this.windowCheckInterval = null;
        if (interval <= 0)
            throw new Error("Interval must be greater than 0");
        this.instanceId = Math.random().toString(36).slice(2, 11);
        // this.debug(
        //   `Scheduler initialized with concurrencyLimit: ${concurrencyLimit}, tasksPerInterval: ${tasksPerInterval}, interval: ${interval}ms`
        // );
    }
    createDeferredTask(task, input) {
        return { execute: task, input };
    }
    setConcurrencyLimit(limit) {
        this.concurrencyLimit = limit;
        this.resetWindowState();
    }
    setTasksPerInterval(limit) {
        this.tasksPerInterval = limit;
        this.resetWindowState();
    }
    setInterval(interval) {
        this.interval = interval;
        this.resetWindowState();
    }
    scheduleTask(task, input) {
        const deferredTask = this.createDeferredTask(task, input);
        this.processOrEnqueueTask(deferredTask);
        this.restartTimerIfNeeded();
    }
    async scheduleTasks(tasks) {
        for (const { task, input } of tasks) {
            this.scheduleTask(task, input);
        }
    }
    onTaskComplete(callback) {
        this.emitter.on("taskComplete", callback);
    }
    processOrEnqueueTask(deferredTask) {
        this.updateWindowState();
        if (this.canInitiateTask()) {
            this.initiateTask(deferredTask);
        }
        else {
            this.queue.enqueue(deferredTask);
            // this.debug(`Task enqueued. Current queue size: ${this.queue.size()}`);
        }
    }
    updateWindowState() {
        const now = Date.now();
        if (now - this.windowStartTime >= this.interval) {
            this.windowStartTime = now;
            this.tasksInitiatedInWindow = 0;
        }
    }
    canInitiateTask() {
        this.updateWindowState();
        return (this.tasksInitiatedInWindow < this.tasksPerInterval &&
            this.runningTasks < this.concurrencyLimit);
    }
    initiateTask(deferredTask) {
        this.tasksInitiatedInWindow++;
        this.runningTasks++;
        this.processTask(deferredTask);
    }
    async processTask(deferredTask) {
        const startTime = Date.now();
        let result;
        try {
            const executionResult = await deferredTask.execute(deferredTask.input);
            result = {
                success: true,
                result: executionResult,
            };
            this.taskProcessedCount++;
            const endTime = Date.now();
            // this.debug(`Task completed. Execution time: ${endTime - startTime}ms`);
            this.emitter.emit("taskComplete", result);
        }
        catch (error) {
            result = {
                success: false,
                error: error instanceof Loggable_1.LoggableError ? error : new Loggable_1.LoggableError(error),
            };
            this.error("Task execution failed", error);
            this.emitter.emit("taskComplete", result);
        }
        finally {
            this.runningTasks--;
            this.processNextTaskIfAvailable();
            this.stopTimerIfNoTasks();
        }
    }
    processNextTaskIfAvailable() {
        if (this.queue.size() > 0 && this.canInitiateTask()) {
            const nextTask = this.queue.dequeue();
            if (nextTask) {
                this.initiateTask(nextTask);
            }
        }
    }
    checkAndProcessTasks() {
        this.updateWindowState();
        while (this.canInitiateTask() && this.queue.size() > 0) {
            const nextTask = this.queue.dequeue();
            if (nextTask) {
                this.initiateTask(nextTask);
            }
        }
        this.stopTimerIfNoTasks();
    }
    restartTimerIfNeeded() {
        if (this.windowCheckInterval === null &&
            (this.runningTasks > 0 || this.queue.size() > 0)) {
            this.windowCheckInterval = setInterval(() => this.checkAndProcessTasks(), Math.min(this.interval, 1000));
            // this.debug("Timer started");
        }
    }
    stopTimerIfNoTasks() {
        if (this.windowCheckInterval !== null &&
            this.runningTasks === 0 &&
            this.queue.size() === 0) {
            clearInterval(this.windowCheckInterval);
            this.windowCheckInterval = null;
            // this.debug("Timer stopped");
        }
    }
    resetWindowState() {
        this.windowStartTime = Date.now();
        this.tasksInitiatedInWindow = 0;
    }
    destroy() {
        if (this.windowCheckInterval !== null) {
            clearInterval(this.windowCheckInterval);
            this.windowCheckInterval = null;
        }
    }
}
exports.RateLimitedTaskScheduler = RateLimitedTaskScheduler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmF0ZUxpbWl0ZWRUYXNrU2NoZWR1bGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvcmUvUmF0ZUxpbWl0ZWRUYXNrU2NoZWR1bGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFzQztBQUN0QyxrREFBOEQ7QUFFOUQsbUVBQWdFO0FBaUJoRSxNQUFzQix3QkFBb0MsU0FBUSxtQkFBUTtJQVN4RSxZQUNZLG1CQUEyQixFQUFFLEVBQzdCLG1CQUEyQixDQUFDLEVBQzVCLFdBQW1CLElBQUksRUFDdkIsUUFFTixJQUFJLDZDQUFxQixFQUEyQjtRQUV4RCxLQUFLLEVBQUUsQ0FBQztRQVBFLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBYTtRQUM3QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQVk7UUFDNUIsYUFBUSxHQUFSLFFBQVEsQ0FBZTtRQUN2QixVQUFLLEdBQUwsS0FBSyxDQUV5QztRQWRoRCxpQkFBWSxHQUFXLENBQUMsQ0FBQztRQUN6QiwyQkFBc0IsR0FBVyxDQUFDLENBQUM7UUFDckMsb0JBQWUsR0FBVyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDbkMsWUFBTyxHQUFHLElBQUkscUJBQVksRUFBRSxDQUFDO1FBRS9CLHVCQUFrQixHQUFXLENBQUMsQ0FBQztRQUMvQix3QkFBbUIsR0FBMEIsSUFBSSxDQUFDO1FBV3hELElBQUksUUFBUSxJQUFJLENBQUM7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7UUFDdEUsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDMUQsY0FBYztRQUNkLHVJQUF1STtRQUN2SSxLQUFLO0lBQ1AsQ0FBQztJQUVTLGtCQUFrQixDQUMxQixJQUFxQixFQUNyQixLQUFxQjtRQUVyQixPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBRU0sbUJBQW1CLENBQUMsS0FBYTtRQUN0QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSxtQkFBbUIsQ0FBQyxLQUFhO1FBQ3RDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDOUIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVNLFdBQVcsQ0FBQyxRQUFnQjtRQUNqQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsWUFBWSxDQUFDLElBQXFCLEVBQUUsS0FBcUI7UUFDdkQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMxRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhLENBQ2pCLEtBQThEO1FBRTlELEtBQUssTUFBTSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUNwQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqQyxDQUFDO0lBQ0gsQ0FBQztJQUVELGNBQWMsQ0FBQyxRQUE0QztRQUN6RCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVPLG9CQUFvQixDQUFDLFlBQXFDO1FBQ2hFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBRXpCLElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRSxFQUFFLENBQUM7WUFDM0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNsQyxDQUFDO2FBQU0sQ0FBQztZQUNOLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ2pDLHlFQUF5RTtRQUMzRSxDQUFDO0lBQ0gsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxHQUFHLENBQUM7WUFDM0IsSUFBSSxDQUFDLHNCQUFzQixHQUFHLENBQUMsQ0FBQztRQUNsQyxDQUFDO0lBQ0gsQ0FBQztJQUVPLGVBQWU7UUFDckIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDekIsT0FBTyxDQUNMLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCO1lBQ25ELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUMxQyxDQUFDO0lBQ0osQ0FBQztJQUVPLFlBQVksQ0FBQyxZQUFxQztRQUN4RCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRVMsS0FBSyxDQUFDLFdBQVcsQ0FDekIsWUFBcUM7UUFFckMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRTdCLElBQUksTUFBd0IsQ0FBQztRQUM3QixJQUFJLENBQUM7WUFDSCxNQUFNLGVBQWUsR0FBRyxNQUFNLFlBQVksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZFLE1BQU0sR0FBRztnQkFDUCxPQUFPLEVBQUUsSUFBSTtnQkFDYixNQUFNLEVBQUUsZUFBZTthQUN4QixDQUFDO1lBQ0YsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDMUIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzNCLDBFQUEwRTtZQUMxRSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDNUMsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFDcEIsTUFBTSxHQUFHO2dCQUNQLE9BQU8sRUFBRSxLQUFLO2dCQUNkLEtBQUssRUFDSCxLQUFLLFlBQVksd0JBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLHdCQUFhLENBQUMsS0FBSyxDQUFDO2FBQ3BFLENBQUM7WUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLHVCQUF1QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1QyxDQUFDO2dCQUFTLENBQUM7WUFDVCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLDBCQUEwQixFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDNUIsQ0FBQztJQUNILENBQUM7SUFFTywwQkFBMEI7UUFDaEMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQztZQUNwRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3RDLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2IsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDekIsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN2RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3RDLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2IsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QixDQUFDO1FBQ0gsQ0FBQztRQUNELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsSUFDRSxJQUFJLENBQUMsbUJBQW1CLEtBQUssSUFBSTtZQUNqQyxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQ2hELENBQUM7WUFDRCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsV0FBVyxDQUNwQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsRUFDakMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUM5QixDQUFDO1lBQ0YsK0JBQStCO1FBQ2pDLENBQUM7SUFDSCxDQUFDO0lBRU8sa0JBQWtCO1FBQ3hCLElBQ0UsSUFBSSxDQUFDLG1CQUFtQixLQUFLLElBQUk7WUFDakMsSUFBSSxDQUFDLFlBQVksS0FBSyxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUN2QixDQUFDO1lBQ0QsYUFBYSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3hDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7WUFDaEMsK0JBQStCO1FBQ2pDLENBQUM7SUFDSCxDQUFDO0lBRU8sZ0JBQWdCO1FBQ3RCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVNLE9BQU87UUFDWixJQUFJLElBQUksQ0FBQyxtQkFBbUIsS0FBSyxJQUFJLEVBQUUsQ0FBQztZQUN0QyxhQUFhLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDeEMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQztRQUNsQyxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBekxELDREQXlMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcbmltcG9ydCB7IExvZ2dhYmxlLCBMb2dnYWJsZUVycm9yIH0gZnJvbSBcIi4uL2xvZ2dpbmcvTG9nZ2FibGVcIjtcbmltcG9ydCB7IElRdWV1ZVN0cmF0ZWd5IH0gZnJvbSBcIi4uL2ludGVyZmFjZXNcIjtcbmltcG9ydCB7IEluTWVtb3J5UXVldWVTdHJhdGVneSB9IGZyb20gXCIuL0luTWVtb3J5UXVldWVTdHJhdGVneVwiO1xuXG50eXBlIFRhc2tJbnB1dDxUSW4+ID0gVEluO1xuXG5leHBvcnQgdHlwZSBUYXNrT3V0cHV0PFRPdXQ+ID0ge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICByZXN1bHQ/OiBUT3V0O1xuICBlcnJvcj86IExvZ2dhYmxlRXJyb3I7XG59O1xuXG50eXBlIFRhc2s8VEluLCBUT3V0PiA9IChpbnB1dDogVGFza0lucHV0PFRJbj4pID0+IFByb21pc2U8VE91dD47XG5cbmV4cG9ydCB0eXBlIERlZmVycmVkVGFzazxUSW4sIFRPdXQ+ID0ge1xuICBleGVjdXRlOiBUYXNrPFRJbiwgVE91dD47XG4gIGlucHV0OiBUYXNrSW5wdXQ8VEluPjtcbn07XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSYXRlTGltaXRlZFRhc2tTY2hlZHVsZXI8VEluLCBUT3V0PiBleHRlbmRzIExvZ2dhYmxlIHtcbiAgcHJvdGVjdGVkIHJ1bm5pbmdUYXNrczogbnVtYmVyID0gMDtcbiAgcHJvdGVjdGVkIHRhc2tzSW5pdGlhdGVkSW5XaW5kb3c6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgd2luZG93U3RhcnRUaW1lOiBudW1iZXIgPSBEYXRlLm5vdygpO1xuICBwcm90ZWN0ZWQgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IGluc3RhbmNlSWQ6IHN0cmluZztcbiAgcHJpdmF0ZSB0YXNrUHJvY2Vzc2VkQ291bnQ6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgd2luZG93Q2hlY2tJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgY29uY3VycmVuY3lMaW1pdDogbnVtYmVyID0gMTAsXG4gICAgcHJvdGVjdGVkIHRhc2tzUGVySW50ZXJ2YWw6IG51bWJlciA9IDUsXG4gICAgcHJvdGVjdGVkIGludGVydmFsOiBudW1iZXIgPSAxMDAwLFxuICAgIHByb3RlY3RlZCBxdWV1ZTogSVF1ZXVlU3RyYXRlZ3k8XG4gICAgICBEZWZlcnJlZFRhc2s8VEluLCBUT3V0PlxuICAgID4gPSBuZXcgSW5NZW1vcnlRdWV1ZVN0cmF0ZWd5PERlZmVycmVkVGFzazxUSW4sIFRPdXQ+PigpXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKGludGVydmFsIDw9IDApIHRocm93IG5ldyBFcnJvcihcIkludGVydmFsIG11c3QgYmUgZ3JlYXRlciB0aGFuIDBcIik7XG4gICAgdGhpcy5pbnN0YW5jZUlkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMiwgMTEpO1xuICAgIC8vIHRoaXMuZGVidWcoXG4gICAgLy8gICBgU2NoZWR1bGVyIGluaXRpYWxpemVkIHdpdGggY29uY3VycmVuY3lMaW1pdDogJHtjb25jdXJyZW5jeUxpbWl0fSwgdGFza3NQZXJJbnRlcnZhbDogJHt0YXNrc1BlckludGVydmFsfSwgaW50ZXJ2YWw6ICR7aW50ZXJ2YWx9bXNgXG4gICAgLy8gKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVEZWZlcnJlZFRhc2soXG4gICAgdGFzazogVGFzazxUSW4sIFRPdXQ+LFxuICAgIGlucHV0OiBUYXNrSW5wdXQ8VEluPlxuICApOiBEZWZlcnJlZFRhc2s8VEluLCBUT3V0PiB7XG4gICAgcmV0dXJuIHsgZXhlY3V0ZTogdGFzaywgaW5wdXQgfTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRDb25jdXJyZW5jeUxpbWl0KGxpbWl0OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmNvbmN1cnJlbmN5TGltaXQgPSBsaW1pdDtcbiAgICB0aGlzLnJlc2V0V2luZG93U3RhdGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRUYXNrc1BlckludGVydmFsKGxpbWl0OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLnRhc2tzUGVySW50ZXJ2YWwgPSBsaW1pdDtcbiAgICB0aGlzLnJlc2V0V2luZG93U3RhdGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRJbnRlcnZhbChpbnRlcnZhbDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5pbnRlcnZhbCA9IGludGVydmFsO1xuICAgIHRoaXMucmVzZXRXaW5kb3dTdGF0ZSgpO1xuICB9XG5cbiAgc2NoZWR1bGVUYXNrKHRhc2s6IFRhc2s8VEluLCBUT3V0PiwgaW5wdXQ6IFRhc2tJbnB1dDxUSW4+KTogdm9pZCB7XG4gICAgY29uc3QgZGVmZXJyZWRUYXNrID0gdGhpcy5jcmVhdGVEZWZlcnJlZFRhc2sodGFzaywgaW5wdXQpO1xuICAgIHRoaXMucHJvY2Vzc09yRW5xdWV1ZVRhc2soZGVmZXJyZWRUYXNrKTtcbiAgICB0aGlzLnJlc3RhcnRUaW1lcklmTmVlZGVkKCk7XG4gIH1cblxuICBhc3luYyBzY2hlZHVsZVRhc2tzKFxuICAgIHRhc2tzOiBBcnJheTx7IHRhc2s6IFRhc2s8VEluLCBUT3V0PjsgaW5wdXQ6IFRhc2tJbnB1dDxUSW4+IH0+XG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGZvciAoY29uc3QgeyB0YXNrLCBpbnB1dCB9IG9mIHRhc2tzKSB7XG4gICAgICB0aGlzLnNjaGVkdWxlVGFzayh0YXNrLCBpbnB1dCk7XG4gICAgfVxuICB9XG5cbiAgb25UYXNrQ29tcGxldGUoY2FsbGJhY2s6IChyZXN1bHQ6IFRhc2tPdXRwdXQ8VE91dD4pID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLmVtaXR0ZXIub24oXCJ0YXNrQ29tcGxldGVcIiwgY2FsbGJhY2spO1xuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzT3JFbnF1ZXVlVGFzayhkZWZlcnJlZFRhc2s6IERlZmVycmVkVGFzazxUSW4sIFRPdXQ+KTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGVXaW5kb3dTdGF0ZSgpO1xuXG4gICAgaWYgKHRoaXMuY2FuSW5pdGlhdGVUYXNrKCkpIHtcbiAgICAgIHRoaXMuaW5pdGlhdGVUYXNrKGRlZmVycmVkVGFzayk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucXVldWUuZW5xdWV1ZShkZWZlcnJlZFRhc2spO1xuICAgICAgLy8gdGhpcy5kZWJ1ZyhgVGFzayBlbnF1ZXVlZC4gQ3VycmVudCBxdWV1ZSBzaXplOiAke3RoaXMucXVldWUuc2l6ZSgpfWApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlV2luZG93U3RhdGUoKTogdm9pZCB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBpZiAobm93IC0gdGhpcy53aW5kb3dTdGFydFRpbWUgPj0gdGhpcy5pbnRlcnZhbCkge1xuICAgICAgdGhpcy53aW5kb3dTdGFydFRpbWUgPSBub3c7XG4gICAgICB0aGlzLnRhc2tzSW5pdGlhdGVkSW5XaW5kb3cgPSAwO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2FuSW5pdGlhdGVUYXNrKCk6IGJvb2xlYW4ge1xuICAgIHRoaXMudXBkYXRlV2luZG93U3RhdGUoKTtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy50YXNrc0luaXRpYXRlZEluV2luZG93IDwgdGhpcy50YXNrc1BlckludGVydmFsICYmXG4gICAgICB0aGlzLnJ1bm5pbmdUYXNrcyA8IHRoaXMuY29uY3VycmVuY3lMaW1pdFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGluaXRpYXRlVGFzayhkZWZlcnJlZFRhc2s6IERlZmVycmVkVGFzazxUSW4sIFRPdXQ+KTogdm9pZCB7XG4gICAgdGhpcy50YXNrc0luaXRpYXRlZEluV2luZG93Kys7XG4gICAgdGhpcy5ydW5uaW5nVGFza3MrKztcbiAgICB0aGlzLnByb2Nlc3NUYXNrKGRlZmVycmVkVGFzayk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgcHJvY2Vzc1Rhc2soXG4gICAgZGVmZXJyZWRUYXNrOiBEZWZlcnJlZFRhc2s8VEluLCBUT3V0PlxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgbGV0IHJlc3VsdDogVGFza091dHB1dDxUT3V0PjtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZXhlY3V0aW9uUmVzdWx0ID0gYXdhaXQgZGVmZXJyZWRUYXNrLmV4ZWN1dGUoZGVmZXJyZWRUYXNrLmlucHV0KTtcbiAgICAgIHJlc3VsdCA9IHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgcmVzdWx0OiBleGVjdXRpb25SZXN1bHQsXG4gICAgICB9O1xuICAgICAgdGhpcy50YXNrUHJvY2Vzc2VkQ291bnQrKztcbiAgICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgLy8gdGhpcy5kZWJ1ZyhgVGFzayBjb21wbGV0ZWQuIEV4ZWN1dGlvbiB0aW1lOiAke2VuZFRpbWUgLSBzdGFydFRpbWV9bXNgKTtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KFwidGFza0NvbXBsZXRlXCIsIHJlc3VsdCk7XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgcmVzdWx0ID0ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6XG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBMb2dnYWJsZUVycm9yID8gZXJyb3IgOiBuZXcgTG9nZ2FibGVFcnJvcihlcnJvciksXG4gICAgICB9O1xuICAgICAgdGhpcy5lcnJvcihcIlRhc2sgZXhlY3V0aW9uIGZhaWxlZFwiLCBlcnJvcik7XG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdChcInRhc2tDb21wbGV0ZVwiLCByZXN1bHQpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLnJ1bm5pbmdUYXNrcy0tO1xuICAgICAgdGhpcy5wcm9jZXNzTmV4dFRhc2tJZkF2YWlsYWJsZSgpO1xuICAgICAgdGhpcy5zdG9wVGltZXJJZk5vVGFza3MoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NOZXh0VGFza0lmQXZhaWxhYmxlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnF1ZXVlLnNpemUoKSA+IDAgJiYgdGhpcy5jYW5Jbml0aWF0ZVRhc2soKSkge1xuICAgICAgY29uc3QgbmV4dFRhc2sgPSB0aGlzLnF1ZXVlLmRlcXVldWUoKTtcbiAgICAgIGlmIChuZXh0VGFzaykge1xuICAgICAgICB0aGlzLmluaXRpYXRlVGFzayhuZXh0VGFzayk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0FuZFByb2Nlc3NUYXNrcygpOiB2b2lkIHtcbiAgICB0aGlzLnVwZGF0ZVdpbmRvd1N0YXRlKCk7XG4gICAgd2hpbGUgKHRoaXMuY2FuSW5pdGlhdGVUYXNrKCkgJiYgdGhpcy5xdWV1ZS5zaXplKCkgPiAwKSB7XG4gICAgICBjb25zdCBuZXh0VGFzayA9IHRoaXMucXVldWUuZGVxdWV1ZSgpO1xuICAgICAgaWYgKG5leHRUYXNrKSB7XG4gICAgICAgIHRoaXMuaW5pdGlhdGVUYXNrKG5leHRUYXNrKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zdG9wVGltZXJJZk5vVGFza3MoKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzdGFydFRpbWVySWZOZWVkZWQoKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgdGhpcy53aW5kb3dDaGVja0ludGVydmFsID09PSBudWxsICYmXG4gICAgICAodGhpcy5ydW5uaW5nVGFza3MgPiAwIHx8IHRoaXMucXVldWUuc2l6ZSgpID4gMClcbiAgICApIHtcbiAgICAgIHRoaXMud2luZG93Q2hlY2tJbnRlcnZhbCA9IHNldEludGVydmFsKFxuICAgICAgICAoKSA9PiB0aGlzLmNoZWNrQW5kUHJvY2Vzc1Rhc2tzKCksXG4gICAgICAgIE1hdGgubWluKHRoaXMuaW50ZXJ2YWwsIDEwMDApXG4gICAgICApO1xuICAgICAgLy8gdGhpcy5kZWJ1ZyhcIlRpbWVyIHN0YXJ0ZWRcIik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdG9wVGltZXJJZk5vVGFza3MoKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgdGhpcy53aW5kb3dDaGVja0ludGVydmFsICE9PSBudWxsICYmXG4gICAgICB0aGlzLnJ1bm5pbmdUYXNrcyA9PT0gMCAmJlxuICAgICAgdGhpcy5xdWV1ZS5zaXplKCkgPT09IDBcbiAgICApIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy53aW5kb3dDaGVja0ludGVydmFsKTtcbiAgICAgIHRoaXMud2luZG93Q2hlY2tJbnRlcnZhbCA9IG51bGw7XG4gICAgICAvLyB0aGlzLmRlYnVnKFwiVGltZXIgc3RvcHBlZFwiKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlc2V0V2luZG93U3RhdGUoKTogdm9pZCB7XG4gICAgdGhpcy53aW5kb3dTdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIHRoaXMudGFza3NJbml0aWF0ZWRJbldpbmRvdyA9IDA7XG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy53aW5kb3dDaGVja0ludGVydmFsICE9PSBudWxsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMud2luZG93Q2hlY2tJbnRlcnZhbCk7XG4gICAgICB0aGlzLndpbmRvd0NoZWNrSW50ZXJ2YWwgPSBudWxsO1xuICAgIH1cbiAgfVxufVxuIl19