"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimitedTaskScheduler = void 0;
const events_1 = require("events");
const Loggable_1 = require("../logging/Loggable");
const InMemoryQueueStrategy_1 = require("./InMemoryQueueStrategy");
class RateLimitedTaskScheduler extends Loggable_1.Loggable {
    constructor(concurrencyLimit = 10, tasksPerInterval = 5, interval = 1000, queue = new InMemoryQueueStrategy_1.InMemoryQueueStrategy()) {
        super();
        this.concurrencyLimit = concurrencyLimit;
        this.tasksPerInterval = tasksPerInterval;
        this.interval = interval;
        this.queue = queue;
        this.runningTasks = 0;
        this.tasksInitiatedInWindow = 0;
        this.windowStartTime = Date.now();
        this.emitter = new events_1.EventEmitter();
        this.taskProcessedCount = 0;
        this.windowCheckInterval = null;
        if (interval <= 0)
            throw new Error("Interval must be greater than 0");
        this.instanceId = Math.random().toString(36).slice(2, 11);
        this.debug(`Scheduler initialized with concurrencyLimit: ${concurrencyLimit}, tasksPerInterval: ${tasksPerInterval}, interval: ${interval}ms`);
    }
    createDeferredTask(task, input) {
        return { execute: task, input };
    }
    setConcurrencyLimit(limit) {
        this.concurrencyLimit = limit;
        this.resetWindowState();
    }
    setTasksPerInterval(limit) {
        this.tasksPerInterval = limit;
        this.resetWindowState();
    }
    setInterval(interval) {
        this.interval = interval;
        this.resetWindowState();
    }
    scheduleTask(task, input) {
        const deferredTask = this.createDeferredTask(task, input);
        this.processOrEnqueueTask(deferredTask);
        this.restartTimerIfNeeded();
    }
    async scheduleTasks(tasks) {
        for (const { task, input } of tasks) {
            this.scheduleTask(task, input);
        }
    }
    onTaskComplete(callback) {
        this.emitter.on("taskComplete", callback);
    }
    processOrEnqueueTask(deferredTask) {
        this.updateWindowState();
        if (this.canInitiateTask()) {
            this.initiateTask(deferredTask);
        }
        else {
            this.queue.enqueue(deferredTask);
            this.debug(`Task enqueued. Current queue size: ${this.queue.size()}`);
        }
    }
    updateWindowState() {
        const now = Date.now();
        if (now - this.windowStartTime >= this.interval) {
            this.windowStartTime = now;
            this.tasksInitiatedInWindow = 0;
        }
    }
    canInitiateTask() {
        this.updateWindowState();
        return (this.tasksInitiatedInWindow < this.tasksPerInterval &&
            this.runningTasks < this.concurrencyLimit);
    }
    initiateTask(deferredTask) {
        this.tasksInitiatedInWindow++;
        this.runningTasks++;
        this.processTask(deferredTask);
    }
    async processTask(deferredTask) {
        const startTime = Date.now();
        let result;
        try {
            const executionResult = await deferredTask.execute(deferredTask.input);
            result = {
                success: true,
                result: executionResult,
            };
            this.taskProcessedCount++;
            const endTime = Date.now();
            this.debug(`Task completed. Execution time: ${endTime - startTime}ms`);
            this.emitter.emit("taskComplete", result);
        }
        catch (error) {
            result = {
                success: false,
                error: error instanceof Loggable_1.LoggableError ? error : new Loggable_1.LoggableError(error),
            };
            this.error("Task execution failed", error);
            this.emitter.emit("taskComplete", result);
        }
        finally {
            this.runningTasks--;
            this.processNextTaskIfAvailable();
            this.stopTimerIfNoTasks();
        }
    }
    processNextTaskIfAvailable() {
        if (this.queue.size() > 0 && this.canInitiateTask()) {
            const nextTask = this.queue.dequeue();
            if (nextTask) {
                this.initiateTask(nextTask);
            }
        }
    }
    checkAndProcessTasks() {
        this.updateWindowState();
        while (this.canInitiateTask() && this.queue.size() > 0) {
            const nextTask = this.queue.dequeue();
            if (nextTask) {
                this.initiateTask(nextTask);
            }
        }
        this.stopTimerIfNoTasks();
    }
    restartTimerIfNeeded() {
        if (this.windowCheckInterval === null &&
            (this.runningTasks > 0 || this.queue.size() > 0)) {
            this.windowCheckInterval = setInterval(() => this.checkAndProcessTasks(), Math.min(this.interval, 1000));
            this.debug("Timer started");
        }
    }
    stopTimerIfNoTasks() {
        if (this.windowCheckInterval !== null &&
            this.runningTasks === 0 &&
            this.queue.size() === 0) {
            clearInterval(this.windowCheckInterval);
            this.windowCheckInterval = null;
            this.debug("Timer stopped");
        }
    }
    resetWindowState() {
        this.windowStartTime = Date.now();
        this.tasksInitiatedInWindow = 0;
    }
    destroy() {
        if (this.windowCheckInterval !== null) {
            clearInterval(this.windowCheckInterval);
            this.windowCheckInterval = null;
        }
    }
}
exports.RateLimitedTaskScheduler = RateLimitedTaskScheduler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmF0ZUxpbWl0ZWRUYXNrU2NoZWR1bGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvcmUvUmF0ZUxpbWl0ZWRUYXNrU2NoZWR1bGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFzQztBQUN0QyxrREFBOEQ7QUFFOUQsbUVBQWdFO0FBaUJoRSxNQUFzQix3QkFBb0MsU0FBUSxtQkFBUTtJQVN4RSxZQUNZLG1CQUEyQixFQUFFLEVBQzdCLG1CQUEyQixDQUFDLEVBQzVCLFdBQW1CLElBQUksRUFDdkIsUUFFTixJQUFJLDZDQUFxQixFQUEyQjtRQUV4RCxLQUFLLEVBQUUsQ0FBQztRQVBFLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBYTtRQUM3QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQVk7UUFDNUIsYUFBUSxHQUFSLFFBQVEsQ0FBZTtRQUN2QixVQUFLLEdBQUwsS0FBSyxDQUV5QztRQWRoRCxpQkFBWSxHQUFXLENBQUMsQ0FBQztRQUN6QiwyQkFBc0IsR0FBVyxDQUFDLENBQUM7UUFDckMsb0JBQWUsR0FBVyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDbkMsWUFBTyxHQUFHLElBQUkscUJBQVksRUFBRSxDQUFDO1FBRS9CLHVCQUFrQixHQUFXLENBQUMsQ0FBQztRQUMvQix3QkFBbUIsR0FBMEIsSUFBSSxDQUFDO1FBV3hELElBQUksUUFBUSxJQUFJLENBQUM7WUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7UUFDdEUsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLEtBQUssQ0FDUixnREFBZ0QsZ0JBQWdCLHVCQUF1QixnQkFBZ0IsZUFBZSxRQUFRLElBQUksQ0FDbkksQ0FBQztJQUNKLENBQUM7SUFFUyxrQkFBa0IsQ0FDMUIsSUFBcUIsRUFDckIsS0FBcUI7UUFFckIsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVNLG1CQUFtQixDQUFDLEtBQWE7UUFDdEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztRQUM5QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRU0sbUJBQW1CLENBQUMsS0FBYTtRQUN0QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSxXQUFXLENBQUMsUUFBZ0I7UUFDakMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVELFlBQVksQ0FBQyxJQUFxQixFQUFFLEtBQXFCO1FBQ3ZELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYSxDQUNqQixLQUE4RDtRQUU5RCxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksS0FBSyxFQUFFLENBQUM7WUFDcEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakMsQ0FBQztJQUNILENBQUM7SUFFRCxjQUFjLENBQUMsUUFBNEM7UUFDekQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsY0FBYyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFTyxvQkFBb0IsQ0FBQyxZQUFxQztRQUNoRSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUV6QixJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbEMsQ0FBQzthQUFNLENBQUM7WUFDTixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN4RSxDQUFDO0lBQ0gsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxHQUFHLENBQUM7WUFDM0IsSUFBSSxDQUFDLHNCQUFzQixHQUFHLENBQUMsQ0FBQztRQUNsQyxDQUFDO0lBQ0gsQ0FBQztJQUVPLGVBQWU7UUFDckIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDekIsT0FBTyxDQUNMLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCO1lBQ25ELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUMxQyxDQUFDO0lBQ0osQ0FBQztJQUVPLFlBQVksQ0FBQyxZQUFxQztRQUN4RCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRVMsS0FBSyxDQUFDLFdBQVcsQ0FDekIsWUFBcUM7UUFFckMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRTdCLElBQUksTUFBd0IsQ0FBQztRQUM3QixJQUFJLENBQUM7WUFDSCxNQUFNLGVBQWUsR0FBRyxNQUFNLFlBQVksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZFLE1BQU0sR0FBRztnQkFDUCxPQUFPLEVBQUUsSUFBSTtnQkFDYixNQUFNLEVBQUUsZUFBZTthQUN4QixDQUFDO1lBQ0YsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDMUIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxLQUFLLENBQUMsbUNBQW1DLE9BQU8sR0FBRyxTQUFTLElBQUksQ0FBQyxDQUFDO1lBQ3ZFLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1QyxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixNQUFNLEdBQUc7Z0JBQ1AsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsS0FBSyxFQUNILEtBQUssWUFBWSx3QkFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksd0JBQWEsQ0FBQyxLQUFLLENBQUM7YUFDcEUsQ0FBQztZQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDM0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVDLENBQUM7Z0JBQVMsQ0FBQztZQUNULElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztZQUNsQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUM1QixDQUFDO0lBQ0gsQ0FBQztJQUVPLDBCQUEwQjtRQUNoQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsRUFBRSxDQUFDO1lBQ3BELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDdEMsSUFBSSxRQUFRLEVBQUUsQ0FBQztnQkFDYixJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzlCLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVPLG9CQUFvQjtRQUMxQixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUN6QixPQUFPLElBQUksQ0FBQyxlQUFlLEVBQUUsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3ZELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDdEMsSUFBSSxRQUFRLEVBQUUsQ0FBQztnQkFDYixJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzlCLENBQUM7UUFDSCxDQUFDO1FBQ0QsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVPLG9CQUFvQjtRQUMxQixJQUNFLElBQUksQ0FBQyxtQkFBbUIsS0FBSyxJQUFJO1lBQ2pDLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsRUFDaEQsQ0FBQztZQUNELElBQUksQ0FBQyxtQkFBbUIsR0FBRyxXQUFXLENBQ3BDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxFQUNqQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQzlCLENBQUM7WUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzlCLENBQUM7SUFDSCxDQUFDO0lBRU8sa0JBQWtCO1FBQ3hCLElBQ0UsSUFBSSxDQUFDLG1CQUFtQixLQUFLLElBQUk7WUFDakMsSUFBSSxDQUFDLFlBQVksS0FBSyxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUN2QixDQUFDO1lBQ0QsYUFBYSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3hDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7WUFDaEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0gsQ0FBQztJQUVPLGdCQUFnQjtRQUN0QixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTSxPQUFPO1FBQ1osSUFBSSxJQUFJLENBQUMsbUJBQW1CLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDdEMsYUFBYSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3hDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7UUFDbEMsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXpMRCw0REF5TEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgeyBMb2dnYWJsZSwgTG9nZ2FibGVFcnJvciB9IGZyb20gXCIuLi9sb2dnaW5nL0xvZ2dhYmxlXCI7XG5pbXBvcnQgeyBJUXVldWVTdHJhdGVneSB9IGZyb20gXCIuLi9pbnRlcmZhY2VzXCI7XG5pbXBvcnQgeyBJbk1lbW9yeVF1ZXVlU3RyYXRlZ3kgfSBmcm9tIFwiLi9Jbk1lbW9yeVF1ZXVlU3RyYXRlZ3lcIjtcblxudHlwZSBUYXNrSW5wdXQ8VEluPiA9IFRJbjtcblxuZXhwb3J0IHR5cGUgVGFza091dHB1dDxUT3V0PiA9IHtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgcmVzdWx0PzogVE91dDtcbiAgZXJyb3I/OiBMb2dnYWJsZUVycm9yO1xufTtcblxudHlwZSBUYXNrPFRJbiwgVE91dD4gPSAoaW5wdXQ6IFRhc2tJbnB1dDxUSW4+KSA9PiBQcm9taXNlPFRPdXQ+O1xuXG5leHBvcnQgdHlwZSBEZWZlcnJlZFRhc2s8VEluLCBUT3V0PiA9IHtcbiAgZXhlY3V0ZTogVGFzazxUSW4sIFRPdXQ+O1xuICBpbnB1dDogVGFza0lucHV0PFRJbj47XG59O1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUmF0ZUxpbWl0ZWRUYXNrU2NoZWR1bGVyPFRJbiwgVE91dD4gZXh0ZW5kcyBMb2dnYWJsZSB7XG4gIHByb3RlY3RlZCBydW5uaW5nVGFza3M6IG51bWJlciA9IDA7XG4gIHByb3RlY3RlZCB0YXNrc0luaXRpYXRlZEluV2luZG93OiBudW1iZXIgPSAwO1xuICBwcml2YXRlIHdpbmRvd1N0YXJ0VGltZTogbnVtYmVyID0gRGF0ZS5ub3coKTtcbiAgcHJvdGVjdGVkIGVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIHByb3RlY3RlZCByZWFkb25seSBpbnN0YW5jZUlkOiBzdHJpbmc7XG4gIHByaXZhdGUgdGFza1Byb2Nlc3NlZENvdW50OiBudW1iZXIgPSAwO1xuICBwcml2YXRlIHdpbmRvd0NoZWNrSW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGNvbmN1cnJlbmN5TGltaXQ6IG51bWJlciA9IDEwLFxuICAgIHByb3RlY3RlZCB0YXNrc1BlckludGVydmFsOiBudW1iZXIgPSA1LFxuICAgIHByb3RlY3RlZCBpbnRlcnZhbDogbnVtYmVyID0gMTAwMCxcbiAgICBwcm90ZWN0ZWQgcXVldWU6IElRdWV1ZVN0cmF0ZWd5PFxuICAgICAgRGVmZXJyZWRUYXNrPFRJbiwgVE91dD5cbiAgICA+ID0gbmV3IEluTWVtb3J5UXVldWVTdHJhdGVneTxEZWZlcnJlZFRhc2s8VEluLCBUT3V0Pj4oKVxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIGlmIChpbnRlcnZhbCA8PSAwKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnRlcnZhbCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwXCIpO1xuICAgIHRoaXMuaW5zdGFuY2VJZCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIsIDExKTtcbiAgICB0aGlzLmRlYnVnKFxuICAgICAgYFNjaGVkdWxlciBpbml0aWFsaXplZCB3aXRoIGNvbmN1cnJlbmN5TGltaXQ6ICR7Y29uY3VycmVuY3lMaW1pdH0sIHRhc2tzUGVySW50ZXJ2YWw6ICR7dGFza3NQZXJJbnRlcnZhbH0sIGludGVydmFsOiAke2ludGVydmFsfW1zYFxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgY3JlYXRlRGVmZXJyZWRUYXNrKFxuICAgIHRhc2s6IFRhc2s8VEluLCBUT3V0PixcbiAgICBpbnB1dDogVGFza0lucHV0PFRJbj5cbiAgKTogRGVmZXJyZWRUYXNrPFRJbiwgVE91dD4ge1xuICAgIHJldHVybiB7IGV4ZWN1dGU6IHRhc2ssIGlucHV0IH07XG4gIH1cblxuICBwdWJsaWMgc2V0Q29uY3VycmVuY3lMaW1pdChsaW1pdDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5jb25jdXJyZW5jeUxpbWl0ID0gbGltaXQ7XG4gICAgdGhpcy5yZXNldFdpbmRvd1N0YXRlKCk7XG4gIH1cblxuICBwdWJsaWMgc2V0VGFza3NQZXJJbnRlcnZhbChsaW1pdDogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy50YXNrc1BlckludGVydmFsID0gbGltaXQ7XG4gICAgdGhpcy5yZXNldFdpbmRvd1N0YXRlKCk7XG4gIH1cblxuICBwdWJsaWMgc2V0SW50ZXJ2YWwoaW50ZXJ2YWw6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuaW50ZXJ2YWwgPSBpbnRlcnZhbDtcbiAgICB0aGlzLnJlc2V0V2luZG93U3RhdGUoKTtcbiAgfVxuXG4gIHNjaGVkdWxlVGFzayh0YXNrOiBUYXNrPFRJbiwgVE91dD4sIGlucHV0OiBUYXNrSW5wdXQ8VEluPik6IHZvaWQge1xuICAgIGNvbnN0IGRlZmVycmVkVGFzayA9IHRoaXMuY3JlYXRlRGVmZXJyZWRUYXNrKHRhc2ssIGlucHV0KTtcbiAgICB0aGlzLnByb2Nlc3NPckVucXVldWVUYXNrKGRlZmVycmVkVGFzayk7XG4gICAgdGhpcy5yZXN0YXJ0VGltZXJJZk5lZWRlZCgpO1xuICB9XG5cbiAgYXN5bmMgc2NoZWR1bGVUYXNrcyhcbiAgICB0YXNrczogQXJyYXk8eyB0YXNrOiBUYXNrPFRJbiwgVE91dD47IGlucHV0OiBUYXNrSW5wdXQ8VEluPiB9PlxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBmb3IgKGNvbnN0IHsgdGFzaywgaW5wdXQgfSBvZiB0YXNrcykge1xuICAgICAgdGhpcy5zY2hlZHVsZVRhc2sodGFzaywgaW5wdXQpO1xuICAgIH1cbiAgfVxuXG4gIG9uVGFza0NvbXBsZXRlKGNhbGxiYWNrOiAocmVzdWx0OiBUYXNrT3V0cHV0PFRPdXQ+KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5lbWl0dGVyLm9uKFwidGFza0NvbXBsZXRlXCIsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJvY2Vzc09yRW5xdWV1ZVRhc2soZGVmZXJyZWRUYXNrOiBEZWZlcnJlZFRhc2s8VEluLCBUT3V0Pik6IHZvaWQge1xuICAgIHRoaXMudXBkYXRlV2luZG93U3RhdGUoKTtcblxuICAgIGlmICh0aGlzLmNhbkluaXRpYXRlVGFzaygpKSB7XG4gICAgICB0aGlzLmluaXRpYXRlVGFzayhkZWZlcnJlZFRhc2spO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnF1ZXVlLmVucXVldWUoZGVmZXJyZWRUYXNrKTtcbiAgICAgIHRoaXMuZGVidWcoYFRhc2sgZW5xdWV1ZWQuIEN1cnJlbnQgcXVldWUgc2l6ZTogJHt0aGlzLnF1ZXVlLnNpemUoKX1gKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVdpbmRvd1N0YXRlKCk6IHZvaWQge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgaWYgKG5vdyAtIHRoaXMud2luZG93U3RhcnRUaW1lID49IHRoaXMuaW50ZXJ2YWwpIHtcbiAgICAgIHRoaXMud2luZG93U3RhcnRUaW1lID0gbm93O1xuICAgICAgdGhpcy50YXNrc0luaXRpYXRlZEluV2luZG93ID0gMDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhbkluaXRpYXRlVGFzaygpOiBib29sZWFuIHtcbiAgICB0aGlzLnVwZGF0ZVdpbmRvd1N0YXRlKCk7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMudGFza3NJbml0aWF0ZWRJbldpbmRvdyA8IHRoaXMudGFza3NQZXJJbnRlcnZhbCAmJlxuICAgICAgdGhpcy5ydW5uaW5nVGFza3MgPCB0aGlzLmNvbmN1cnJlbmN5TGltaXRcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWF0ZVRhc2soZGVmZXJyZWRUYXNrOiBEZWZlcnJlZFRhc2s8VEluLCBUT3V0Pik6IHZvaWQge1xuICAgIHRoaXMudGFza3NJbml0aWF0ZWRJbldpbmRvdysrO1xuICAgIHRoaXMucnVubmluZ1Rhc2tzKys7XG4gICAgdGhpcy5wcm9jZXNzVGFzayhkZWZlcnJlZFRhc2spO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIHByb2Nlc3NUYXNrKFxuICAgIGRlZmVycmVkVGFzazogRGVmZXJyZWRUYXNrPFRJbiwgVE91dD5cbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgIGxldCByZXN1bHQ6IFRhc2tPdXRwdXQ8VE91dD47XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGV4ZWN1dGlvblJlc3VsdCA9IGF3YWl0IGRlZmVycmVkVGFzay5leGVjdXRlKGRlZmVycmVkVGFzay5pbnB1dCk7XG4gICAgICByZXN1bHQgPSB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHJlc3VsdDogZXhlY3V0aW9uUmVzdWx0LFxuICAgICAgfTtcbiAgICAgIHRoaXMudGFza1Byb2Nlc3NlZENvdW50Kys7XG4gICAgICBjb25zdCBlbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIHRoaXMuZGVidWcoYFRhc2sgY29tcGxldGVkLiBFeGVjdXRpb24gdGltZTogJHtlbmRUaW1lIC0gc3RhcnRUaW1lfW1zYCk7XG4gICAgICB0aGlzLmVtaXR0ZXIuZW1pdChcInRhc2tDb21wbGV0ZVwiLCByZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIHJlc3VsdCA9IHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOlxuICAgICAgICAgIGVycm9yIGluc3RhbmNlb2YgTG9nZ2FibGVFcnJvciA/IGVycm9yIDogbmV3IExvZ2dhYmxlRXJyb3IoZXJyb3IpLFxuICAgICAgfTtcbiAgICAgIHRoaXMuZXJyb3IoXCJUYXNrIGV4ZWN1dGlvbiBmYWlsZWRcIiwgZXJyb3IpO1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoXCJ0YXNrQ29tcGxldGVcIiwgcmVzdWx0KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5ydW5uaW5nVGFza3MtLTtcbiAgICAgIHRoaXMucHJvY2Vzc05leHRUYXNrSWZBdmFpbGFibGUoKTtcbiAgICAgIHRoaXMuc3RvcFRpbWVySWZOb1Rhc2tzKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwcm9jZXNzTmV4dFRhc2tJZkF2YWlsYWJsZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5xdWV1ZS5zaXplKCkgPiAwICYmIHRoaXMuY2FuSW5pdGlhdGVUYXNrKCkpIHtcbiAgICAgIGNvbnN0IG5leHRUYXNrID0gdGhpcy5xdWV1ZS5kZXF1ZXVlKCk7XG4gICAgICBpZiAobmV4dFRhc2spIHtcbiAgICAgICAgdGhpcy5pbml0aWF0ZVRhc2sobmV4dFRhc2spO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tBbmRQcm9jZXNzVGFza3MoKTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGVXaW5kb3dTdGF0ZSgpO1xuICAgIHdoaWxlICh0aGlzLmNhbkluaXRpYXRlVGFzaygpICYmIHRoaXMucXVldWUuc2l6ZSgpID4gMCkge1xuICAgICAgY29uc3QgbmV4dFRhc2sgPSB0aGlzLnF1ZXVlLmRlcXVldWUoKTtcbiAgICAgIGlmIChuZXh0VGFzaykge1xuICAgICAgICB0aGlzLmluaXRpYXRlVGFzayhuZXh0VGFzayk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuc3RvcFRpbWVySWZOb1Rhc2tzKCk7XG4gIH1cblxuICBwcml2YXRlIHJlc3RhcnRUaW1lcklmTmVlZGVkKCk6IHZvaWQge1xuICAgIGlmIChcbiAgICAgIHRoaXMud2luZG93Q2hlY2tJbnRlcnZhbCA9PT0gbnVsbCAmJlxuICAgICAgKHRoaXMucnVubmluZ1Rhc2tzID4gMCB8fCB0aGlzLnF1ZXVlLnNpemUoKSA+IDApXG4gICAgKSB7XG4gICAgICB0aGlzLndpbmRvd0NoZWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChcbiAgICAgICAgKCkgPT4gdGhpcy5jaGVja0FuZFByb2Nlc3NUYXNrcygpLFxuICAgICAgICBNYXRoLm1pbih0aGlzLmludGVydmFsLCAxMDAwKVxuICAgICAgKTtcbiAgICAgIHRoaXMuZGVidWcoXCJUaW1lciBzdGFydGVkXCIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RvcFRpbWVySWZOb1Rhc2tzKCk6IHZvaWQge1xuICAgIGlmIChcbiAgICAgIHRoaXMud2luZG93Q2hlY2tJbnRlcnZhbCAhPT0gbnVsbCAmJlxuICAgICAgdGhpcy5ydW5uaW5nVGFza3MgPT09IDAgJiZcbiAgICAgIHRoaXMucXVldWUuc2l6ZSgpID09PSAwXG4gICAgKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMud2luZG93Q2hlY2tJbnRlcnZhbCk7XG4gICAgICB0aGlzLndpbmRvd0NoZWNrSW50ZXJ2YWwgPSBudWxsO1xuICAgICAgdGhpcy5kZWJ1ZyhcIlRpbWVyIHN0b3BwZWRcIik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXNldFdpbmRvd1N0YXRlKCk6IHZvaWQge1xuICAgIHRoaXMud2luZG93U3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLnRhc2tzSW5pdGlhdGVkSW5XaW5kb3cgPSAwO1xuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMud2luZG93Q2hlY2tJbnRlcnZhbCAhPT0gbnVsbCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLndpbmRvd0NoZWNrSW50ZXJ2YWwpO1xuICAgICAgdGhpcy53aW5kb3dDaGVja0ludGVydmFsID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==