"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RequestBuilder = void 0;
class RequestBuilder {
    constructor(body) {
        this.request = {
            header: {
                timestamp: Date.now(),
                requestId: crypto.randomUUID(),
                requesterAddress: "",
                requestType: "",
                requiresResponse: true,
            },
            body,
        };
    }
    // Basic header setters
    setRequesterAddress(address) {
        this.request.header.requesterAddress = address;
        return this;
    }
    setRecipientAddress(address) {
        this.request.header.recipientAddress = address;
        return this;
    }
    setRequestType(type) {
        this.request.header.requestType = type;
        return this;
    }
    setSessionId(sessionId) {
        this.request.header.sessionId = sessionId;
        return this;
    }
    setRequiresResponse(requires) {
        this.request.header.requiresResponse = requires;
        return this;
    }
    // Authentication related setters
    setAuthToken(token) {
        this.request.header.authToken = token;
        return this;
    }
    setRefreshToken(token) {
        this.request.header.refreshToken = token;
        return this;
    }
    // Auth metadata manipulation
    initAuthMetadata() {
        if (!this.request.header.authMetadata) {
            this.request.header.authMetadata = {};
        }
        return this;
    }
    setRoles(roles) {
        this.initAuthMetadata();
        this.request.header.authMetadata.roles = roles;
        return this;
    }
    addRole(role) {
        this.initAuthMetadata();
        const roles = this.request.header.authMetadata.roles || [];
        if (!roles.includes(role)) {
            roles.push(role);
        }
        this.request.header.authMetadata.roles = roles;
        return this;
    }
    setPermissions(permissions) {
        this.initAuthMetadata();
        this.request.header.authMetadata.permissions = permissions;
        return this;
    }
    addPermission(permission) {
        this.initAuthMetadata();
        const permissions = this.request.header.authMetadata.permissions || [];
        if (!permissions.includes(permission)) {
            permissions.push(permission);
        }
        this.request.header.authMetadata.permissions = permissions;
        return this;
    }
    setScope(scope) {
        this.initAuthMetadata();
        this.request.header.authMetadata.scope = scope;
        return this;
    }
    setAuthMetadataField(key, value) {
        this.initAuthMetadata();
        this.request.header.authMetadata[key] = value;
        return this;
    }
    // Timestamp manipulation
    setTimestamp(timestamp) {
        this.request.header.timestamp = timestamp;
        return this;
    }
    updateTimestamp() {
        this.request.header.timestamp = Date.now();
        return this;
    }
    // Request ID manipulation
    setRequestId(id) {
        this.request.header.requestId = id;
        return this;
    }
    regenerateRequestId() {
        this.request.header.requestId = crypto.randomUUID();
        return this;
    }
    // Body manipulation
    setBody(body) {
        this.request.body = body;
        return this;
    }
    updateBody(updater) {
        this.request.body = updater(this.request.body);
        return this;
    }
    // Build methods
    build() {
        return { ...this.request };
    }
    clone() {
        const builder = new RequestBuilder(this.request.body);
        builder.request = JSON.parse(JSON.stringify(this.request));
        return builder;
    }
    // Static creators
    static from(request) {
        const builder = new RequestBuilder(request.body);
        builder.request = JSON.parse(JSON.stringify(request));
        return builder;
    }
    static createSimple(requesterAddress, requestType, body, recipientAddress) {
        return new RequestBuilder(body)
            .setRequesterAddress(requesterAddress)
            .setRequestType(requestType)
            .setRecipientAddress(recipientAddress || "")
            .build();
    }
}
exports.RequestBuilder = RequestBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVxdWVzdEJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29yZS9SZXF1ZXN0QnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxNQUFhLGNBQWM7SUFHekIsWUFBWSxJQUFPO1FBQ2pCLElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDYixNQUFNLEVBQUU7Z0JBQ04sU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JCLFNBQVMsRUFBRSxNQUFNLENBQUMsVUFBVSxFQUFFO2dCQUM5QixnQkFBZ0IsRUFBRSxFQUFFO2dCQUNwQixXQUFXLEVBQUUsRUFBRTtnQkFDZixnQkFBZ0IsRUFBRSxJQUFJO2FBQ3ZCO1lBQ0QsSUFBSTtTQUNMLENBQUM7SUFDSixDQUFDO0lBRUQsdUJBQXVCO0lBQ2hCLG1CQUFtQixDQUFDLE9BQWU7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDO1FBQy9DLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVNLG1CQUFtQixDQUFDLE9BQWU7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDO1FBQy9DLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVNLGNBQWMsQ0FBQyxJQUFZO1FBQ2hDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sWUFBWSxDQUFDLFNBQWlCO1FBQ25DLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDMUMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sbUJBQW1CLENBQUMsUUFBaUI7UUFDMUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEdB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QyxDQUFDLENBQUM7UUFDM0QsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVELGtCQUFrQjtJQUNYLE1BQU0sQ0FBQyxJQUFJLENBQUksT0FBb0I7UUFDeEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxjQUFjLENBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELE9BQU8sQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDdEQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxZQUFZLENBQ3hCLGdCQUF3QixFQUN4QixXQUFtQixFQUNuQixJQUFPLEVBQ1AsZ0JBQXlCO1FBRXpCLE9BQU8sSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDO2FBQzVCLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDO2FBQ3JDLGNBQWMsQ0FBQyxXQUFXLENBQUM7YUFDM0IsbUJBQW1CLENBQUMsZ0JBQWdCLElBQUksRUFBRSxDQUFDO2FBQzNDLEtBQUssRUFBRSxDQUFDO0lBQ2IsQ0FBQztDQUNGO0FBeEtELHdDQXdLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElSZXF1ZXN0IH0gZnJvbSBcIi4uL2ludGVyZmFjZXNcIjtcblxuZXhwb3J0IGNsYXNzIFJlcXVlc3RCdWlsZGVyPFQ+IHtcbiAgcHJpdmF0ZSByZXF1ZXN0OiBJUmVxdWVzdDxUPjtcblxuICBjb25zdHJ1Y3Rvcihib2R5OiBUKSB7XG4gICAgdGhpcy5yZXF1ZXN0ID0ge1xuICAgICAgaGVhZGVyOiB7XG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgcmVxdWVzdElkOiBjcnlwdG8ucmFuZG9tVVVJRCgpLFxuICAgICAgICByZXF1ZXN0ZXJBZGRyZXNzOiBcIlwiLFxuICAgICAgICByZXF1ZXN0VHlwZTogXCJcIixcbiAgICAgICAgcmVxdWlyZXNSZXNwb25zZTogdHJ1ZSxcbiAgICAgIH0sXG4gICAgICBib2R5LFxuICAgIH07XG4gIH1cblxuICAvLyBCYXNpYyBoZWFkZXIgc2V0dGVyc1xuICBwdWJsaWMgc2V0UmVxdWVzdGVyQWRkcmVzcyhhZGRyZXNzOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnJlcXVlc3RlckFkZHJlc3MgPSBhZGRyZXNzO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldFJlY2lwaWVudEFkZHJlc3MoYWRkcmVzczogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5yZWNpcGllbnRBZGRyZXNzID0gYWRkcmVzcztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZXF1ZXN0VHlwZSh0eXBlOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnJlcXVlc3RUeXBlID0gdHlwZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRTZXNzaW9uSWQoc2Vzc2lvbklkOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZXF1aXJlc1Jlc3BvbnNlKHJlcXVpcmVzOiBib29sZWFuKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5yZXF1aXJlc1Jlc3BvbnNlID0gcmVxdWlyZXM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBBdXRoZW50aWNhdGlvbiByZWxhdGVkIHNldHRlcnNcbiAgcHVibGljIHNldEF1dGhUb2tlbih0b2tlbjogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoVG9rZW4gPSB0b2tlbjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZWZyZXNoVG9rZW4odG9rZW46IHN0cmluZyk6IHRoaXMge1xuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIucmVmcmVzaFRva2VuID0gdG9rZW47XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBBdXRoIG1ldGFkYXRhIG1hbmlwdWxhdGlvblxuICBwdWJsaWMgaW5pdEF1dGhNZXRhZGF0YSgpOiB0aGlzIHtcbiAgICBpZiAoIXRoaXMucmVxdWVzdC5oZWFkZXIuYXV0aE1ldGFkYXRhKSB7XG4gICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLmF1dGhNZXRhZGF0YSA9IHt9O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSb2xlcyhyb2xlczogc3RyaW5nW10pOiB0aGlzIHtcbiAgICB0aGlzLmluaXRBdXRoTWV0YWRhdGEoKTtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLmF1dGhNZXRhZGF0YSEucm9sZXMgPSByb2xlcztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBhZGRSb2xlKHJvbGU6IHN0cmluZyk6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIGNvbnN0IHJvbGVzID0gdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhLnJvbGVzIHx8IFtdO1xuICAgIGlmICghcm9sZXMuaW5jbHVkZXMocm9sZSkpIHtcbiAgICAgIHJvbGVzLnB1c2gocm9sZSk7XG4gICAgfVxuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIuYXV0aE1ldGFkYXRhIS5yb2xlcyA9IHJvbGVzO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBzdHJpbmdbXSk6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIuYXV0aE1ldGFkYXRhIS5wZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIGFkZFBlcm1pc3Npb24ocGVybWlzc2lvbjogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5pbml0QXV0aE1ldGFkYXRhKCk7XG4gICAgY29uc3QgcGVybWlzc2lvbnMgPSB0aGlzLnJlcXVlc3QuaGVhZGVyLmF1dGhNZXRhZGF0YSEucGVybWlzc2lvbnMgfHwgW107XG4gICAgaWYgKCFwZXJtaXNzaW9ucy5pbmNsdWRlcyhwZXJtaXNzaW9uKSkge1xuICAgICAgcGVybWlzc2lvbnMucHVzaChwZXJtaXNzaW9uKTtcbiAgICB9XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhLnBlcm1pc3Npb25zID0gcGVybWlzc2lvbnM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgc2V0U2NvcGUoc2NvcGU6IHN0cmluZ1tdKTogdGhpcyB7XG4gICAgdGhpcy5pbml0QXV0aE1ldGFkYXRhKCk7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhLnNjb3BlID0gc2NvcGU7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgc2V0QXV0aE1ldGFkYXRhRmllbGQoa2V5OiBzdHJpbmcsIHZhbHVlOiB1bmtub3duKTogdGhpcyB7XG4gICAgdGhpcy5pbml0QXV0aE1ldGFkYXRhKCk7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhW2tleV0gPSB2YWx1ZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8vIFRpbWVzdGFtcCBtYW5pcHVsYXRpb25cbiAgcHVibGljIHNldFRpbWVzdGFtcCh0aW1lc3RhbXA6IG51bWJlcik6IHRoaXMge1xuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIudGltZXN0YW1wID0gdGltZXN0YW1wO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZVRpbWVzdGFtcCgpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBSZXF1ZXN0IElEIG1hbmlwdWxhdGlvblxuICBwdWJsaWMgc2V0UmVxdWVzdElkKGlkOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnJlcXVlc3RJZCA9IGlkO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHJlZ2VuZXJhdGVSZXF1ZXN0SWQoKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5yZXF1ZXN0SWQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLy8gQm9keSBtYW5pcHVsYXRpb25cbiAgcHVibGljIHNldEJvZHkoYm9keTogVCk6IHRoaXMge1xuICAgIHRoaXMucmVxdWVzdC5ib2R5ID0gYm9keTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVCb2R5KHVwZGF0ZXI6IChib2R5OiBUKSA9PiBUKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmJvZHkgPSB1cGRhdGVyKHRoaXMucmVxdWVzdC5ib2R5KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8vIEJ1aWxkIG1ldGhvZHNcbiAgcHVibGljIGJ1aWxkKCk6IElSZXF1ZXN0PFQ+IHtcbiAgICByZXR1cm4geyAuLi50aGlzLnJlcXVlc3QgfTtcbiAgfVxuXG4gIHB1YmxpYyBjbG9uZSgpOiBSZXF1ZXN0QnVpbGRlcjxUPiB7XG4gICAgY29uc3QgYnVpbGRlciA9IG5ldyBSZXF1ZXN0QnVpbGRlcjxUPih0aGlzLnJlcXVlc3QuYm9keSk7XG4gICAgYnVpbGRlci5yZXF1ZXN0ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLnJlcXVlc3QpKTtcbiAgICByZXR1cm4gYnVpbGRlcjtcbiAgfVxuXG4gIC8vIFN0YXRpYyBjcmVhdG9yc1xuICBwdWJsaWMgc3RhdGljIGZyb208VD4ocmVxdWVzdDogSVJlcXVlc3Q8VD4pOiBSZXF1ZXN0QnVpbGRlcjxUPiB7XG4gICAgY29uc3QgYnVpbGRlciA9IG5ldyBSZXF1ZXN0QnVpbGRlcjxUPihyZXF1ZXN0LmJvZHkpO1xuICAgIGJ1aWxkZXIucmVxdWVzdCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpO1xuICAgIHJldHVybiBidWlsZGVyO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGVTaW1wbGU8VD4oXG4gICAgcmVxdWVzdGVyQWRkcmVzczogc3RyaW5nLFxuICAgIHJlcXVlc3RUeXBlOiBzdHJpbmcsXG4gICAgYm9keTogVCxcbiAgICByZWNpcGllbnRBZGRyZXNzPzogc3RyaW5nXG4gICk6IElSZXF1ZXN0PFQ+IHtcbiAgICByZXR1cm4gbmV3IFJlcXVlc3RCdWlsZGVyKGJvZHkpXG4gICAgICAuc2V0UmVxdWVzdGVyQWRkcmVzcyhyZXF1ZXN0ZXJBZGRyZXNzKVxuICAgICAgLnNldFJlcXVlc3RUeXBlKHJlcXVlc3RUeXBlKVxuICAgICAgLnNldFJlY2lwaWVudEFkZHJlc3MocmVjaXBpZW50QWRkcmVzcyB8fCBcIlwiKVxuICAgICAgLmJ1aWxkKCk7XG4gIH1cbn1cbiJdfQ==