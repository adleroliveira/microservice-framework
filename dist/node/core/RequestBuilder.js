"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RequestBuilder = void 0;
const uuid_1 = require("uuid");
class RequestBuilder {
    constructor(body) {
        this.request = {
            header: {
                timestamp: Date.now(),
                requestId: (0, uuid_1.v4)(),
                requesterAddress: "",
                requestType: "",
            },
            body,
        };
    }
    // Basic header setters
    setRequesterAddress(address) {
        this.request.header.requesterAddress = address;
        return this;
    }
    setRecipientAddress(address) {
        this.request.header.recipientAddress = address;
        return this;
    }
    setRequestType(type) {
        this.request.header.requestType = type;
        return this;
    }
    setSessionId(sessionId) {
        this.request.header.sessionId = sessionId;
        return this;
    }
    setRequiresResponse(requires) {
        this.request.header.requiresResponse = requires;
        return this;
    }
    // Authentication related setters
    setAuthToken(token) {
        this.request.header.authToken = token;
        return this;
    }
    setRefreshToken(token) {
        this.request.header.refreshToken = token;
        return this;
    }
    // Auth metadata manipulation
    initAuthMetadata() {
        if (!this.request.header.authMetadata) {
            this.request.header.authMetadata = {};
        }
        return this;
    }
    setRoles(roles) {
        this.initAuthMetadata();
        this.request.header.authMetadata.roles = roles;
        return this;
    }
    addRole(role) {
        this.initAuthMetadata();
        const roles = this.request.header.authMetadata.roles || [];
        if (!roles.includes(role)) {
            roles.push(role);
        }
        this.request.header.authMetadata.roles = roles;
        return this;
    }
    setPermissions(permissions) {
        this.initAuthMetadata();
        this.request.header.authMetadata.permissions = permissions;
        return this;
    }
    addPermission(permission) {
        this.initAuthMetadata();
        const permissions = this.request.header.authMetadata.permissions || [];
        if (!permissions.includes(permission)) {
            permissions.push(permission);
        }
        this.request.header.authMetadata.permissions = permissions;
        return this;
    }
    setScope(scope) {
        this.initAuthMetadata();
        this.request.header.authMetadata.scope = scope;
        return this;
    }
    setAuthMetadataField(key, value) {
        this.initAuthMetadata();
        this.request.header.authMetadata[key] = value;
        return this;
    }
    // Timestamp manipulation
    setTimestamp(timestamp) {
        this.request.header.timestamp = timestamp;
        return this;
    }
    updateTimestamp() {
        this.request.header.timestamp = Date.now();
        return this;
    }
    // Request ID manipulation
    setRequestId(id) {
        this.request.header.requestId = id;
        return this;
    }
    regenerateRequestId() {
        this.request.header.requestId = (0, uuid_1.v4)();
        return this;
    }
    // Body manipulation
    setBody(body) {
        this.request.body = body;
        return this;
    }
    updateBody(updater) {
        this.request.body = updater(this.request.body);
        return this;
    }
    // Build methods
    build() {
        return { ...this.request };
    }
    clone() {
        const builder = new RequestBuilder(this.request.body);
        builder.request = JSON.parse(JSON.stringify(this.request));
        return builder;
    }
    // Static creators
    static from(request) {
        const builder = new RequestBuilder(request.body);
        builder.request = JSON.parse(JSON.stringify(request));
        return builder;
    }
    static createSimple(requesterAddress, requestType, body, recipientAddress) {
        return new RequestBuilder(body)
            .setRequesterAddress(requesterAddress)
            .setRequestType(requestType)
            .setRecipientAddress(recipientAddress || "")
            .build();
    }
}
exports.RequestBuilder = RequestBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVxdWVzdEJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29yZS9SZXF1ZXN0QnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQkFBb0M7QUFHcEMsTUFBYSxjQUFjO0lBR3pCLFlBQVksSUFBTztRQUNqQixJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ2IsTUFBTSxFQUFFO2dCQUNOLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNyQixTQUFTLEVBQUUsSUFBQSxTQUFNLEdBQUU7Z0JBQ25CLGdCQUFnQixFQUFFLEVBQUU7Z0JBQ3BCLFdBQVcsRUFBRSxFQUFFO2FBQ2hCO1lBQ0QsSUFBSTtTQUNMLENBQUM7SUFDSixDQUFDO0lBRUQsdUJBQXVCO0lBQ2hCLG1CQUFtQixDQUFDLE9BQWU7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDO1FBQy9DLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVNLG1CQUFtQixDQUFDLE9BQWU7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDO1FBQy9DLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVNLGNBQWMsQ0FBQyxJQUFZO1FBQ2hDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sWUFBWSxDQUFDLFNBQWlCO1FBQ25DLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDMUMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sbUJBQW1CLENBQUMsUUFBaUI7UUFDMUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsUUFBUSxDQUFDO1FB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QU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRCxrQkFBa0I7SUFDWCxNQUFNLENBQUMsSUFBSSxDQUFJLE9BQW9CO1FBQ3hDLE1BQU0sT0FBTyxHQUFHLElBQUksY0FBYyxDQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwRCxPQUFPLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3RELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFTSxNQUFNLENBQUMsWUFBWSxDQUN4QixnQkFBd0IsRUFDeEIsV0FBbUIsRUFDbkIsSUFBTyxFQUNQLGdCQUF5QjtRQUV6QixPQUFPLElBQUksY0FBYyxDQUFDLElBQUksQ0FBQzthQUM1QixtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQzthQUNyQyxjQUFjLENBQUMsV0FBVyxDQUFDO2FBQzNCLG1CQUFtQixDQUFDLGdCQUFnQixJQUFJLEVBQUUsQ0FBQzthQUMzQyxLQUFLLEVBQUUsQ0FBQztJQUNiLENBQUM7Q0FDRjtBQXZLRCx3Q0F1S0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0IHsgSVJlcXVlc3QgfSBmcm9tIFwiLi4vaW50ZXJmYWNlc1wiO1xuXG5leHBvcnQgY2xhc3MgUmVxdWVzdEJ1aWxkZXI8VD4ge1xuICBwcml2YXRlIHJlcXVlc3Q6IElSZXF1ZXN0PFQ+O1xuXG4gIGNvbnN0cnVjdG9yKGJvZHk6IFQpIHtcbiAgICB0aGlzLnJlcXVlc3QgPSB7XG4gICAgICBoZWFkZXI6IHtcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICByZXF1ZXN0SWQ6IHV1aWR2NCgpLFxuICAgICAgICByZXF1ZXN0ZXJBZGRyZXNzOiBcIlwiLFxuICAgICAgICByZXF1ZXN0VHlwZTogXCJcIixcbiAgICAgIH0sXG4gICAgICBib2R5LFxuICAgIH07XG4gIH1cblxuICAvLyBCYXNpYyBoZWFkZXIgc2V0dGVyc1xuICBwdWJsaWMgc2V0UmVxdWVzdGVyQWRkcmVzcyhhZGRyZXNzOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnJlcXVlc3RlckFkZHJlc3MgPSBhZGRyZXNzO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldFJlY2lwaWVudEFkZHJlc3MoYWRkcmVzczogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5yZWNpcGllbnRBZGRyZXNzID0gYWRkcmVzcztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZXF1ZXN0VHlwZSh0eXBlOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnJlcXVlc3RUeXBlID0gdHlwZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRTZXNzaW9uSWQoc2Vzc2lvbklkOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZXF1aXJlc1Jlc3BvbnNlKHJlcXVpcmVzOiBib29sZWFuKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5yZXF1aXJlc1Jlc3BvbnNlID0gcmVxdWlyZXM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBBdXRoZW50aWNhdGlvbiByZWxhdGVkIHNldHRlcnNcbiAgcHVibGljIHNldEF1dGhUb2tlbih0b2tlbjogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoVG9rZW4gPSB0b2tlbjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSZWZyZXNoVG9rZW4odG9rZW46IHN0cmluZyk6IHRoaXMge1xuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIucmVmcmVzaFRva2VuID0gdG9rZW47XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBBdXRoIG1ldGFkYXRhIG1hbmlwdWxhdGlvblxuICBwdWJsaWMgaW5pdEF1dGhNZXRhZGF0YSgpOiB0aGlzIHtcbiAgICBpZiAoIXRoaXMucmVxdWVzdC5oZWFkZXIuYXV0aE1ldGFkYXRhKSB7XG4gICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLmF1dGhNZXRhZGF0YSA9IHt9O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSb2xlcyhyb2xlczogc3RyaW5nW10pOiB0aGlzIHtcbiAgICB0aGlzLmluaXRBdXRoTWV0YWRhdGEoKTtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLmF1dGhNZXRhZGF0YSEucm9sZXMgPSByb2xlcztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBhZGRSb2xlKHJvbGU6IHN0cmluZyk6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIGNvbnN0IHJvbGVzID0gdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhLnJvbGVzIHx8IFtdO1xuICAgIGlmICghcm9sZXMuaW5jbHVkZXMocm9sZSkpIHtcbiAgICAgIHJvbGVzLnB1c2gocm9sZSk7XG4gICAgfVxuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIuYXV0aE1ldGFkYXRhIS5yb2xlcyA9IHJvbGVzO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBzdHJpbmdbXSk6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIuYXV0aE1ldGFkYXRhIS5wZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIGFkZFBlcm1pc3Npb24ocGVybWlzc2lvbjogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5pbml0QXV0aE1ldGFkYXRhKCk7XG4gICAgY29uc3QgcGVybWlzc2lvbnMgPSB0aGlzLnJlcXVlc3QuaGVhZGVyLmF1dGhNZXRhZGF0YSEucGVybWlzc2lvbnMgfHwgW107XG4gICAgaWYgKCFwZXJtaXNzaW9ucy5pbmNsdWRlcyhwZXJtaXNzaW9uKSkge1xuICAgICAgcGVybWlzc2lvbnMucHVzaChwZXJtaXNzaW9uKTtcbiAgICB9XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhLnBlcm1pc3Npb25zID0gcGVybWlzc2lvbnM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgc2V0U2NvcGUoc2NvcGU6IHN0cmluZ1tdKTogdGhpcyB7XG4gICAgdGhpcy5pbml0QXV0aE1ldGFkYXRhKCk7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhLnNjb3BlID0gc2NvcGU7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgc2V0QXV0aE1ldGFkYXRhRmllbGQoa2V5OiBzdHJpbmcsIHZhbHVlOiB1bmtub3duKTogdGhpcyB7XG4gICAgdGhpcy5pbml0QXV0aE1ldGFkYXRhKCk7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5hdXRoTWV0YWRhdGEhW2tleV0gPSB2YWx1ZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8vIFRpbWVzdGFtcCBtYW5pcHVsYXRpb25cbiAgcHVibGljIHNldFRpbWVzdGFtcCh0aW1lc3RhbXA6IG51bWJlcik6IHRoaXMge1xuICAgIHRoaXMucmVxdWVzdC5oZWFkZXIudGltZXN0YW1wID0gdGltZXN0YW1wO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZVRpbWVzdGFtcCgpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnRpbWVzdGFtcCA9IERhdGUubm93KCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBSZXF1ZXN0IElEIG1hbmlwdWxhdGlvblxuICBwdWJsaWMgc2V0UmVxdWVzdElkKGlkOiBzdHJpbmcpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyLnJlcXVlc3RJZCA9IGlkO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHJlZ2VuZXJhdGVSZXF1ZXN0SWQoKTogdGhpcyB7XG4gICAgdGhpcy5yZXF1ZXN0LmhlYWRlci5yZXF1ZXN0SWQgPSB1dWlkdjQoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8vIEJvZHkgbWFuaXB1bGF0aW9uXG4gIHB1YmxpYyBzZXRCb2R5KGJvZHk6IFQpOiB0aGlzIHtcbiAgICB0aGlzLnJlcXVlc3QuYm9keSA9IGJvZHk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQm9keSh1cGRhdGVyOiAoYm9keTogVCkgPT4gVCk6IHRoaXMge1xuICAgIHRoaXMucmVxdWVzdC5ib2R5ID0gdXBkYXRlcih0aGlzLnJlcXVlc3QuYm9keSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBCdWlsZCBtZXRob2RzXG4gIHB1YmxpYyBidWlsZCgpOiBJUmVxdWVzdDxUPiB7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5yZXF1ZXN0IH07XG4gIH1cblxuICBwdWJsaWMgY2xvbmUoKTogUmVxdWVzdEJ1aWxkZXI8VD4ge1xuICAgIGNvbnN0IGJ1aWxkZXIgPSBuZXcgUmVxdWVzdEJ1aWxkZXI8VD4odGhpcy5yZXF1ZXN0LmJvZHkpO1xuICAgIGJ1aWxkZXIucmVxdWVzdCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5yZXF1ZXN0KSk7XG4gICAgcmV0dXJuIGJ1aWxkZXI7XG4gIH1cblxuICAvLyBTdGF0aWMgY3JlYXRvcnNcbiAgcHVibGljIHN0YXRpYyBmcm9tPFQ+KHJlcXVlc3Q6IElSZXF1ZXN0PFQ+KTogUmVxdWVzdEJ1aWxkZXI8VD4ge1xuICAgIGNvbnN0IGJ1aWxkZXIgPSBuZXcgUmVxdWVzdEJ1aWxkZXI8VD4ocmVxdWVzdC5ib2R5KTtcbiAgICBidWlsZGVyLnJlcXVlc3QgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpKTtcbiAgICByZXR1cm4gYnVpbGRlcjtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlU2ltcGxlPFQ+KFxuICAgIHJlcXVlc3RlckFkZHJlc3M6IHN0cmluZyxcbiAgICByZXF1ZXN0VHlwZTogc3RyaW5nLFxuICAgIGJvZHk6IFQsXG4gICAgcmVjaXBpZW50QWRkcmVzcz86IHN0cmluZ1xuICApOiBJUmVxdWVzdDxUPiB7XG4gICAgcmV0dXJuIG5ldyBSZXF1ZXN0QnVpbGRlcihib2R5KVxuICAgICAgLnNldFJlcXVlc3RlckFkZHJlc3MocmVxdWVzdGVyQWRkcmVzcylcbiAgICAgIC5zZXRSZXF1ZXN0VHlwZShyZXF1ZXN0VHlwZSlcbiAgICAgIC5zZXRSZWNpcGllbnRBZGRyZXNzKHJlY2lwaWVudEFkZHJlc3MgfHwgXCJcIilcbiAgICAgIC5idWlsZCgpO1xuICB9XG59XG4iXX0=