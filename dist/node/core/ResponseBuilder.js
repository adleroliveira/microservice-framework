"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ResponseBuilder = void 0;
class ResponseBuilder {
    constructor(request, data) {
        this.response = {
            requestHeader: { ...request.header },
            responseHeader: {
                responderAddress: "",
                timestamp: Date.now(),
            },
            body: {
                data,
                success: true,
                error: null,
            },
        };
    }
    // Basic header setters
    setResponderAddress(address) {
        this.response.responseHeader.responderAddress = address;
        return this;
    }
    // Authentication token management
    setNewAuthToken(token) {
        this.response.responseHeader.newAuthToken = token;
        return this;
    }
    setNewRefreshToken(token) {
        this.response.responseHeader.newRefreshToken = token;
        return this;
    }
    // Auth metadata manipulation
    initAuthMetadata() {
        if (!this.response.responseHeader.authMetadata) {
            this.response.responseHeader.authMetadata = {};
        }
        return this;
    }
    setRoles(roles) {
        this.initAuthMetadata();
        this.response.responseHeader.authMetadata.roles = roles;
        return this;
    }
    addRole(role) {
        this.initAuthMetadata();
        const roles = this.response.responseHeader.authMetadata.roles || [];
        if (!roles.includes(role)) {
            roles.push(role);
        }
        this.response.responseHeader.authMetadata.roles = roles;
        return this;
    }
    setPermissions(permissions) {
        this.initAuthMetadata();
        this.response.responseHeader.authMetadata.permissions = permissions;
        return this;
    }
    addPermission(permission) {
        this.initAuthMetadata();
        const permissions = this.response.responseHeader.authMetadata.permissions || [];
        if (!permissions.includes(permission)) {
            permissions.push(permission);
        }
        this.response.responseHeader.authMetadata.permissions = permissions;
        return this;
    }
    setScope(scope) {
        this.initAuthMetadata();
        this.response.responseHeader.authMetadata.scope = scope;
        return this;
    }
    setAuthMetadataField(key, value) {
        this.initAuthMetadata();
        this.response.responseHeader.authMetadata[key] = value;
        return this;
    }
    // Response status management
    setSuccess(success) {
        this.response.body.success = success;
        return this;
    }
    setError(error) {
        this.response.body.error = error;
        this.response.body.success = false;
        return this;
    }
    setAuthenticationRequired(required) {
        this.response.body.authenticationRequired = required;
        return this;
    }
    setAuthenticationError(error) {
        this.response.body.authenticationError = error;
        this.response.body.success = false;
        return this;
    }
    setSessionExpired(expired) {
        this.response.body.sessionExpired = expired;
        return this;
    }
    // Timestamp manipulation
    setTimestamp(timestamp) {
        this.response.responseHeader.timestamp = timestamp;
        return this;
    }
    updateTimestamp() {
        this.response.responseHeader.timestamp = Date.now();
        return this;
    }
    // Data manipulation
    setData(data) {
        this.response.body.data = data;
        return this;
    }
    updateData(updater) {
        this.response.body.data = updater(this.response.body.data);
        return this;
    }
    // Build methods
    build() {
        return { ...this.response };
    }
    clone() {
        const builder = new ResponseBuilder({ header: this.response.requestHeader, body: {} }, this.response.body.data);
        builder.response = JSON.parse(JSON.stringify(this.response));
        return builder;
    }
    // Static creators
    static from(response) {
        const builder = new ResponseBuilder({ header: response.requestHeader, body: {} }, response.body.data);
        builder.response = JSON.parse(JSON.stringify(response));
        return builder;
    }
    // Common response creators
    static createSuccess(request, responderAddress, data) {
        return new ResponseBuilder(request, data)
            .setResponderAddress(responderAddress)
            .setSuccess(true)
            .build();
    }
    static createError(request, responderAddress, error) {
        return new ResponseBuilder(request, null)
            .setResponderAddress(responderAddress)
            .setError(error)
            .build();
    }
    static createAuthError(request, responderAddress, errorMessage) {
        return new ResponseBuilder(request, null)
            .setResponderAddress(responderAddress)
            .setAuthenticationRequired(true)
            .setAuthenticationError(errorMessage)
            .build();
    }
    static createSessionExpired(request, responderAddress) {
        return new ResponseBuilder(request, null)
            .setResponderAddress(responderAddress)
            .setSessionExpired(true)
            .setAuthenticationRequired(true)
            .build();
    }
}
exports.ResponseBuilder = ResponseBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzcG9uc2VCdWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvcmUvUmVzcG9uc2VCdWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLE1BQWEsZUFBZTtJQUcxQixZQUFZLE9BQXNCLEVBQUUsSUFBTztRQUN6QyxJQUFJLENBQUMsUUFBUSxHQUFHO1lBQ2QsYUFBYSxFQUFFLEVBQUUsR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ3BDLGNBQWMsRUFBRTtnQkFDZCxnQkFBZ0IsRUFBRSxFQUFFO2dCQUNwQixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QjtZQUNELElBQUksRUFBRTtnQkFDSixJQUFJO2dCQUNKLE9BQU8sRUFBRSxJQUFJO2dCQUNiLEtBQUssRUFBRSxJQUFJO2FBQ1o7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELHVCQUF1QjtJQUNoQixtQkFBbUIsQ0FBQyxPQUFlO1FBQ3hDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLGdCQUFnQixHQUFHLE9BQU8sQ0FBQztRQUN4RCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxrQ0FBa0M7SUFDM0IsZUFBZSxDQUFDLEtBQWE7UUFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUNsRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxLQUFhO1FBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7UUFDckQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsNkJBQTZCO0lBQ3RCLGdCQUFnQjtRQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDL0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsWUFB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LENBQzNCLE9BQXNCLEVBQ3RCLGdCQUF3QixFQUN4QixZQUFvQjtRQUVwQixPQUFPLElBQUksZUFBZSxDQUFJLE9BQU8sRUFBRSxJQUFTLENBQUM7YUFDOUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUM7YUFDckMseUJBQXlCLENBQUMsSUFBSSxDQUFDO2FBQy9CLHNCQUFzQixDQUFDLFlBQVksQ0FBQzthQUNwQyxLQUFLLEVBQUUsQ0FBQztJQUNiLENBQUM7SUFFTSxNQUFNLENBQUMsb0JBQW9CLENBQ2hDLE9BQXNCLEVBQ3RCLGdCQUF3QjtRQUV4QixPQUFPLElBQUksZUFBZSxDQUFJLE9BQU8sRUFBRSxJQUFTLENBQUM7YUFDOUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUM7YUFDckMsaUJBQWlCLENBQUMsSUFBSSxDQUFDO2FBQ3ZCLHlCQUF5QixDQUFDLElBQUksQ0FBQzthQUMvQixLQUFLLEVBQUUsQ0FBQztJQUNiLENBQUM7Q0FDRjtBQS9NRCwwQ0ErTUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJUmVxdWVzdCwgSVJlc3BvbnNlIH0gZnJvbSBcIi4uL2ludGVyZmFjZXNcIjtcblxuZXhwb3J0IGNsYXNzIFJlc3BvbnNlQnVpbGRlcjxUPiB7XG4gIHByaXZhdGUgcmVzcG9uc2U6IElSZXNwb25zZTxUPjtcblxuICBjb25zdHJ1Y3RvcihyZXF1ZXN0OiBJUmVxdWVzdDxhbnk+LCBkYXRhOiBUKSB7XG4gICAgdGhpcy5yZXNwb25zZSA9IHtcbiAgICAgIHJlcXVlc3RIZWFkZXI6IHsgLi4ucmVxdWVzdC5oZWFkZXIgfSxcbiAgICAgIHJlc3BvbnNlSGVhZGVyOiB7XG4gICAgICAgIHJlc3BvbmRlckFkZHJlc3M6IFwiXCIsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIH0sXG4gICAgICBib2R5OiB7XG4gICAgICAgIGRhdGEsXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIGVycm9yOiBudWxsLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgLy8gQmFzaWMgaGVhZGVyIHNldHRlcnNcbiAgcHVibGljIHNldFJlc3BvbmRlckFkZHJlc3MoYWRkcmVzczogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5yZXNwb25zZS5yZXNwb25zZUhlYWRlci5yZXNwb25kZXJBZGRyZXNzID0gYWRkcmVzcztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8vIEF1dGhlbnRpY2F0aW9uIHRva2VuIG1hbmFnZW1lbnRcbiAgcHVibGljIHNldE5ld0F1dGhUb2tlbih0b2tlbjogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5yZXNwb25zZS5yZXNwb25zZUhlYWRlci5uZXdBdXRoVG9rZW4gPSB0b2tlbjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXROZXdSZWZyZXNoVG9rZW4odG9rZW46IHN0cmluZyk6IHRoaXMge1xuICAgIHRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIubmV3UmVmcmVzaFRva2VuID0gdG9rZW47XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBBdXRoIG1ldGFkYXRhIG1hbmlwdWxhdGlvblxuICBwdWJsaWMgaW5pdEF1dGhNZXRhZGF0YSgpOiB0aGlzIHtcbiAgICBpZiAoIXRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIuYXV0aE1ldGFkYXRhKSB7XG4gICAgICB0aGlzLnJlc3BvbnNlLnJlc3BvbnNlSGVhZGVyLmF1dGhNZXRhZGF0YSA9IHt9O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzZXRSb2xlcyhyb2xlczogc3RyaW5nW10pOiB0aGlzIHtcbiAgICB0aGlzLmluaXRBdXRoTWV0YWRhdGEoKTtcbiAgICB0aGlzLnJlc3BvbnNlLnJlc3BvbnNlSGVhZGVyLmF1dGhNZXRhZGF0YSEucm9sZXMgPSByb2xlcztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBhZGRSb2xlKHJvbGU6IHN0cmluZyk6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIGNvbnN0IHJvbGVzID0gdGhpcy5yZXNwb25zZS5yZXNwb25zZUhlYWRlci5hdXRoTWV0YWRhdGEhLnJvbGVzIHx8IFtdO1xuICAgIGlmICghcm9sZXMuaW5jbHVkZXMocm9sZSkpIHtcbiAgICAgIHJvbGVzLnB1c2gocm9sZSk7XG4gICAgfVxuICAgIHRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIuYXV0aE1ldGFkYXRhIS5yb2xlcyA9IHJvbGVzO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldFBlcm1pc3Npb25zKHBlcm1pc3Npb25zOiBzdHJpbmdbXSk6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIHRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIuYXV0aE1ldGFkYXRhIS5wZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIGFkZFBlcm1pc3Npb24ocGVybWlzc2lvbjogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5pbml0QXV0aE1ldGFkYXRhKCk7XG4gICAgY29uc3QgcGVybWlzc2lvbnMgPVxuICAgICAgdGhpcy5yZXNwb25zZS5yZXNwb25zZUhlYWRlci5hdXRoTWV0YWRhdGEhLnBlcm1pc3Npb25zIHx8IFtdO1xuICAgIGlmICghcGVybWlzc2lvbnMuaW5jbHVkZXMocGVybWlzc2lvbikpIHtcbiAgICAgIHBlcm1pc3Npb25zLnB1c2gocGVybWlzc2lvbik7XG4gICAgfVxuICAgIHRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIuYXV0aE1ldGFkYXRhIS5wZXJtaXNzaW9ucyA9IHBlcm1pc3Npb25zO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldFNjb3BlKHNjb3BlOiBzdHJpbmdbXSk6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIHRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIuYXV0aE1ldGFkYXRhIS5zY29wZSA9IHNjb3BlO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldEF1dGhNZXRhZGF0YUZpZWxkKGtleTogc3RyaW5nLCB2YWx1ZTogdW5rbm93bik6IHRoaXMge1xuICAgIHRoaXMuaW5pdEF1dGhNZXRhZGF0YSgpO1xuICAgIHRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIuYXV0aE1ldGFkYXRhIVtrZXldID0gdmFsdWU7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBSZXNwb25zZSBzdGF0dXMgbWFuYWdlbWVudFxuICBwdWJsaWMgc2V0U3VjY2VzcyhzdWNjZXNzOiBib29sZWFuKTogdGhpcyB7XG4gICAgdGhpcy5yZXNwb25zZS5ib2R5LnN1Y2Nlc3MgPSBzdWNjZXNzO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldEVycm9yKGVycm9yOiBFcnJvcik6IHRoaXMge1xuICAgIHRoaXMucmVzcG9uc2UuYm9keS5lcnJvciA9IGVycm9yO1xuICAgIHRoaXMucmVzcG9uc2UuYm9keS5zdWNjZXNzID0gZmFsc2U7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgc2V0QXV0aGVudGljYXRpb25SZXF1aXJlZChyZXF1aXJlZDogYm9vbGVhbik6IHRoaXMge1xuICAgIHRoaXMucmVzcG9uc2UuYm9keS5hdXRoZW50aWNhdGlvblJlcXVpcmVkID0gcmVxdWlyZWQ7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgc2V0QXV0aGVudGljYXRpb25FcnJvcihlcnJvcjogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5yZXNwb25zZS5ib2R5LmF1dGhlbnRpY2F0aW9uRXJyb3IgPSBlcnJvcjtcbiAgICB0aGlzLnJlc3BvbnNlLmJvZHkuc3VjY2VzcyA9IGZhbHNlO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHNldFNlc3Npb25FeHBpcmVkKGV4cGlyZWQ6IGJvb2xlYW4pOiB0aGlzIHtcbiAgICB0aGlzLnJlc3BvbnNlLmJvZHkuc2Vzc2lvbkV4cGlyZWQgPSBleHBpcmVkO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLy8gVGltZXN0YW1wIG1hbmlwdWxhdGlvblxuICBwdWJsaWMgc2V0VGltZXN0YW1wKHRpbWVzdGFtcDogbnVtYmVyKTogdGhpcyB7XG4gICAgdGhpcy5yZXNwb25zZS5yZXNwb25zZUhlYWRlci50aW1lc3RhbXAgPSB0aW1lc3RhbXA7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlVGltZXN0YW1wKCk6IHRoaXMge1xuICAgIHRoaXMucmVzcG9uc2UucmVzcG9uc2VIZWFkZXIudGltZXN0YW1wID0gRGF0ZS5ub3coKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8vIERhdGEgbWFuaXB1bGF0aW9uXG4gIHB1YmxpYyBzZXREYXRhKGRhdGE6IFQpOiB0aGlzIHtcbiAgICB0aGlzLnJlc3BvbnNlLmJvZHkuZGF0YSA9IGRhdGE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlRGF0YSh1cGRhdGVyOiAoZGF0YTogVCkgPT4gVCk6IHRoaXMge1xuICAgIHRoaXMucmVzcG9uc2UuYm9keS5kYXRhID0gdXBkYXRlcih0aGlzLnJlc3BvbnNlLmJvZHkuZGF0YSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyBCdWlsZCBtZXRob2RzXG4gIHB1YmxpYyBidWlsZCgpOiBJUmVzcG9uc2U8VD4ge1xuICAgIHJldHVybiB7IC4uLnRoaXMucmVzcG9uc2UgfTtcbiAgfVxuXG4gIHB1YmxpYyBjbG9uZSgpOiBSZXNwb25zZUJ1aWxkZXI8VD4ge1xuICAgIGNvbnN0IGJ1aWxkZXIgPSBuZXcgUmVzcG9uc2VCdWlsZGVyPFQ+KFxuICAgICAgeyBoZWFkZXI6IHRoaXMucmVzcG9uc2UucmVxdWVzdEhlYWRlciwgYm9keToge30gfSxcbiAgICAgIHRoaXMucmVzcG9uc2UuYm9keS5kYXRhXG4gICAgKTtcbiAgICBidWlsZGVyLnJlc3BvbnNlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLnJlc3BvbnNlKSk7XG4gICAgcmV0dXJuIGJ1aWxkZXI7XG4gIH1cblxuICAvLyBTdGF0aWMgY3JlYXRvcnNcbiAgcHVibGljIHN0YXRpYyBmcm9tPFQ+KHJlc3BvbnNlOiBJUmVzcG9uc2U8VD4pOiBSZXNwb25zZUJ1aWxkZXI8VD4ge1xuICAgIGNvbnN0IGJ1aWxkZXIgPSBuZXcgUmVzcG9uc2VCdWlsZGVyPFQ+KFxuICAgICAgeyBoZWFkZXI6IHJlc3BvbnNlLnJlcXVlc3RIZWFkZXIsIGJvZHk6IHt9IH0sXG4gICAgICByZXNwb25zZS5ib2R5LmRhdGFcbiAgICApO1xuICAgIGJ1aWxkZXIucmVzcG9uc2UgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKSk7XG4gICAgcmV0dXJuIGJ1aWxkZXI7XG4gIH1cblxuICAvLyBDb21tb24gcmVzcG9uc2UgY3JlYXRvcnNcbiAgcHVibGljIHN0YXRpYyBjcmVhdGVTdWNjZXNzPFQ+KFxuICAgIHJlcXVlc3Q6IElSZXF1ZXN0PGFueT4sXG4gICAgcmVzcG9uZGVyQWRkcmVzczogc3RyaW5nLFxuICAgIGRhdGE6IFRcbiAgKTogSVJlc3BvbnNlPFQ+IHtcbiAgICByZXR1cm4gbmV3IFJlc3BvbnNlQnVpbGRlcjxUPihyZXF1ZXN0LCBkYXRhKVxuICAgICAgLnNldFJlc3BvbmRlckFkZHJlc3MocmVzcG9uZGVyQWRkcmVzcylcbiAgICAgIC5zZXRTdWNjZXNzKHRydWUpXG4gICAgICAuYnVpbGQoKTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlRXJyb3I8VD4oXG4gICAgcmVxdWVzdDogSVJlcXVlc3Q8YW55PixcbiAgICByZXNwb25kZXJBZGRyZXNzOiBzdHJpbmcsXG4gICAgZXJyb3I6IEVycm9yXG4gICk6IElSZXNwb25zZTxUPiB7XG4gICAgcmV0dXJuIG5ldyBSZXNwb25zZUJ1aWxkZXI8VD4ocmVxdWVzdCwgbnVsbCBhcyBUKVxuICAgICAgLnNldFJlc3BvbmRlckFkZHJlc3MocmVzcG9uZGVyQWRkcmVzcylcbiAgICAgIC5zZXRFcnJvcihlcnJvcilcbiAgICAgIC5idWlsZCgpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGVBdXRoRXJyb3I8VD4oXG4gICAgcmVxdWVzdDogSVJlcXVlc3Q8YW55PixcbiAgICByZXNwb25kZXJBZGRyZXNzOiBzdHJpbmcsXG4gICAgZXJyb3JNZXNzYWdlOiBzdHJpbmdcbiAgKTogSVJlc3BvbnNlPFQ+IHtcbiAgICByZXR1cm4gbmV3IFJlc3BvbnNlQnVpbGRlcjxUPihyZXF1ZXN0LCBudWxsIGFzIFQpXG4gICAgICAuc2V0UmVzcG9uZGVyQWRkcmVzcyhyZXNwb25kZXJBZGRyZXNzKVxuICAgICAgLnNldEF1dGhlbnRpY2F0aW9uUmVxdWlyZWQodHJ1ZSlcbiAgICAgIC5zZXRBdXRoZW50aWNhdGlvbkVycm9yKGVycm9yTWVzc2FnZSlcbiAgICAgIC5idWlsZCgpO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGVTZXNzaW9uRXhwaXJlZDxUPihcbiAgICByZXF1ZXN0OiBJUmVxdWVzdDxhbnk+LFxuICAgIHJlc3BvbmRlckFkZHJlc3M6IHN0cmluZ1xuICApOiBJUmVzcG9uc2U8VD4ge1xuICAgIHJldHVybiBuZXcgUmVzcG9uc2VCdWlsZGVyPFQ+KHJlcXVlc3QsIG51bGwgYXMgVClcbiAgICAgIC5zZXRSZXNwb25kZXJBZGRyZXNzKHJlc3BvbmRlckFkZHJlc3MpXG4gICAgICAuc2V0U2Vzc2lvbkV4cGlyZWQodHJ1ZSlcbiAgICAgIC5zZXRBdXRoZW50aWNhdGlvblJlcXVpcmVkKHRydWUpXG4gICAgICAuYnVpbGQoKTtcbiAgfVxufVxuIl19