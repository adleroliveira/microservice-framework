"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LogStrategy = exports.LogLevel = void 0;
const uuid_1 = require("uuid");
var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["DEBUG"] = 0] = "DEBUG";
    LogLevel[LogLevel["INFO"] = 1] = "INFO";
    LogLevel[LogLevel["WARN"] = 2] = "WARN";
    LogLevel[LogLevel["ERROR"] = 3] = "ERROR";
})(LogLevel || (exports.LogLevel = LogLevel = {}));
class LogStrategy {
    constructor() { }
    async send(message, options) {
        const truncatedMessage = LogStrategy.truncateAndStringify(message, 0, this.MAX_STRING_LENGTH, this.MAX_DEPTH);
        const packagedMessage = {
            header: this.createRequestHeader(),
            body: truncatedMessage,
        };
        await this.sendPackaged(packagedMessage, options);
    }
    createRequestHeader() {
        return {
            timestamp: Date.now(),
            requestId: (0, uuid_1.v4)(),
            requesterAddress: "log-strategy",
            requestType: "LOG::MESSAGE",
        };
    }
    static truncateAndStringify(value, depth = 0, maxStringLength = 5000, maxDepth = 10) {
        if (depth > maxDepth) {
            return "[Object depth limit exceeded]";
        }
        if (value === undefined || value === null) {
            return value;
        }
        if (typeof value === "string") {
            return value.length > maxStringLength
                ? value.substring(0, maxStringLength) + "..."
                : value;
        }
        if (typeof value === "number" || typeof value === "boolean") {
            return value;
        }
        if (value instanceof Error) {
            return {
                name: value.name,
                message: this.truncateAndStringify(value.message),
                stack: this.truncateAndStringify(value.stack),
            };
        }
        if (this.isBufferOrArrayBufferView(value)) {
            return `[Binary data of length ${value.byteLength}]`;
        }
        if (Array.isArray(value)) {
            return value.map((item) => this.truncateAndStringify(item, depth + 1));
        }
        if (typeof value === "object") {
            const truncatedObject = {};
            for (const [key, prop] of Object.entries(value)) {
                truncatedObject[key] = this.truncateAndStringify(prop, depth + 1);
            }
            return truncatedObject;
        }
        return "[Unserializable data]";
    }
    static isBufferOrArrayBufferView(value) {
        // Check for Buffer in Node.js environment
        if (typeof Buffer !== "undefined" && Buffer.isBuffer(value)) {
            return true;
        }
        // Check for ArrayBuffer view in browser environment
        if (ArrayBuffer.isView(value)) {
            return true;
        }
        // Check if value is an ArrayBuffer
        if (value instanceof ArrayBuffer) {
            return true;
        }
        return false;
    }
}
exports.LogStrategy = LogStrategy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9nU3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbG9nZ2luZy9Mb2dTdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSwrQkFBb0M7QUFFcEMsSUFBWSxRQUtYO0FBTEQsV0FBWSxRQUFRO0lBQ2xCLHlDQUFTLENBQUE7SUFDVCx1Q0FBUSxDQUFBO0lBQ1IsdUNBQVEsQ0FBQTtJQUNSLHlDQUFTLENBQUE7QUFDWCxDQUFDLEVBTFcsUUFBUSx3QkFBUixRQUFRLFFBS25CO0FBZ0NELE1BQXNCLFdBQVc7SUFRL0IsZ0JBQWUsQ0FBQztJQUVoQixLQUFLLENBQUMsSUFBSSxDQUFDLE9BQVksRUFBRSxPQUE2QjtRQUNwRCxNQUFNLGdCQUFnQixHQUFHLFdBQVcsQ0FBQyxvQkFBb0IsQ0FDdkQsT0FBTyxFQUNQLENBQUMsRUFDRCxJQUFJLENBQUMsaUJBQWlCLEVBQ3RCLElBQUksQ0FBQyxTQUFTLENBQ2YsQ0FBQztRQUVGLE1BQU0sZUFBZSxHQUFrQjtZQUNyQyxNQUFNLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixFQUFFO1lBQ2xDLElBQUksRUFBRSxnQkFBZ0I7U0FDdkIsQ0FBQztRQUVGLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVTLG1CQUFtQjtRQUMzQixPQUFPO1lBQ0wsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDckIsU0FBUyxFQUFFLElBQUEsU0FBTSxHQUFFO1lBQ25CLGdCQUFnQixFQUFFLGNBQWM7WUFDaEMsV0FBVyxFQUFFLGNBQWM7U0FDNUIsQ0FBQztJQUNKLENBQUM7SUFFRCxNQUFNLENBQUMsb0JBQW9CLENBQ3pCLEtBQVUsRUFDVixRQUFnQixDQUFDLEVBQ2pCLGVBQWUsR0FBRyxJQUFJLEVBQ3RCLFFBQVEsR0FBRyxFQUFFO1FBRWIsSUFBSSxLQUFLLEdBQUcsUUFBUSxFQUFFLENBQUM7WUFDckIsT0FBTywrQkFBK0IsQ0FBQztRQUN6QyxDQUFDO1FBRUQsSUFBSSxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssS0FBSyxJQUFJLEVBQUUsQ0FBQztZQUMxQyxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7UUFFRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzlCLE9BQU8sS0FBSyxDQUFDLE1BQU0sR0FBRyxlQUFlO2dCQUNuQyxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsZUFBZSxDQUFDLEdBQUcsS0FBSztnQkFDN0MsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNaLENBQUM7UUFFRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxPQUFPLEtBQUssS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUM1RCxPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7UUFFRCxJQUFJLEtBQUssWUFBWSxLQUFLLEVBQUUsQ0FBQztZQUMzQixPQUFPO2dCQUNMLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSTtnQkFDaEIsT0FBTyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO2dCQUNqRCxLQUFLLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7YUFDOUMsQ0FBQztRQUNKLENBQUM7UUFFRCxJQUFJLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzFDLE9BQU8sMEJBQTBCLEtBQUssQ0FBQyxVQUFVLEdBQUcsQ0FBQztRQUN2RCxDQUFDO1FBRUQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDekIsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pFLENBQUM7UUFFRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzlCLE1BQU0sZUFBZSxHQUEyQixFQUFFLENBQUM7WUFDbkQsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDaEQsZUFBZSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLENBQUM7WUFDRCxPQUFPLGVBQWUsQ0FBQztRQUN6QixDQUFDO1FBRUQsT0FBTyx1QkFBdUIsQ0FBQztJQUNqQyxDQUFDO0lBRU8sTUFBTSxDQUFDLHlCQUF5QixDQUFDLEtBQVU7UUFDakQsMENBQTBDO1FBQzFDLElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUM1RCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxvREFBb0Q7UUFDcEQsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDOUIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsbUNBQW1DO1FBQ25DLElBQUksS0FBSyxZQUFZLFdBQVcsRUFBRSxDQUFDO1lBQ2pDLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGO0FBeEdELGtDQXdHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElSZXF1ZXN0LCBJUmVxdWVzdEhlYWRlciB9IGZyb20gXCIuLi9pbnRlcmZhY2VzXCI7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tIFwidXVpZFwiO1xuXG5leHBvcnQgZW51bSBMb2dMZXZlbCB7XG4gIERFQlVHID0gMCxcbiAgSU5GTyA9IDEsXG4gIFdBUk4gPSAyLFxuICBFUlJPUiA9IDMsXG59XG5cbi8qKlxuICogVHlwZSByZXByZXNlbnRpbmcgdGhlIHBheWxvYWQgdHlwZSBvZiBhIGxvZyBtZXNzYWdlLlxuICovXG5leHBvcnQgdHlwZSBQYXlsb2FkVHlwZSA9IFwidGV4dFwiIHwgXCJqc29uXCI7XG5cbi8qKlxuICogSW50ZXJmYWNlIHJlcHJlc2VudGluZyB0aGUgcGF5bG9hZCBvZiBhIGxvZyBtZXNzYWdlLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIExvZ1BheWxvYWQge1xuICAvKiogVGhlIHR5cGUgb2YgdGhlIHBheWxvYWQuICovXG4gIHR5cGU6IFBheWxvYWRUeXBlO1xuICAvKiogVGhlIGNvbnRlbnQgb2YgdGhlIHBheWxvYWQuICovXG4gIGNvbnRlbnQ6IHN0cmluZyB8IG9iamVjdDtcbn1cblxuLyoqXG4gKiBJbnRlcmZhY2UgcmVwcmVzZW50aW5nIGEgbG9nIG1lc3NhZ2UuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTG9nTWVzc2FnZSB7XG4gIHNlbmRlcj86IHN0cmluZztcbiAgLyoqIFRoZSB0aW1lc3RhbXAgb2YgdGhlIGxvZyBtZXNzYWdlLiAqL1xuICB0aW1lc3RhbXA6IHN0cmluZztcbiAgLyoqIFRoZSBsb2cgbGV2ZWwgb2YgdGhlIG1lc3NhZ2UuICovXG4gIGxldmVsOiBzdHJpbmc7XG4gIC8qKiBUaGUgY29udGVudCBvZiB0aGUgbG9nIG1lc3NhZ2UuICovXG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgLyoqIE9wdGlvbmFsIHBheWxvYWQgZm9yIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uICovXG4gIHBheWxvYWQ/OiBMb2dQYXlsb2FkO1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgTG9nU3RyYXRlZ3kge1xuICBwcm90ZWN0ZWQgTUFYX1NUUklOR19MRU5HVEg/OiBudW1iZXI7XG4gIHByb3RlY3RlZCBNQVhfREVQVEg/OiBudW1iZXI7XG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZW5kUGFja2FnZWQoXG4gICAgcGFja2FnZWRNZXNzYWdlOiBJUmVxdWVzdDxhbnk+LFxuICAgIG9wdGlvbnM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICk6IFByb21pc2U8dm9pZD47XG5cbiAgY29uc3RydWN0b3IoKSB7fVxuXG4gIGFzeW5jIHNlbmQobWVzc2FnZTogYW55LCBvcHRpb25zPzogUmVjb3JkPHN0cmluZywgYW55Pik6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHRydW5jYXRlZE1lc3NhZ2UgPSBMb2dTdHJhdGVneS50cnVuY2F0ZUFuZFN0cmluZ2lmeShcbiAgICAgIG1lc3NhZ2UsXG4gICAgICAwLFxuICAgICAgdGhpcy5NQVhfU1RSSU5HX0xFTkdUSCxcbiAgICAgIHRoaXMuTUFYX0RFUFRIXG4gICAgKTtcblxuICAgIGNvbnN0IHBhY2thZ2VkTWVzc2FnZTogSVJlcXVlc3Q8YW55PiA9IHtcbiAgICAgIGhlYWRlcjogdGhpcy5jcmVhdGVSZXF1ZXN0SGVhZGVyKCksXG4gICAgICBib2R5OiB0cnVuY2F0ZWRNZXNzYWdlLFxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLnNlbmRQYWNrYWdlZChwYWNrYWdlZE1lc3NhZ2UsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZVJlcXVlc3RIZWFkZXIoKTogSVJlcXVlc3RIZWFkZXIge1xuICAgIHJldHVybiB7XG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICByZXF1ZXN0SWQ6IHV1aWR2NCgpLFxuICAgICAgcmVxdWVzdGVyQWRkcmVzczogXCJsb2ctc3RyYXRlZ3lcIixcbiAgICAgIHJlcXVlc3RUeXBlOiBcIkxPRzo6TUVTU0FHRVwiLFxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgdHJ1bmNhdGVBbmRTdHJpbmdpZnkoXG4gICAgdmFsdWU6IGFueSxcbiAgICBkZXB0aDogbnVtYmVyID0gMCxcbiAgICBtYXhTdHJpbmdMZW5ndGggPSA1MDAwLFxuICAgIG1heERlcHRoID0gMTBcbiAgKTogYW55IHtcbiAgICBpZiAoZGVwdGggPiBtYXhEZXB0aCkge1xuICAgICAgcmV0dXJuIFwiW09iamVjdCBkZXB0aCBsaW1pdCBleGNlZWRlZF1cIjtcbiAgICB9XG5cbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB2YWx1ZS5sZW5ndGggPiBtYXhTdHJpbmdMZW5ndGhcbiAgICAgICAgPyB2YWx1ZS5zdWJzdHJpbmcoMCwgbWF4U3RyaW5nTGVuZ3RoKSArIFwiLi4uXCJcbiAgICAgICAgOiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcIm51bWJlclwiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gXCJib29sZWFuXCIpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogdmFsdWUubmFtZSxcbiAgICAgICAgbWVzc2FnZTogdGhpcy50cnVuY2F0ZUFuZFN0cmluZ2lmeSh2YWx1ZS5tZXNzYWdlKSxcbiAgICAgICAgc3RhY2s6IHRoaXMudHJ1bmNhdGVBbmRTdHJpbmdpZnkodmFsdWUuc3RhY2spLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0J1ZmZlck9yQXJyYXlCdWZmZXJWaWV3KHZhbHVlKSkge1xuICAgICAgcmV0dXJuIGBbQmluYXJ5IGRhdGEgb2YgbGVuZ3RoICR7dmFsdWUuYnl0ZUxlbmd0aH1dYDtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB2YWx1ZS5tYXAoKGl0ZW0pID0+IHRoaXMudHJ1bmNhdGVBbmRTdHJpbmdpZnkoaXRlbSwgZGVwdGggKyAxKSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgY29uc3QgdHJ1bmNhdGVkT2JqZWN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHByb3BdIG9mIE9iamVjdC5lbnRyaWVzKHZhbHVlKSkge1xuICAgICAgICB0cnVuY2F0ZWRPYmplY3Rba2V5XSA9IHRoaXMudHJ1bmNhdGVBbmRTdHJpbmdpZnkocHJvcCwgZGVwdGggKyAxKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVuY2F0ZWRPYmplY3Q7XG4gICAgfVxuXG4gICAgcmV0dXJuIFwiW1Vuc2VyaWFsaXphYmxlIGRhdGFdXCI7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBpc0J1ZmZlck9yQXJyYXlCdWZmZXJWaWV3KHZhbHVlOiBhbnkpOiBib29sZWFuIHtcbiAgICAvLyBDaGVjayBmb3IgQnVmZmVyIGluIE5vZGUuanMgZW52aXJvbm1lbnRcbiAgICBpZiAodHlwZW9mIEJ1ZmZlciAhPT0gXCJ1bmRlZmluZWRcIiAmJiBCdWZmZXIuaXNCdWZmZXIodmFsdWUpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgQXJyYXlCdWZmZXIgdmlldyBpbiBicm93c2VyIGVudmlyb25tZW50XG4gICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHZhbHVlIGlzIGFuIEFycmF5QnVmZmVyXG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuIl19