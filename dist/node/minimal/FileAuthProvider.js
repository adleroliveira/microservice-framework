"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileAuthProvider = void 0;
const FileStore_1 = require("./FileStore");
const utils_1 = require("src/utils");
class FileAuthProvider {
    constructor(dataDir = "./.auth-data") {
        this.users = new Map();
        this.tokens = new Map();
        this.store = new FileStore_1.FileStore(dataDir);
    }
    async initialize() {
        await this.store.initialize();
        // Load users from file
        const userData = await this.store.read("users");
        if (userData) {
            userData.users.forEach((user) => {
                this.users.set(user.username, user);
            });
        }
        // Load tokens from file
        const tokenData = await this.store.read("tokens");
        if (tokenData) {
            tokenData.tokens.forEach(([token, data]) => {
                this.tokens.set(token, {
                    ...data,
                    expiresAt: new Date(data.expiresAt),
                });
            });
        }
    }
    async persistUsers() {
        await this.store.write("users", {
            users: Array.from(this.users.values()),
        });
    }
    async persistTokens() {
        await this.store.write("tokens", {
            tokens: Array.from(this.tokens.entries()).map(([token, data]) => [
                token,
                {
                    ...data,
                    expiresAt: data.expiresAt.toISOString(),
                },
            ]),
        });
    }
    async addUser(username, password) {
        const userId = utils_1.CryptoUtil.generateToken().slice(0, 8);
        const passwordHash = await utils_1.CryptoUtil.hashPassword(password);
        this.users.set(username, {
            userId,
            username,
            passwordHash,
        });
        await this.persistUsers();
        return userId;
    }
    async authenticate(credentials) {
        const user = this.users.get(credentials.username);
        if (!user) {
            return { success: false, error: "User not found" };
        }
        const passwordHash = await utils_1.CryptoUtil.hashPassword(credentials.password);
        if (passwordHash !== user.passwordHash) {
            return { success: false, error: "Invalid password" };
        }
        const token = utils_1.CryptoUtil.generateToken();
        const refreshToken = utils_1.CryptoUtil.generateToken();
        const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
        this.tokens.set(token, {
            userId: user.userId,
            expiresAt,
            refreshToken,
        });
        await this.persistTokens();
        return {
            success: true,
            userId: user.userId,
            token,
            refreshToken,
            expiresAt,
            metadata: user.metadata,
        };
    }
    async validateToken(token) {
        const tokenData = this.tokens.get(token);
        if (!tokenData) {
            return { success: false, error: "Invalid token" };
        }
        if (tokenData.expiresAt < new Date()) {
            this.tokens.delete(token);
            await this.persistTokens();
            return { success: false, error: "Token expired" };
        }
        return {
            success: true,
            userId: tokenData.userId,
            token,
            expiresAt: tokenData.expiresAt,
        };
    }
    async refreshToken(refreshToken) {
        const tokenEntry = Array.from(this.tokens.entries()).find(([_, data]) => data.refreshToken === refreshToken);
        if (!tokenEntry) {
            return { success: false, error: "Invalid refresh token" };
        }
        const newToken = utils_1.CryptoUtil.generateToken();
        const newRefreshToken = utils_1.CryptoUtil.generateToken();
        const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
        this.tokens.delete(tokenEntry[0]);
        this.tokens.set(newToken, {
            userId: tokenEntry[1].userId,
            expiresAt,
            refreshToken: newRefreshToken,
        });
        await this.persistTokens();
        return {
            success: true,
            userId: tokenEntry[1].userId,
            token: newToken,
            refreshToken: newRefreshToken,
            expiresAt,
        };
    }
}
exports.FileAuthProvider = FileAuthProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmlsZUF1dGhQcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9taW5pbWFsL0ZpbGVBdXRoUHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBS0EsMkNBQXdDO0FBQ3hDLHFDQUF1QztBQUV2QyxNQUFhLGdCQUFnQjtJQVkzQixZQUFZLFVBQWtCLGNBQWM7UUFWcEMsVUFBSyxHQUE4QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzdDLFdBQU0sR0FPVixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBR1osSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLHFCQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVO1FBQ2QsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRTlCLHVCQUF1QjtRQUN2QixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUVuQyxPQUFPLENBQUMsQ0FBQztRQUVaLElBQUksUUFBUSxFQUFFLENBQUM7WUFDYixRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3RDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELHdCQUF3QjtRQUN4QixNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQVdwQyxRQUFRLENBQUMsQ0FBQztRQUViLElBQUksU0FBUyxFQUFFLENBQUM7WUFDZCxTQUFTLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ3pDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRTtvQkFDckIsR0FBRyxJQUFJO29CQUNQLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2lCQUNwQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7SUFDSCxDQUFDO0lBRU8sS0FBSyxDQUFDLFlBQVk7UUFDeEIsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDOUIsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUN2QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sS0FBSyxDQUFDLGFBQWE7UUFDekIsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFDL0IsTUFBTSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDL0QsS0FBSztnQkFDTDtvQkFDRSxHQUFHLElBQUk7b0JBQ1AsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFO2lCQUN4QzthQUNGLENBQUM7U0FDSCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFnQixFQUFFLFFBQWdCO1FBQzlDLE1BQU0sTUFBTSxHQUFHLGtCQUFVLENBQUMsYUFBYSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN0RCxNQUFNLFlBQVksR0FBRyxNQUFNLGtCQUFVLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTdELElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUN2QixNQUFNO1lBQ04sUUFBUTtZQUNSLFlBQVk7U0FDYixDQUFDLENBQUM7UUFFSCxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxQixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBQyxXQUdsQjtRQUNDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVixPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQztRQUNyRCxDQUFDO1FBRUQsTUFBTSxZQUFZLEdBQUcsTUFBTSxrQkFBVSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekUsSUFBSSxZQUFZLEtBQUssSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3ZDLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxrQkFBa0IsRUFBRSxDQUFDO1FBQ3ZELENBQUM7UUFFRCxNQUFNLEtBQUssR0FBRyxrQkFBVSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3pDLE1BQU0sWUFBWSxHQUFHLGtCQUFVLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDaEQsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRTdELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRTtZQUNyQixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsU0FBUztZQUNULFlBQVk7U0FDYixDQUFDLENBQUM7UUFFSCxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUUzQixPQUFPO1lBQ0wsT0FBTyxFQUFFLElBQUk7WUFDYixNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsS0FBSztZQUNMLFlBQVk7WUFDWixTQUFTO1lBQ1QsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1NBQ3hCLENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFhO1FBQy9CLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNmLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsQ0FBQztRQUNwRCxDQUFDO1FBRUQsSUFBSSxTQUFTLENBQUMsU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMxQixNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUMzQixPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLENBQUM7UUFDcEQsQ0FBQztRQUVELE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSTtZQUNiLE1BQU0sRUFBRSxTQUFTLENBQUMsTUFBTTtZQUN4QixLQUFLO1lBQ0wsU0FBUyxFQUFFLFNBQVMsQ0FBQyxTQUFTO1NBQy9CLENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVksQ0FBQyxZQUFvQjtRQUNyQyxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQ3ZELENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEtBQUssWUFBWSxDQUNsRCxDQUFDO1FBRUYsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2hCLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxDQUFDO1FBQzVELENBQUM7UUFFRCxNQUFNLFFBQVEsR0FBRyxrQkFBVSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQzVDLE1BQU0sZUFBZSxHQUFHLGtCQUFVLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDbkQsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1FBRTdELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUN4QixNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU07WUFDNUIsU0FBUztZQUNULFlBQVksRUFBRSxlQUFlO1NBQzlCLENBQUMsQ0FBQztRQUVILE1BQU0sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRTNCLE9BQU87WUFDTCxPQUFPLEVBQUUsSUFBSTtZQUNiLE1BQU0sRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTTtZQUM1QixLQUFLLEVBQUUsUUFBUTtZQUNmLFlBQVksRUFBRSxlQUFlO1lBQzdCLFNBQVM7U0FDVixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBNUtELDRDQTRLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIElBdXRoZW50aWNhdGlvblByb3ZpZGVyLFxuICBJbk1lbW9yeVVzZXIsXG4gIElBdXRoZW50aWNhdGlvblJlc3VsdCxcbn0gZnJvbSBcIi4uL2ludGVyZmFjZXNcIjtcbmltcG9ydCB7IEZpbGVTdG9yZSB9IGZyb20gXCIuL0ZpbGVTdG9yZVwiO1xuaW1wb3J0IHsgQ3J5cHRvVXRpbCB9IGZyb20gXCJzcmMvdXRpbHNcIjtcblxuZXhwb3J0IGNsYXNzIEZpbGVBdXRoUHJvdmlkZXIgaW1wbGVtZW50cyBJQXV0aGVudGljYXRpb25Qcm92aWRlciB7XG4gIHByaXZhdGUgc3RvcmU6IEZpbGVTdG9yZTtcbiAgcHJpdmF0ZSB1c2VyczogTWFwPHN0cmluZywgSW5NZW1vcnlVc2VyPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSB0b2tlbnM6IE1hcDxcbiAgICBzdHJpbmcsXG4gICAge1xuICAgICAgdXNlcklkOiBzdHJpbmc7XG4gICAgICBleHBpcmVzQXQ6IERhdGU7XG4gICAgICByZWZyZXNoVG9rZW4/OiBzdHJpbmc7XG4gICAgfVxuICA+ID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKGRhdGFEaXI6IHN0cmluZyA9IFwiLi8uYXV0aC1kYXRhXCIpIHtcbiAgICB0aGlzLnN0b3JlID0gbmV3IEZpbGVTdG9yZShkYXRhRGlyKTtcbiAgfVxuXG4gIGFzeW5jIGluaXRpYWxpemUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zdG9yZS5pbml0aWFsaXplKCk7XG5cbiAgICAvLyBMb2FkIHVzZXJzIGZyb20gZmlsZVxuICAgIGNvbnN0IHVzZXJEYXRhID0gYXdhaXQgdGhpcy5zdG9yZS5yZWFkPHtcbiAgICAgIHVzZXJzOiBJbk1lbW9yeVVzZXJbXTtcbiAgICB9PihcInVzZXJzXCIpO1xuXG4gICAgaWYgKHVzZXJEYXRhKSB7XG4gICAgICB1c2VyRGF0YS51c2Vycy5mb3JFYWNoKCh1c2VyKSA9PiB7XG4gICAgICAgIHRoaXMudXNlcnMuc2V0KHVzZXIudXNlcm5hbWUsIHVzZXIpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gTG9hZCB0b2tlbnMgZnJvbSBmaWxlXG4gICAgY29uc3QgdG9rZW5EYXRhID0gYXdhaXQgdGhpcy5zdG9yZS5yZWFkPHtcbiAgICAgIHRva2VuczogQXJyYXk8XG4gICAgICAgIFtcbiAgICAgICAgICBzdHJpbmcsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlcklkOiBzdHJpbmc7XG4gICAgICAgICAgICBleHBpcmVzQXQ6IHN0cmluZztcbiAgICAgICAgICAgIHJlZnJlc2hUb2tlbj86IHN0cmluZztcbiAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgID47XG4gICAgfT4oXCJ0b2tlbnNcIik7XG5cbiAgICBpZiAodG9rZW5EYXRhKSB7XG4gICAgICB0b2tlbkRhdGEudG9rZW5zLmZvckVhY2goKFt0b2tlbiwgZGF0YV0pID0+IHtcbiAgICAgICAgdGhpcy50b2tlbnMuc2V0KHRva2VuLCB7XG4gICAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgICBleHBpcmVzQXQ6IG5ldyBEYXRlKGRhdGEuZXhwaXJlc0F0KSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHBlcnNpc3RVc2VycygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnN0b3JlLndyaXRlKFwidXNlcnNcIiwge1xuICAgICAgdXNlcnM6IEFycmF5LmZyb20odGhpcy51c2Vycy52YWx1ZXMoKSksXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHBlcnNpc3RUb2tlbnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zdG9yZS53cml0ZShcInRva2Vuc1wiLCB7XG4gICAgICB0b2tlbnM6IEFycmF5LmZyb20odGhpcy50b2tlbnMuZW50cmllcygpKS5tYXAoKFt0b2tlbiwgZGF0YV0pID0+IFtcbiAgICAgICAgdG9rZW4sXG4gICAgICAgIHtcbiAgICAgICAgICAuLi5kYXRhLFxuICAgICAgICAgIGV4cGlyZXNBdDogZGF0YS5leHBpcmVzQXQudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSxcbiAgICAgIF0pLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgYWRkVXNlcih1c2VybmFtZTogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB1c2VySWQgPSBDcnlwdG9VdGlsLmdlbmVyYXRlVG9rZW4oKS5zbGljZSgwLCA4KTtcbiAgICBjb25zdCBwYXNzd29yZEhhc2ggPSBhd2FpdCBDcnlwdG9VdGlsLmhhc2hQYXNzd29yZChwYXNzd29yZCk7XG5cbiAgICB0aGlzLnVzZXJzLnNldCh1c2VybmFtZSwge1xuICAgICAgdXNlcklkLFxuICAgICAgdXNlcm5hbWUsXG4gICAgICBwYXNzd29yZEhhc2gsXG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLnBlcnNpc3RVc2VycygpO1xuICAgIHJldHVybiB1c2VySWQ7XG4gIH1cblxuICBhc3luYyBhdXRoZW50aWNhdGUoY3JlZGVudGlhbHM6IHtcbiAgICB1c2VybmFtZTogc3RyaW5nO1xuICAgIHBhc3N3b3JkOiBzdHJpbmc7XG4gIH0pOiBQcm9taXNlPElBdXRoZW50aWNhdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IHVzZXIgPSB0aGlzLnVzZXJzLmdldChjcmVkZW50aWFscy51c2VybmFtZSk7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiVXNlciBub3QgZm91bmRcIiB9O1xuICAgIH1cblxuICAgIGNvbnN0IHBhc3N3b3JkSGFzaCA9IGF3YWl0IENyeXB0b1V0aWwuaGFzaFBhc3N3b3JkKGNyZWRlbnRpYWxzLnBhc3N3b3JkKTtcbiAgICBpZiAocGFzc3dvcmRIYXNoICE9PSB1c2VyLnBhc3N3b3JkSGFzaCkge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBcIkludmFsaWQgcGFzc3dvcmRcIiB9O1xuICAgIH1cblxuICAgIGNvbnN0IHRva2VuID0gQ3J5cHRvVXRpbC5nZW5lcmF0ZVRva2VuKCk7XG4gICAgY29uc3QgcmVmcmVzaFRva2VuID0gQ3J5cHRvVXRpbC5nZW5lcmF0ZVRva2VuKCk7XG4gICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuXG4gICAgdGhpcy50b2tlbnMuc2V0KHRva2VuLCB7XG4gICAgICB1c2VySWQ6IHVzZXIudXNlcklkLFxuICAgICAgZXhwaXJlc0F0LFxuICAgICAgcmVmcmVzaFRva2VuLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgdGhpcy5wZXJzaXN0VG9rZW5zKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHVzZXJJZDogdXNlci51c2VySWQsXG4gICAgICB0b2tlbixcbiAgICAgIHJlZnJlc2hUb2tlbixcbiAgICAgIGV4cGlyZXNBdCxcbiAgICAgIG1ldGFkYXRhOiB1c2VyLm1ldGFkYXRhLFxuICAgIH07XG4gIH1cblxuICBhc3luYyB2YWxpZGF0ZVRva2VuKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPElBdXRoZW50aWNhdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IHRva2VuRGF0YSA9IHRoaXMudG9rZW5zLmdldCh0b2tlbik7XG4gICAgaWYgKCF0b2tlbkRhdGEpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogXCJJbnZhbGlkIHRva2VuXCIgfTtcbiAgICB9XG5cbiAgICBpZiAodG9rZW5EYXRhLmV4cGlyZXNBdCA8IG5ldyBEYXRlKCkpIHtcbiAgICAgIHRoaXMudG9rZW5zLmRlbGV0ZSh0b2tlbik7XG4gICAgICBhd2FpdCB0aGlzLnBlcnNpc3RUb2tlbnMoKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogXCJUb2tlbiBleHBpcmVkXCIgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHVzZXJJZDogdG9rZW5EYXRhLnVzZXJJZCxcbiAgICAgIHRva2VuLFxuICAgICAgZXhwaXJlc0F0OiB0b2tlbkRhdGEuZXhwaXJlc0F0LFxuICAgIH07XG4gIH1cblxuICBhc3luYyByZWZyZXNoVG9rZW4ocmVmcmVzaFRva2VuOiBzdHJpbmcpOiBQcm9taXNlPElBdXRoZW50aWNhdGlvblJlc3VsdD4ge1xuICAgIGNvbnN0IHRva2VuRW50cnkgPSBBcnJheS5mcm9tKHRoaXMudG9rZW5zLmVudHJpZXMoKSkuZmluZChcbiAgICAgIChbXywgZGF0YV0pID0+IGRhdGEucmVmcmVzaFRva2VuID09PSByZWZyZXNoVG9rZW5cbiAgICApO1xuXG4gICAgaWYgKCF0b2tlbkVudHJ5KSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiSW52YWxpZCByZWZyZXNoIHRva2VuXCIgfTtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdUb2tlbiA9IENyeXB0b1V0aWwuZ2VuZXJhdGVUb2tlbigpO1xuICAgIGNvbnN0IG5ld1JlZnJlc2hUb2tlbiA9IENyeXB0b1V0aWwuZ2VuZXJhdGVUb2tlbigpO1xuICAgIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKERhdGUubm93KCkgKyAyNCAqIDYwICogNjAgKiAxMDAwKTtcblxuICAgIHRoaXMudG9rZW5zLmRlbGV0ZSh0b2tlbkVudHJ5WzBdKTtcbiAgICB0aGlzLnRva2Vucy5zZXQobmV3VG9rZW4sIHtcbiAgICAgIHVzZXJJZDogdG9rZW5FbnRyeVsxXS51c2VySWQsXG4gICAgICBleHBpcmVzQXQsXG4gICAgICByZWZyZXNoVG9rZW46IG5ld1JlZnJlc2hUb2tlbixcbiAgICB9KTtcblxuICAgIGF3YWl0IHRoaXMucGVyc2lzdFRva2VucygpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICB1c2VySWQ6IHRva2VuRW50cnlbMV0udXNlcklkLFxuICAgICAgdG9rZW46IG5ld1Rva2VuLFxuICAgICAgcmVmcmVzaFRva2VuOiBuZXdSZWZyZXNoVG9rZW4sXG4gICAgICBleHBpcmVzQXQsXG4gICAgfTtcbiAgfVxufVxuIl19