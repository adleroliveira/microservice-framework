"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileAuthProvider = void 0;
const FileStore_1 = require("./FileStore");
const utils_1 = require("../utils");
const logging_1 = require("../logging");
class FileAuthProvider extends logging_1.Loggable {
    constructor(dataDir = "./.auth-data", cleanupIntervalMs = 60000 * 15 // 15 minutes
    ) {
        super();
        this.users = new Map();
        this.tokens = new Map();
        this.store = new FileStore_1.FileStore(dataDir);
        this.cleanupInterval = setInterval(() => {
            this.cleanupExpiredTokens();
        }, cleanupIntervalMs);
    }
    async initialize() {
        await this.store.initialize();
        await this.loadUsers();
        await this.loadTokens();
        await this.performInitialCleanup();
    }
    async performInitialCleanup() {
        const now = new Date();
        let tokensChanged = false;
        let usersChanged = false;
        // Step 1: Clean up expired and unused tokens
        for (const [token, data] of this.tokens.entries()) {
            const unusedThreshold = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            if (data.expiresAt < now || data.lastUsed < unusedThreshold) {
                this.tokens.delete(token);
                tokensChanged = true;
            }
        }
        // Step 2: Clean up tokens with non-existent users (orphaned tokens)
        const validUserIds = new Set(Array.from(this.users.values()).map(u => u.userId));
        for (const [token, data] of this.tokens.entries()) {
            if (!validUserIds.has(data.userId)) {
                this.tokens.delete(token);
                tokensChanged = true;
            }
        }
        // Step 3: Clean up duplicate user tokens (keep only the most recent)
        const userTokens = new Map();
        for (const [token, data] of this.tokens.entries()) {
            const existing = userTokens.get(data.userId);
            if (!existing || existing.lastUsed < data.lastUsed) {
                if (existing) {
                    this.tokens.delete(existing.token);
                    tokensChanged = true;
                }
                userTokens.set(data.userId, { token, lastUsed: data.lastUsed });
            }
            else {
                this.tokens.delete(token);
                tokensChanged = true;
            }
        }
        // Persist changes if needed
        if (tokensChanged) {
            await this.persistTokens();
        }
        if (usersChanged) {
            await this.persistUsers();
        }
        this.info(`Initial cleanup completed. Tokens cleaned: ${tokensChanged}`);
    }
    async loadUsers() {
        const userData = await this.store.read("users");
        if (userData) {
            userData.users.forEach((user) => {
                this.users.set(user.username.toLowerCase(), user);
            });
        }
    }
    async loadTokens() {
        const tokenData = await this.store.read("tokens");
        if (tokenData) {
            tokenData.tokens.forEach(([token, data]) => {
                this.tokens.set(token, {
                    ...data,
                    expiresAt: new Date(data.expiresAt),
                    lastUsed: new Date(data.lastUsed),
                });
            });
        }
    }
    async persistUsers() {
        await this.store.write("users", {
            users: Array.from(this.users.values()),
        });
    }
    async persistTokens() {
        await this.store.write("tokens", {
            tokens: Array.from(this.tokens.entries()).map(([token, data]) => [
                token,
                {
                    ...data,
                    expiresAt: data.expiresAt.toISOString(),
                    lastUsed: data.lastUsed.toISOString(),
                },
            ]),
        });
    }
    async addUser(username, password, metadata) {
        if (!username || !password) {
            return { success: false, error: "Username and password are required" };
        }
        const normalizedUsername = username.toLowerCase();
        if (this.users.has(normalizedUsername)) {
            return { success: false, error: "Username already exists" };
        }
        if (password.length < 6) {
            return { success: false, error: "Password must be at least 6 characters" };
        }
        const userId = utils_1.CryptoUtil.generateToken().slice(0, 8);
        const passwordHash = await utils_1.CryptoUtil.hashPassword(password);
        const newUser = {
            userId,
            username: normalizedUsername,
            passwordHash,
            metadata,
            createdAt: new Date(),
        };
        this.users.set(normalizedUsername, newUser);
        await this.persistUsers();
        // Automatically authenticate the new user
        return this.authenticate({ username, password });
    }
    async authenticate(credentials) {
        if (!credentials.username || !credentials.password) {
            return { success: false, error: "Username and password are required" };
        }
        const normalizedUsername = credentials.username.toLowerCase();
        const user = this.users.get(normalizedUsername);
        if (!user) {
            return { success: false, error: "Invalid credentials" };
        }
        const passwordHash = await utils_1.CryptoUtil.hashPassword(credentials.password);
        if (passwordHash !== user.passwordHash) {
            return { success: false, error: "Invalid credentials" };
        }
        // Cleanup old tokens for this user
        await this.cleanupUserTokens(user.userId);
        const token = utils_1.CryptoUtil.generateToken();
        const refreshToken = utils_1.CryptoUtil.generateToken();
        const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours
        this.tokens.set(token, {
            userId: user.userId,
            expiresAt,
            refreshToken,
            lastUsed: new Date(),
        });
        await this.persistTokens();
        return {
            success: true,
            userId: user.userId,
            username: user.username,
            token,
            refreshToken,
            expiresAt,
            metadata: user.metadata,
        };
    }
    async validateToken(token) {
        if (!token) {
            return { success: false, error: "Token is required" };
        }
        const tokenData = this.tokens.get(token);
        if (!tokenData) {
            return { success: false, error: "Invalid token" };
        }
        if (tokenData.expiresAt < new Date()) {
            this.tokens.delete(token);
            await this.persistTokens();
            return { success: false, error: "Token expired" };
        }
        // Update last used timestamp
        tokenData.lastUsed = new Date();
        await this.persistTokens();
        const user = Array.from(this.users.values()).find((u) => u.userId === tokenData.userId);
        if (!user) {
            return { success: false, error: "User not found" };
        }
        return {
            success: true,
            userId: tokenData.userId,
            username: user.username,
            token,
            expiresAt: tokenData.expiresAt,
            metadata: user.metadata,
        };
    }
    async refreshToken(refreshToken) {
        if (!refreshToken) {
            return { success: false, error: "Refresh token is required" };
        }
        const tokenEntry = Array.from(this.tokens.entries()).find(([_, data]) => data.refreshToken === refreshToken);
        if (!tokenEntry) {
            return { success: false, error: "Invalid refresh token" };
        }
        const user = Array.from(this.users.values()).find((u) => u.userId === tokenEntry[1].userId);
        if (!user) {
            return { success: false, error: "User not found" };
        }
        const newToken = utils_1.CryptoUtil.generateToken();
        const newRefreshToken = utils_1.CryptoUtil.generateToken();
        const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000);
        // Remove old token
        this.tokens.delete(tokenEntry[0]);
        // Set new token
        this.tokens.set(newToken, {
            userId: tokenEntry[1].userId,
            expiresAt,
            refreshToken: newRefreshToken,
            lastUsed: new Date(),
        });
        await this.persistTokens();
        return {
            success: true,
            userId: tokenEntry[1].userId,
            username: user.username,
            token: newToken,
            refreshToken: newRefreshToken,
            expiresAt,
            metadata: user.metadata,
        };
    }
    async cleanupUserTokens(userId) {
        let changed = false;
        for (const [token, data] of this.tokens.entries()) {
            if (data.userId === userId) {
                this.tokens.delete(token);
                changed = true;
            }
        }
        if (changed) {
            await this.persistTokens();
        }
    }
    async cleanupExpiredTokens() {
        const now = new Date();
        let changed = false;
        for (const [token, data] of this.tokens.entries()) {
            // Remove tokens that are expired or haven't been used in 7 days
            const unusedThreshold = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            if (data.expiresAt < now || data.lastUsed < unusedThreshold) {
                this.tokens.delete(token);
                changed = true;
            }
        }
        if (changed) {
            await this.persistTokens();
        }
    }
    destroy() {
        clearInterval(this.cleanupInterval);
    }
}
exports.FileAuthProvider = FileAuthProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmlsZUF1dGhQcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9taW5pbWFsL0ZpbGVBdXRoUHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBS0EsMkNBQXdDO0FBQ3hDLG9DQUFzQztBQUN0Qyx3Q0FBc0M7QUFTdEMsTUFBYSxnQkFBaUIsU0FBUSxrQkFBUTtJQU01QyxZQUNFLFVBQWtCLGNBQWMsRUFDaEMsb0JBQTRCLEtBQUssR0FBRyxFQUFFLENBQUMsYUFBYTs7UUFFcEQsS0FBSyxFQUFFLENBQUM7UUFSRixVQUFLLEdBQThCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDN0MsV0FBTSxHQUEyQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBUWpELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxxQkFBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxlQUFlLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUN0QyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUM5QixDQUFDLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztJQUN4QixDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVU7UUFDZCxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDOUIsTUFBTSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDdkIsTUFBTSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFeEIsTUFBTSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBRU8sS0FBSyxDQUFDLHFCQUFxQjtRQUNqQyxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3ZCLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMxQixJQUFJLFlBQVksR0FBRyxLQUFLLENBQUM7UUFFekIsNkNBQTZDO1FBQzdDLEtBQUssTUFBTSxDQUFDLEtBQUssRUFBRSxJQUFJ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Q0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQzFFLElBQUksSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsR0FBRyxlQUFlLEVBQUUsQ0FBQztnQkFDNUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzFCLE9BQU8sR0FBRyxJQUFJLENBQUM7WUFDakIsQ0FBQztRQUNILENBQUM7UUFFRCxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQ1osTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDN0IsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPO1FBQ0wsYUFBYSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUN0QyxDQUFDO0NBQ0Y7QUF2VUQsNENBdVVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSUF1dGhlbnRpY2F0aW9uUHJvdmlkZXIsXG4gIEluTWVtb3J5VXNlcixcbiAgSUF1dGhlbnRpY2F0aW9uUmVzdWx0LFxufSBmcm9tIFwiLi4vaW50ZXJmYWNlc1wiO1xuaW1wb3J0IHsgRmlsZVN0b3JlIH0gZnJvbSBcIi4vRmlsZVN0b3JlXCI7XG5pbXBvcnQgeyBDcnlwdG9VdGlsIH0gZnJvbSBcIi4uL3V0aWxzXCI7XG5pbXBvcnQgeyBMb2dnYWJsZSB9IGZyb20gXCIuLi9sb2dnaW5nXCI7XG5cbmludGVyZmFjZSBUb2tlbkRhdGEge1xuICB1c2VySWQ6IHN0cmluZztcbiAgZXhwaXJlc0F0OiBEYXRlO1xuICByZWZyZXNoVG9rZW4/OiBzdHJpbmc7XG4gIGxhc3RVc2VkOiBEYXRlO1xufVxuXG5leHBvcnQgY2xhc3MgRmlsZUF1dGhQcm92aWRlciBleHRlbmRzIExvZ2dhYmxlIGltcGxlbWVudHMgSUF1dGhlbnRpY2F0aW9uUHJvdmlkZXIge1xuICBwcml2YXRlIHN0b3JlOiBGaWxlU3RvcmU7XG4gIHByaXZhdGUgdXNlcnM6IE1hcDxzdHJpbmcsIEluTWVtb3J5VXNlcj4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgdG9rZW5zOiBNYXA8c3RyaW5nLCBUb2tlbkRhdGE+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIGNsZWFudXBJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgZGF0YURpcjogc3RyaW5nID0gXCIuLy5hdXRoLWRhdGFcIixcbiAgICBjbGVhbnVwSW50ZXJ2YWxNczogbnVtYmVyID0gNjAwMDAgKiAxNSAvLyAxNSBtaW51dGVzXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5zdG9yZSA9IG5ldyBGaWxlU3RvcmUoZGF0YURpcik7XG4gICAgdGhpcy5jbGVhbnVwSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICB0aGlzLmNsZWFudXBFeHBpcmVkVG9rZW5zKCk7XG4gICAgfSwgY2xlYW51cEludGVydmFsTXMpO1xuICB9XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnN0b3JlLmluaXRpYWxpemUoKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRVc2VycygpO1xuICAgIGF3YWl0IHRoaXMubG9hZFRva2VucygpO1xuXG4gICAgYXdhaXQgdGhpcy5wZXJmb3JtSW5pdGlhbENsZWFudXAoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcGVyZm9ybUluaXRpYWxDbGVhbnVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHRva2Vuc0NoYW5nZWQgPSBmYWxzZTtcbiAgICBsZXQgdXNlcnNDaGFuZ2VkID0gZmFsc2U7XG5cbiAgICAvLyBTdGVwIDE6IENsZWFuIHVwIGV4cGlyZWQgYW5kIHVudXNlZCB0b2tlbnNcbiAgICBmb3IgKGNvbnN0IFt0b2tlbiwgZGF0YV0gb2YgdGhpcy50b2tlbnMuZW50cmllcygpKSB7XG4gICAgICBjb25zdCB1bnVzZWRUaHJlc2hvbGQgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpIC0gNyAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICAgICAgaWYgKGRhdGEuZXhwaXJlc0F0IDwgbm93IHx8IGRhdGEubGFzdFVzZWQgPCB1bnVzZWRUaHJlc2hvbGQpIHtcbiAgICAgICAgdGhpcy50b2tlbnMuZGVsZXRlKHRva2VuKTtcbiAgICAgICAgdG9rZW5zQ2hhbmdlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU3RlcCAyOiBDbGVhbiB1cCB0b2tlbnMgd2l0aCBub24tZXhpc3RlbnQgdXNlcnMgKG9ycGhhbmVkIHRva2VucylcbiAgICBjb25zdCB2YWxpZFVzZXJJZHMgPSBuZXcgU2V0KEFycmF5LmZyb20odGhpcy51c2Vycy52YWx1ZXMoKSkubWFwKHUgPT4gdS51c2VySWQpKTtcbiAgICBmb3IgKGNvbnN0IFt0b2tlbiwgZGF0YV0gb2YgdGhpcy50b2tlbnMuZW50cmllcygpKSB7XG4gICAgICBpZiAoIXZhbGlkVXNlcklkcy5oYXMoZGF0YS51c2VySWQpKSB7XG4gICAgICAgIHRoaXMudG9rZW5zLmRlbGV0ZSh0b2tlbik7XG4gICAgICAgIHRva2Vuc0NoYW5nZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFN0ZXAgMzogQ2xlYW4gdXAgZHVwbGljYXRlIHVzZXIgdG9rZW5zIChrZWVwIG9ubHkgdGhlIG1vc3QgcmVjZW50KVxuICAgIGNvbnN0IHVzZXJUb2tlbnMgPSBuZXcgTWFwPHN0cmluZywgeyB0b2tlbjogc3RyaW5nOyBsYXN0VXNlZDogRGF0ZSB9PigpO1xuICAgIGZvciAoY29uc3QgW3Rva2VuLCBkYXRhXSBvZiB0aGlzLnRva2Vucy5lbnRyaWVzKCkpIHtcbiAgICAgIGNvbnN0IGV4aXN0aW5nID0gdXNlclRva2Vucy5nZXQoZGF0YS51c2VySWQpO1xuICAgICAgaWYgKCFleGlzdGluZyB8fCBleGlzdGluZy5sYXN0VXNlZCA8IGRhdGEubGFzdFVzZWQpIHtcbiAgICAgICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICAgICAgdGhpcy50b2tlbnMuZGVsZXRlKGV4aXN0aW5nLnRva2VuKTtcbiAgICAgICAgICB0b2tlbnNDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICB1c2VyVG9rZW5zLnNldChkYXRhLnVzZXJJZCwgeyB0b2tlbiwgbGFzdFVzZWQ6IGRhdGEubGFzdFVzZWQgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnRva2Vucy5kZWxldGUodG9rZW4pO1xuICAgICAgICB0b2tlbnNDaGFuZ2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBQZXJzaXN0IGNoYW5nZXMgaWYgbmVlZGVkXG4gICAgaWYgKHRva2Vuc0NoYW5nZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMucGVyc2lzdFRva2VucygpO1xuICAgIH1cbiAgICBpZiAodXNlcnNDaGFuZ2VkKSB7XG4gICAgICBhd2FpdCB0aGlzLnBlcnNpc3RVc2VycygpO1xuICAgIH1cblxuICAgIHRoaXMuaW5mbyhgSW5pdGlhbCBjbGVhbnVwIGNvbXBsZXRlZC4gVG9rZW5zIGNsZWFuZWQ6ICR7dG9rZW5zQ2hhbmdlZH1gKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZFVzZXJzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHVzZXJEYXRhID0gYXdhaXQgdGhpcy5zdG9yZS5yZWFkPHtcbiAgICAgIHVzZXJzOiBJbk1lbW9yeVVzZXJbXTtcbiAgICB9PihcInVzZXJzXCIpO1xuXG4gICAgaWYgKHVzZXJEYXRhKSB7XG4gICAgICB1c2VyRGF0YS51c2Vycy5mb3JFYWNoKCh1c2VyKSA9PiB7XG4gICAgICAgIHRoaXMudXNlcnMuc2V0KHVzZXIudXNlcm5hbWUudG9Mb3dlckNhc2UoKSwgdXNlcik7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWRUb2tlbnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdG9rZW5EYXRhID0gYXdhaXQgdGhpcy5zdG9yZS5yZWFkPHtcbiAgICAgIHRva2VuczogQXJyYXk8W3N0cmluZywgVG9rZW5EYXRhICYgeyBleHBpcmVzQXQ6IHN0cmluZzsgbGFzdFVzZWQ6IHN0cmluZyB9XT47XG4gICAgfT4oXCJ0b2tlbnNcIik7XG5cbiAgICBpZiAodG9rZW5EYXRhKSB7XG4gICAgICB0b2tlbkRhdGEudG9rZW5zLmZvckVhY2goKFt0b2tlbiwgZGF0YV0pID0+IHtcbiAgICAgICAgdGhpcy50b2tlbnMuc2V0KHRva2VuLCB7XG4gICAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgICBleHBpcmVzQXQ6IG5ldyBEYXRlKGRhdGEuZXhwaXJlc0F0KSxcbiAgICAgICAgICBsYXN0VXNlZDogbmV3IERhdGUoZGF0YS5sYXN0VXNlZCksXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwZXJzaXN0VXNlcnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zdG9yZS53cml0ZShcInVzZXJzXCIsIHtcbiAgICAgIHVzZXJzOiBBcnJheS5mcm9tKHRoaXMudXNlcnMudmFsdWVzKCkpLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwZXJzaXN0VG9rZW5zKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuc3RvcmUud3JpdGUoXCJ0b2tlbnNcIiwge1xuICAgICAgdG9rZW5zOiBBcnJheS5mcm9tKHRoaXMudG9rZW5zLmVudHJpZXMoKSkubWFwKChbdG9rZW4sIGRhdGFdKSA9PiBbXG4gICAgICAgIHRva2VuLFxuICAgICAgICB7XG4gICAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgICBleHBpcmVzQXQ6IGRhdGEuZXhwaXJlc0F0LnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgbGFzdFVzZWQ6IGRhdGEubGFzdFVzZWQudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSxcbiAgICAgIF0pLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgYWRkVXNlcihcbiAgICB1c2VybmFtZTogc3RyaW5nLFxuICAgIHBhc3N3b3JkOiBzdHJpbmcsXG4gICAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICk6IFByb21pc2U8SUF1dGhlbnRpY2F0aW9uUmVzdWx0PiB7XG4gICAgaWYgKCF1c2VybmFtZSB8fCAhcGFzc3dvcmQpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogXCJVc2VybmFtZSBhbmQgcGFzc3dvcmQgYXJlIHJlcXVpcmVkXCIgfTtcbiAgICB9XG5cbiAgICBjb25zdCBub3JtYWxpemVkVXNlcm5hbWUgPSB1c2VybmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICh0aGlzLnVzZXJzLmhhcyhub3JtYWxpemVkVXNlcm5hbWUpKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiVXNlcm5hbWUgYWxyZWFkeSBleGlzdHNcIiB9O1xuICAgIH1cblxuICAgIGlmIChwYXNzd29yZC5sZW5ndGggPCA2KSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCA2IGNoYXJhY3RlcnNcIiB9O1xuICAgIH1cblxuICAgIGNvbnN0IHVzZXJJZCA9IENyeXB0b1V0aWwuZ2VuZXJhdGVUb2tlbigpLnNsaWNlKDAsIDgpO1xuICAgIGNvbnN0IHBhc3N3b3JkSGFzaCA9IGF3YWl0IENyeXB0b1V0aWwuaGFzaFBhc3N3b3JkKHBhc3N3b3JkKTtcblxuICAgIGNvbnN0IG5ld1VzZXI6IEluTWVtb3J5VXNlciA9IHtcbiAgICAgIHVzZXJJZCxcbiAgICAgIHVzZXJuYW1lOiBub3JtYWxpemVkVXNlcm5hbWUsXG4gICAgICBwYXNzd29yZEhhc2gsXG4gICAgICBtZXRhZGF0YSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICB9O1xuXG4gICAgdGhpcy51c2Vycy5zZXQobm9ybWFsaXplZFVzZXJuYW1lLCBuZXdVc2VyKTtcbiAgICBhd2FpdCB0aGlzLnBlcnNpc3RVc2VycygpO1xuXG4gICAgLy8gQXV0b21hdGljYWxseSBhdXRoZW50aWNhdGUgdGhlIG5ldyB1c2VyXG4gICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRlKHsgdXNlcm5hbWUsIHBhc3N3b3JkIH0pO1xuICB9XG5cbiAgYXN5bmMgYXV0aGVudGljYXRlKGNyZWRlbnRpYWxzOiB7XG4gICAgdXNlcm5hbWU6IHN0cmluZztcbiAgICBwYXNzd29yZDogc3RyaW5nO1xuICB9KTogUHJvbWlzZTxJQXV0aGVudGljYXRpb25SZXN1bHQ+IHtcbiAgICBpZiAoIWNyZWRlbnRpYWxzLnVzZXJuYW1lIHx8ICFjcmVkZW50aWFscy5wYXNzd29yZCkge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBcIlVzZXJuYW1lIGFuZCBwYXNzd29yZCBhcmUgcmVxdWlyZWRcIiB9O1xuICAgIH1cblxuICAgIGNvbnN0IG5vcm1hbGl6ZWRVc2VybmFtZSA9IGNyZWRlbnRpYWxzLnVzZXJuYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgY29uc3QgdXNlciA9IHRoaXMudXNlcnMuZ2V0KG5vcm1hbGl6ZWRVc2VybmFtZSk7XG4gICAgXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiSW52YWxpZCBjcmVkZW50aWFsc1wiIH07XG4gICAgfVxuXG4gICAgY29uc3QgcGFzc3dvcmRIYXNoID0gYXdhaXQgQ3J5cHRvVXRpbC5oYXNoUGFzc3dvcmQoY3JlZGVudGlhbHMucGFzc3dvcmQpO1xuICAgIGlmIChwYXNzd29yZEhhc2ggIT09IHVzZXIucGFzc3dvcmRIYXNoKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiSW52YWxpZCBjcmVkZW50aWFsc1wiIH07XG4gICAgfVxuXG4gICAgLy8gQ2xlYW51cCBvbGQgdG9rZW5zIGZvciB0aGlzIHVzZXJcbiAgICBhd2FpdCB0aGlzLmNsZWFudXBVc2VyVG9rZW5zKHVzZXIudXNlcklkKTtcblxuICAgIGNvbnN0IHRva2VuID0gQ3J5cHRvVXRpbC5nZW5lcmF0ZVRva2VuKCk7XG4gICAgY29uc3QgcmVmcmVzaFRva2VuID0gQ3J5cHRvVXRpbC5nZW5lcmF0ZVRva2VuKCk7XG4gICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDI0ICogNjAgKiA2MCAqIDEwMDApOyAvLyAyNCBob3Vyc1xuXG4gICAgdGhpcy50b2tlbnMuc2V0KHRva2VuLCB7XG4gICAgICB1c2VySWQ6IHVzZXIudXNlcklkLFxuICAgICAgZXhwaXJlc0F0LFxuICAgICAgcmVmcmVzaFRva2VuLFxuICAgICAgbGFzdFVzZWQ6IG5ldyBEYXRlKCksXG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLnBlcnNpc3RUb2tlbnMoKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgdXNlcklkOiB1c2VyLnVzZXJJZCxcbiAgICAgIHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLFxuICAgICAgdG9rZW4sXG4gICAgICByZWZyZXNoVG9rZW4sXG4gICAgICBleHBpcmVzQXQsXG4gICAgICBtZXRhZGF0YTogdXNlci5tZXRhZGF0YSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgdmFsaWRhdGVUb2tlbih0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxJQXV0aGVudGljYXRpb25SZXN1bHQ+IHtcbiAgICBpZiAoIXRva2VuKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiVG9rZW4gaXMgcmVxdWlyZWRcIiB9O1xuICAgIH1cblxuICAgIGNvbnN0IHRva2VuRGF0YSA9IHRoaXMudG9rZW5zLmdldCh0b2tlbik7XG4gICAgaWYgKCF0b2tlbkRhdGEpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogXCJJbnZhbGlkIHRva2VuXCIgfTtcbiAgICB9XG5cbiAgICBpZiAodG9rZW5EYXRhLmV4cGlyZXNBdCA8IG5ldyBEYXRlKCkpIHtcbiAgICAgIHRoaXMudG9rZW5zLmRlbGV0ZSh0b2tlbik7XG4gICAgICBhd2FpdCB0aGlzLnBlcnNpc3RUb2tlbnMoKTtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogXCJUb2tlbiBleHBpcmVkXCIgfTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgbGFzdCB1c2VkIHRpbWVzdGFtcFxuICAgIHRva2VuRGF0YS5sYXN0VXNlZCA9IG5ldyBEYXRlKCk7XG4gICAgYXdhaXQgdGhpcy5wZXJzaXN0VG9rZW5zKCk7XG5cbiAgICBjb25zdCB1c2VyID0gQXJyYXkuZnJvbSh0aGlzLnVzZXJzLnZhbHVlcygpKS5maW5kKFxuICAgICAgKHUpID0+IHUudXNlcklkID09PSB0b2tlbkRhdGEudXNlcklkXG4gICAgKTtcblxuICAgIGlmICghdXNlcikge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBcIlVzZXIgbm90IGZvdW5kXCIgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHVzZXJJZDogdG9rZW5EYXRhLnVzZXJJZCxcbiAgICAgIHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLFxuICAgICAgdG9rZW4sXG4gICAgICBleHBpcmVzQXQ6IHRva2VuRGF0YS5leHBpcmVzQXQsXG4gICAgICBtZXRhZGF0YTogdXNlci5tZXRhZGF0YSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgcmVmcmVzaFRva2VuKHJlZnJlc2hUb2tlbjogc3RyaW5nKTogUHJvbWlzZTxJQXV0aGVudGljYXRpb25SZXN1bHQ+IHtcbiAgICBpZiAoIXJlZnJlc2hUb2tlbikge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBcIlJlZnJlc2ggdG9rZW4gaXMgcmVxdWlyZWRcIiB9O1xuICAgIH1cblxuICAgIGNvbnN0IHRva2VuRW50cnkgPSBBcnJheS5mcm9tKHRoaXMudG9rZW5zLmVudHJpZXMoKSkuZmluZChcbiAgICAgIChbXywgZGF0YV0pID0+IGRhdGEucmVmcmVzaFRva2VuID09PSByZWZyZXNoVG9rZW5cbiAgICApO1xuXG4gICAgaWYgKCF0b2tlbkVudHJ5KSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IFwiSW52YWxpZCByZWZyZXNoIHRva2VuXCIgfTtcbiAgICB9XG5cbiAgICBjb25zdCB1c2VyID0gQXJyYXkuZnJvbSh0aGlzLnVzZXJzLnZhbHVlcygpKS5maW5kKFxuICAgICAgKHUpID0+IHUudXNlcklkID09PSB0b2tlbkVudHJ5WzFdLnVzZXJJZFxuICAgICk7XG5cbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogXCJVc2VyIG5vdCBmb3VuZFwiIH07XG4gICAgfVxuXG4gICAgY29uc3QgbmV3VG9rZW4gPSBDcnlwdG9VdGlsLmdlbmVyYXRlVG9rZW4oKTtcbiAgICBjb25zdCBuZXdSZWZyZXNoVG9rZW4gPSBDcnlwdG9VdGlsLmdlbmVyYXRlVG9rZW4oKTtcbiAgICBjb25zdCBleHBpcmVzQXQgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgMjQgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgICAvLyBSZW1vdmUgb2xkIHRva2VuXG4gICAgdGhpcy50b2tlbnMuZGVsZXRlKHRva2VuRW50cnlbMF0pO1xuICAgIFxuICAgIC8vIFNldCBuZXcgdG9rZW5cbiAgICB0aGlzLnRva2Vucy5zZXQobmV3VG9rZW4sIHtcbiAgICAgIHVzZXJJZDogdG9rZW5FbnRyeVsxXS51c2VySWQsXG4gICAgICBleHBpcmVzQXQsXG4gICAgICByZWZyZXNoVG9rZW46IG5ld1JlZnJlc2hUb2tlbixcbiAgICAgIGxhc3RVc2VkOiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgdGhpcy5wZXJzaXN0VG9rZW5zKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHVzZXJJZDogdG9rZW5FbnRyeVsxXS51c2VySWQsXG4gICAgICB1c2VybmFtZTogdXNlci51c2VybmFtZSxcbiAgICAgIHRva2VuOiBuZXdUb2tlbixcbiAgICAgIHJlZnJlc2hUb2tlbjogbmV3UmVmcmVzaFRva2VuLFxuICAgICAgZXhwaXJlc0F0LFxuICAgICAgbWV0YWRhdGE6IHVzZXIubWV0YWRhdGEsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2xlYW51cFVzZXJUb2tlbnModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBsZXQgY2hhbmdlZCA9IGZhbHNlO1xuICAgIGZvciAoY29uc3QgW3Rva2VuLCBkYXRhXSBvZiB0aGlzLnRva2Vucy5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChkYXRhLnVzZXJJZCA9PT0gdXNlcklkKSB7XG4gICAgICAgIHRoaXMudG9rZW5zLmRlbGV0ZSh0b2tlbik7XG4gICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjaGFuZ2VkKSB7XG4gICAgICBhd2FpdCB0aGlzLnBlcnNpc3RUb2tlbnMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNsZWFudXBFeHBpcmVkVG9rZW5zKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcblxuICAgIGZvciAoY29uc3QgW3Rva2VuLCBkYXRhXSBvZiB0aGlzLnRva2Vucy5lbnRyaWVzKCkpIHtcbiAgICAgIC8vIFJlbW92ZSB0b2tlbnMgdGhhdCBhcmUgZXhwaXJlZCBvciBoYXZlbid0IGJlZW4gdXNlZCBpbiA3IGRheXNcbiAgICAgIGNvbnN0IHVudXNlZFRocmVzaG9sZCA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgLSA3ICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgICBpZiAoZGF0YS5leHBpcmVzQXQgPCBub3cgfHwgZGF0YS5sYXN0VXNlZCA8IHVudXNlZFRocmVzaG9sZCkge1xuICAgICAgICB0aGlzLnRva2Vucy5kZWxldGUodG9rZW4pO1xuICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY2hhbmdlZCkge1xuICAgICAgYXdhaXQgdGhpcy5wZXJzaXN0VG9rZW5zKCk7XG4gICAgfVxuICB9XG5cbiAgZGVzdHJveSgpOiB2b2lkIHtcbiAgICBjbGVhckludGVydmFsKHRoaXMuY2xlYW51cEludGVydmFsKTtcbiAgfVxufSJdfQ==