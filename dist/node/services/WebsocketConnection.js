"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebsocketConnection = void 0;
const ws_1 = __importDefault(require("ws"));
const crypto_1 = require("crypto");
class WebsocketConnection {
    constructor(handleMessage, handleClose, maxMessagesPerMinute = 100, events, websocket, heartbeatInterval = 30000, // 30 seconds
    heartbeatTimeout = 5000 // 5 seconds
    ) {
        this.handleMessage = handleMessage;
        this.handleClose = handleClose;
        this.maxMessagesPerMinute = maxMessagesPerMinute;
        this.events = events;
        this.heartbeatInterval = heartbeatInterval;
        this.heartbeatTimeout = heartbeatTimeout;
        this.lastHeartbeatResponse = Date.now();
        this.messageCount = 0;
        this.authenticated = false;
        this.metadata = new Map();
        this.websocket = null;
        this.eventListenersSetup = false;
        this.closePromise = null;
        this.lastMessageHash = "";
        this.connectionId = crypto.randomUUID();
        this.lastActivityTime = Date.now();
        if (websocket) {
            this.setWebSocket(websocket);
        }
    }
    startHeartbeat() {
        console.log("Starting heartbeat", this.heartbeatInterval);
        if (this.heartbeatTimer) {
            clearInterval(this.heartbeatTimer);
        }
        this.heartbeatTimer = setInterval(() => {
            this.sendHeartbeat();
        }, this.heartbeatInterval);
    }
    sendHeartbeat() {
        if (!this.isConnected()) {
            return;
        }
        const heartbeatRequest = {
            header: {
                timestamp: Date.now(),
                requestId: crypto.randomUUID(),
                requesterAddress: this.getSessionId() || this.connectionId,
                requestType: "heartbeat",
            },
            body: {
                timestamp: Date.now(),
            },
        };
        this.send(JSON.stringify(heartbeatRequest));
        // Set timeout for response
        this.heartbeatTimeoutTimer = setTimeout(() => {
            this.events?.onError(this.connectionId, new Error("Heartbeat timeout"));
            this.close(1001, "Heartbeat timeout");
        }, this.heartbeatTimeout);
    }
    setWebSocket(websocket) {
        if (this.websocket) {
            // Clean up existing connection first
            this.cleanupExistingConnection();
        }
        this.websocket = websocket;
        this.setupEventListeners();
        this.lastActivityTime = Date.now();
        this.websocket.maxPayload = WebsocketConnection.MAX_MESSAGE_SIZE;
    }
    cleanupExistingConnection() {
        if (this.websocket) {
            try {
                // Remove listeners before terminating to prevent any race conditions
                this.websocket.removeAllListeners();
                if (this.websocket.readyState !== ws_1.default.CLOSED) {
                    this.websocket.terminate();
                }
                this.websocket = null; // Clear the reference
            }
            catch (error) {
                this.events?.onError(this.connectionId, error);
            }
        }
    }
    setupEventListeners() {
        if (!this.websocket || this.eventListenersSetup) {
            return;
        }
        this.websocket.on("message", this.handleWebsocketMessages.bind(this));
        this.websocket.on("close", this.handleCloseConnection.bind(this));
        this.websocket.on("pong", this.handlePong.bind(this));
        this.websocket.on("error", this.handleError.bind(this));
        this.websocket.on("unexpected-response", this.handleUnexpectedResponse.bind(this));
        this.startHeartbeat();
        this.eventListenersSetup = true;
    }
    handleError(error) {
        this.events?.onError(this.connectionId, error);
        this.close(1006, "Internal error occurred");
    }
    handleUnexpectedResponse() {
        this.events?.onSecurityViolation(this.connectionId, "Unexpected response received");
        this.close(1006, "Unexpected response");
    }
    handlePong() {
        this.lastActivityTime = Date.now();
    }
    send(message) {
        if (!this.websocket) {
            throw new Error("Cannot send message: WebSocket not initialized");
        }
        try {
            // Check message size before sending
            const messageSize = Buffer.byteLength(message);
            if (messageSize > WebsocketConnection.MAX_MESSAGE_SIZE) {
                throw new Error("Message exceeds maximum size limit");
            }
            this.websocket.send(message);
            this.lastActivityTime = Date.now();
        }
        catch (error) {
            this.events?.onError(this.connectionId, error);
            throw error;
        }
    }
    handleCloseConnection() {
        if (this.connectionId) {
            this.handleClose(this.connectionId).catch((error) => {
                this.events?.onError(this.connectionId, error);
            });
        }
    }
    async handleWebsocketMessages(message) {
        try {
            this.lastActivityTime = Date.now();
            // Size check
            const messageSize = this.getDataSize(message);
            if (messageSize > WebsocketConnection.MAX_MESSAGE_SIZE) {
                this.events?.onSecurityViolation(this.connectionId, "Message size exceeded");
                this.send(JSON.stringify({ error: "Message too large" }));
                return;
            }
            // Rate limiting
            if (this.isRateLimited()) {
                this.events?.onRateLimit(this.connectionId);
                this.send(JSON.stringify({ error: "Rate limit exceeded" }));
                return;
            }
            // Detect message replay attacks
            const messageString = this.dataToString(message);
            const messageHash = this.calculateMessageHash(messageString);
            if (messageHash === this.lastMessageHash) {
                this.events?.onSecurityViolation(this.connectionId, "Possible replay attack");
                return;
            }
            this.lastMessageHash = messageHash;
            this.messageCount++;
            const parsedMessage = JSON.parse(this.dataToString(message));
            // Check if it's a heartbeat response
            if (parsedMessage?.requestHeader?.requestType === "heartbeat" &&
                parsedMessage?.body?.success) {
                clearTimeout(this.heartbeatTimeoutTimer);
                this.lastHeartbeatResponse = Date.now();
                return;
            }
            this.handleMessage(message, this);
        }
        catch (error) {
            this.events?.onError(this.connectionId, error);
        }
    }
    calculateMessageHash(message) {
        return (0, crypto_1.createHash)("sha256").update(message).digest("hex");
    }
    dataToString(data) {
        if (typeof data === "string") {
            return data;
        }
        if (data instanceof Buffer) {
            return data.toString();
        }
        if (data instanceof ArrayBuffer) {
            return Buffer.from(data).toString();
        }
        if (Array.isArray(data)) {
            return Buffer.concat(data).toString();
        }
        return "";
    }
    getDataSize(data) {
        if (typeof data === "string") {
            return Buffer.byteLength(data);
        }
        if (data instanceof Buffer) {
            return data.length;
        }
        if (data instanceof ArrayBuffer) {
            return data.byteLength;
        }
        if (Array.isArray(data)) {
            return data.reduce((acc, buf) => acc + buf.length, 0);
        }
        return 0;
    }
    isRateLimited() {
        const oneMinuteAgo = Date.now() - 60000;
        if (this.messageCount > this.maxMessagesPerMinute &&
            this.lastActivityTime > oneMinuteAgo) {
            return true;
        }
        if (this.lastActivityTime <= oneMinuteAgo) {
            this.messageCount = 0;
        }
        return false;
    }
    getConnectionId() {
        return this.connectionId;
    }
    setAuthenticated(value) {
        this.authenticated = value;
    }
    isAuthenticated() {
        return this.authenticated;
    }
    close(code, reason) {
        if (!this.closePromise) {
            this.closePromise = new Promise((resolve) => {
                this.stopSessionRefresh();
                if (!this.websocket || this.websocket.readyState === ws_1.default.CLOSED) {
                    resolve();
                    return;
                }
                const cleanup = () => {
                    this.cleanupExistingConnection();
                    resolve();
                };
                // Immediately terminate after timeout instead of waiting
                const timeoutId = setTimeout(() => {
                    if (this.websocket) {
                        this.websocket.terminate();
                        cleanup();
                    }
                }, WebsocketConnection.FORCED_CLOSE_TIMEOUT);
                this.websocket.once("close", () => {
                    clearTimeout(timeoutId);
                    cleanup();
                });
                if (this.heartbeatTimer) {
                    clearInterval(this.heartbeatTimer);
                }
                if (this.heartbeatTimeoutTimer) {
                    clearTimeout(this.heartbeatTimeoutTimer);
                }
                // Initiate graceful close
                this.websocket.close(code, reason);
            });
        }
        return this.closePromise;
    }
    ping() {
        if (this.websocket) {
            this.websocket.ping();
        }
    }
    isConnected() {
        return (this.websocket !== null && this.websocket.readyState === ws_1.default.OPEN);
    }
    setMetadata(key, value) {
        this.metadata.set(key, value);
    }
    getMetadata(key) {
        return this.metadata.get(key);
    }
    async refreshSession(sessionStore) {
        try {
            const sessionId = this.getMetadata("sessionId");
            if (!sessionId)
                return false;
            const session = await sessionStore.get(sessionId);
            if (!session) {
                // Session invalid - close connection
                this.close(1008, "Session expired");
                return false;
            }
            session.lastAccessedAt = new Date();
            return sessionStore.update(sessionId, session);
        }
        catch (error) {
            this.events?.onError(this.connectionId, error);
            return false;
        }
    }
    startSessionRefresh(sessionStore) {
        if (this.sessionRefreshTimer) {
            clearInterval(this.sessionRefreshTimer);
        }
        this.sessionRefreshTimer = setInterval(() => this.refreshSession(sessionStore), WebsocketConnection.SESSION_REFRESH_INTERVAL);
    }
    stopSessionRefresh() {
        if (this.sessionRefreshTimer) {
            clearInterval(this.sessionRefreshTimer);
            this.sessionRefreshTimer = undefined;
        }
    }
    // Static method for broadcasting to multiple connections
    static broadcast(message, connections) {
        connections.forEach((connection) => {
            if (connection.isConnected()) {
                connection.send(message);
            }
        });
    }
    getSessionId() {
        return this.getMetadata("sessionId");
    }
}
exports.WebsocketConnection = WebsocketConnection;
WebsocketConnection.MAX_MESSAGE_SIZE = 1024 * 1024; // 1MB
WebsocketConnection.SESSION_REFRESH_INTERVAL = 60000; // 1 minute
WebsocketConnection.FORCED_CLOSE_TIMEOUT = 5000; // 5 seconds
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2Vic29ja2V0Q29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2aWNlcy9XZWJzb2NrZXRDb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRDQUEyQjtBQUUzQixtQ0FBb0M7QUFTcEMsTUFBYSxtQkFBbUI7SUFtQjlCLFlBQ1UsYUFHQyxFQUNELFdBQW9ELEVBQ3BELHVCQUErQixHQUFHLEVBQ2xDLE1BQXlCLEVBQ2pDLFNBQXFCLEVBQ2Isb0JBQTRCLEtBQUssRUFBRSxhQUFhO0lBQ2hELG1CQUEyQixJQUFJLENBQUMsWUFBWTs7UUFUNUMsa0JBQWEsR0FBYixhQUFhLENBR1o7UUFDRCxnQkFBVyxHQUFYLFdBQVcsQ0FBeUM7UUFDcEQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFjO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQW1CO1FBRXpCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBZ0I7UUFDakMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFlO1FBeEJqQywwQkFBcUIsR0FBVyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFLM0MsaUJBQVksR0FBVyxDQUFDLENBQUM7UUFDekIsa0JBQWEsR0FBWSxLQUFLLENBQUM7UUFDL0IsYUFBUSxHQUFxQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3ZDLGNBQVMsR0FBcUIsSUFBSSxDQUFDO1FBQ25DLHdCQUFtQixHQUFZLEtBQUssQ0FBQztRQUNyQyxpQkFBWSxHQUF5QixJQUFJLENBQUM7UUFFMUMsb0JBQWUsR0FBVyxFQUFFLENBQUM7UUFjbkMsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDeEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUVuQyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQ2QsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENB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QUFDO0lBQ0gsQ0FBQztJQUVELHlEQUF5RDtJQUNsRCxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQWUsRUFBRSxXQUFrQztRQUN6RSxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDakMsSUFBSSxVQUFVLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQztnQkFDN0IsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMzQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sWUFBWTtRQUNqQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDdkMsQ0FBQzs7QUE1WUgsa0RBNllDO0FBNVl5QixvQ0FBZ0IsR0FBRyxJQUFJLEdBQUcsSUFBSSxBQUFkLENBQWUsQ0FBQyxNQUFNO0FBQ3RDLDRDQUF3QixHQUFHLEtBQUssQUFBUixDQUFTLENBQUMsV0FBVztBQUM3Qyx3Q0FBb0IsR0FBRyxJQUFJLEFBQVAsQ0FBUSxDQUFDLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2ViU29ja2V0IGZyb20gXCJ3c1wiO1xuaW1wb3J0IHsgSVNlc3Npb25TdG9yZSwgSVJlcXVlc3QgfSBmcm9tIFwiLi4vaW50ZXJmYWNlc1wiO1xuaW1wb3J0IHsgY3JlYXRlSGFzaCB9IGZyb20gXCJjcnlwdG9cIjtcbmltcG9ydCB7IEhlYXJ0YmVhdFJlcXVlc3QgfSBmcm9tIFwiLi9XZWJTb2NrZXRTZXJ2ZXJcIjtcblxuaW50ZXJmYWNlIENvbm5lY3Rpb25FdmVudHMge1xuICBvblJhdGVMaW1pdDogKGNvbm5lY3Rpb25JZDogc3RyaW5nKSA9PiB2b2lkO1xuICBvbkVycm9yOiAoY29ubmVjdGlvbklkOiBzdHJpbmcsIGVycm9yOiBFcnJvcikgPT4gdm9pZDtcbiAgb25TZWN1cml0eVZpb2xhdGlvbjogKGNvbm5lY3Rpb25JZDogc3RyaW5nLCB2aW9sYXRpb246IHN0cmluZykgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGNsYXNzIFdlYnNvY2tldENvbm5lY3Rpb24ge1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBNQVhfTUVTU0FHRV9TSVpFID0gMTAyNCAqIDEwMjQ7IC8vIDFNQlxuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBTRVNTSU9OX1JFRlJFU0hfSU5URVJWQUwgPSA2MDAwMDsgLy8gMSBtaW51dGVcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgRk9SQ0VEX0NMT1NFX1RJTUVPVVQgPSA1MDAwOyAvLyA1IHNlY29uZHNcblxuICBwcml2YXRlIGxhc3RIZWFydGJlYXRSZXNwb25zZTogbnVtYmVyID0gRGF0ZS5ub3coKTtcbiAgcHJpdmF0ZSBoZWFydGJlYXRUaW1lcj86IE5vZGVKUy5UaW1lb3V0O1xuICBwcml2YXRlIGhlYXJ0YmVhdFRpbWVvdXRUaW1lcj86IE5vZGVKUy5UaW1lb3V0O1xuICBwcml2YXRlIGNvbm5lY3Rpb25JZDogc3RyaW5nO1xuICBwcml2YXRlIGxhc3RBY3Rpdml0eVRpbWU6IG51bWJlcjtcbiAgcHJpdmF0ZSBtZXNzYWdlQ291bnQ6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgYXV0aGVudGljYXRlZDogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIG1ldGFkYXRhOiBNYXA8c3RyaW5nLCBhbnk+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHdlYnNvY2tldDogV2ViU29ja2V0IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZXZlbnRMaXN0ZW5lcnNTZXR1cDogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIGNsb3NlUHJvbWlzZTogUHJvbWlzZTx2b2lkPiB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHNlc3Npb25SZWZyZXNoVGltZXI/OiBOb2RlSlMuVGltZW91dDtcbiAgcHJpdmF0ZSBsYXN0TWVzc2FnZUhhc2g6IHN0cmluZyA9IFwiXCI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBoYW5kbGVNZXNzYWdlOiAoXG4gICAgICBkYXRhOiBXZWJTb2NrZXQuRGF0YSxcbiAgICAgIHdlYnNvY2tldDogV2Vic29ja2V0Q29ubmVjdGlvblxuICAgICkgPT4gdm9pZCxcbiAgICBwcml2YXRlIGhhbmRsZUNsb3NlOiAoY29ubmVjdGlvbklkOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4sXG4gICAgcHJpdmF0ZSBtYXhNZXNzYWdlc1Blck1pbnV0ZTogbnVtYmVyID0gMTAwLFxuICAgIHByaXZhdGUgZXZlbnRzPzogQ29ubmVjdGlvbkV2ZW50cyxcbiAgICB3ZWJzb2NrZXQ/OiBXZWJTb2NrZXQsXG4gICAgcHJpdmF0ZSBoZWFydGJlYXRJbnRlcnZhbDogbnVtYmVyID0gMzAwMDAsIC8vIDMwIHNlY29uZHNcbiAgICBwcml2YXRlIGhlYXJ0YmVhdFRpbWVvdXQ6IG51bWJlciA9IDUwMDAgLy8gNSBzZWNvbmRzXG4gICkge1xuICAgIHRoaXMuY29ubmVjdGlvbklkID0gY3J5cHRvLnJhbmRvbVVVSUQoKTtcbiAgICB0aGlzLmxhc3RBY3Rpdml0eVRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgaWYgKHdlYnNvY2tldCkge1xuICAgICAgdGhpcy5zZXRXZWJTb2NrZXQod2Vic29ja2V0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0SGVhcnRiZWF0KCkge1xuICAgIGNvbnNvbGUubG9nKFwiU3RhcnRpbmcgaGVhcnRiZWF0XCIsIHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWwpO1xuXG4gICAgaWYgKHRoaXMuaGVhcnRiZWF0VGltZXIpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFydGJlYXRUaW1lcik7XG4gICAgfVxuXG4gICAgdGhpcy5oZWFydGJlYXRUaW1lciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHRoaXMuc2VuZEhlYXJ0YmVhdCgpO1xuICAgIH0sIHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWwpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZW5kSGVhcnRiZWF0KCkge1xuICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaGVhcnRiZWF0UmVxdWVzdDogSVJlcXVlc3Q8SGVhcnRiZWF0UmVxdWVzdD4gPSB7XG4gICAgICBoZWFkZXI6IHtcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICByZXF1ZXN0SWQ6IGNyeXB0by5yYW5kb21VVUlEKCksXG4gICAgICAgIHJlcXVlc3RlckFkZHJlc3M6IHRoaXMuZ2V0U2Vzc2lvbklkKCkgfHwgdGhpcy5jb25uZWN0aW9uSWQsXG4gICAgICAgIHJlcXVlc3RUeXBlOiBcImhlYXJ0YmVhdFwiLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zZW5kKEpTT04uc3RyaW5naWZ5KGhlYXJ0YmVhdFJlcXVlc3QpKTtcblxuICAgIC8vIFNldCB0aW1lb3V0IGZvciByZXNwb25zZVxuICAgIHRoaXMuaGVhcnRiZWF0VGltZW91dFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmV2ZW50cz8ub25FcnJvcih0aGlzLmNvbm5lY3Rpb25JZCwgbmV3IEVycm9yKFwiSGVhcnRiZWF0IHRpbWVvdXRcIikpO1xuICAgICAgdGhpcy5jbG9zZSgxMDAxLCBcIkhlYXJ0YmVhdCB0aW1lb3V0XCIpO1xuICAgIH0sIHRoaXMuaGVhcnRiZWF0VGltZW91dCk7XG4gIH1cblxuICBwdWJsaWMgc2V0V2ViU29ja2V0KHdlYnNvY2tldDogV2ViU29ja2V0KSB7XG4gICAgaWYgKHRoaXMud2Vic29ja2V0KSB7XG4gICAgICAvLyBDbGVhbiB1cCBleGlzdGluZyBjb25uZWN0aW9uIGZpcnN0XG4gICAgICB0aGlzLmNsZWFudXBFeGlzdGluZ0Nvbm5lY3Rpb24oKTtcbiAgICB9XG5cbiAgICB0aGlzLndlYnNvY2tldCA9IHdlYnNvY2tldDtcbiAgICB0aGlzLnNldHVwRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICB0aGlzLmxhc3RBY3Rpdml0eVRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgKHRoaXMud2Vic29ja2V0IGFzIGFueSkubWF4UGF5bG9hZCA9IFdlYnNvY2tldENvbm5lY3Rpb24uTUFYX01FU1NBR0VfU0laRTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW51cEV4aXN0aW5nQ29ubmVjdGlvbigpIHtcbiAgICBpZiAodGhpcy53ZWJzb2NrZXQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIFJlbW92ZSBsaXN0ZW5lcnMgYmVmb3JlIHRlcm1pbmF0aW5nIHRvIHByZXZlbnQgYW55IHJhY2UgY29uZGl0aW9uc1xuICAgICAgICB0aGlzLndlYnNvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMoKTtcbiAgICAgICAgaWYgKHRoaXMud2Vic29ja2V0LnJlYWR5U3RhdGUgIT09IFdlYlNvY2tldC5DTE9TRUQpIHtcbiAgICAgICAgICB0aGlzLndlYnNvY2tldC50ZXJtaW5hdGUoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLndlYnNvY2tldCA9IG51bGw7IC8vIENsZWFyIHRoZSByZWZlcmVuY2VcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMuZXZlbnRzPy5vbkVycm9yKHRoaXMuY29ubmVjdGlvbklkLCBlcnJvciBhcyBFcnJvcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cEV2ZW50TGlzdGVuZXJzKCkge1xuICAgIGlmICghdGhpcy53ZWJzb2NrZXQgfHwgdGhpcy5ldmVudExpc3RlbmVyc1NldHVwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy53ZWJzb2NrZXQub24oXCJtZXNzYWdlXCIsIHRoaXMuaGFuZGxlV2Vic29ja2V0TWVzc2FnZXMuYmluZCh0aGlzKSk7XG4gICAgdGhpcy53ZWJzb2NrZXQub24oXCJjbG9zZVwiLCB0aGlzLmhhbmRsZUNsb3NlQ29ubmVjdGlvbi5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLndlYnNvY2tldC5vbihcInBvbmdcIiwgdGhpcy5oYW5kbGVQb25nLmJpbmQodGhpcykpO1xuICAgIHRoaXMud2Vic29ja2V0Lm9uKFwiZXJyb3JcIiwgdGhpcy5oYW5kbGVFcnJvci5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMud2Vic29ja2V0Lm9uKFxuICAgICAgXCJ1bmV4cGVjdGVkLXJlc3BvbnNlXCIsXG4gICAgICB0aGlzLmhhbmRsZVVuZXhwZWN0ZWRSZXNwb25zZS5iaW5kKHRoaXMpXG4gICAgKTtcblxuICAgIHRoaXMuc3RhcnRIZWFydGJlYXQoKTtcbiAgICB0aGlzLmV2ZW50TGlzdGVuZXJzU2V0dXAgPSB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVFcnJvcihlcnJvcjogRXJyb3IpIHtcbiAgICB0aGlzLmV2ZW50cz8ub25FcnJvcih0aGlzLmNvbm5lY3Rpb25JZCwgZXJyb3IpO1xuICAgIHRoaXMuY2xvc2UoMTAwNiwgXCJJbnRlcm5hbCBlcnJvciBvY2N1cnJlZFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVW5leHBlY3RlZFJlc3BvbnNlKCkge1xuICAgIHRoaXMuZXZlbnRzPy5vblNlY3VyaXR5VmlvbGF0aW9uKFxuICAgICAgdGhpcy5jb25uZWN0aW9uSWQsXG4gICAgICBcIlVuZXhwZWN0ZWQgcmVzcG9uc2UgcmVjZWl2ZWRcIlxuICAgICk7XG4gICAgdGhpcy5jbG9zZSgxMDA2LCBcIlVuZXhwZWN0ZWQgcmVzcG9uc2VcIik7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVBvbmcoKSB7XG4gICAgdGhpcy5sYXN0QWN0aXZpdHlUaW1lID0gRGF0ZS5ub3coKTtcbiAgfVxuXG4gIHB1YmxpYyBzZW5kKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGlmICghdGhpcy53ZWJzb2NrZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBzZW5kIG1lc3NhZ2U6IFdlYlNvY2tldCBub3QgaW5pdGlhbGl6ZWRcIik7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIG1lc3NhZ2Ugc2l6ZSBiZWZvcmUgc2VuZGluZ1xuICAgICAgY29uc3QgbWVzc2FnZVNpemUgPSBCdWZmZXIuYnl0ZUxlbmd0aChtZXNzYWdlKTtcbiAgICAgIGlmIChtZXNzYWdlU2l6ZSA+IFdlYnNvY2tldENvbm5lY3Rpb24uTUFYX01FU1NBR0VfU0laRSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNZXNzYWdlIGV4Y2VlZHMgbWF4aW11bSBzaXplIGxpbWl0XCIpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLndlYnNvY2tldC5zZW5kKG1lc3NhZ2UpO1xuICAgICAgdGhpcy5sYXN0QWN0aXZpdHlUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5ldmVudHM/Lm9uRXJyb3IodGhpcy5jb25uZWN0aW9uSWQsIGVycm9yIGFzIEVycm9yKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlQ2xvc2VDb25uZWN0aW9uKCkge1xuICAgIGlmICh0aGlzLmNvbm5lY3Rpb25JZCkge1xuICAgICAgdGhpcy5oYW5kbGVDbG9zZSh0aGlzLmNvbm5lY3Rpb25JZCkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgIHRoaXMuZXZlbnRzPy5vbkVycm9yKHRoaXMuY29ubmVjdGlvbklkLCBlcnJvciBhcyBFcnJvcik7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGhhbmRsZVdlYnNvY2tldE1lc3NhZ2VzKG1lc3NhZ2U6IFdlYlNvY2tldC5EYXRhKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMubGFzdEFjdGl2aXR5VGltZSA9IERhdGUubm93KCk7XG5cbiAgICAgIC8vIFNpemUgY2hlY2tcbiAgICAgIGNvbnN0IG1lc3NhZ2VTaXplID0gdGhpcy5nZXREYXRhU2l6ZShtZXNzYWdlKTtcbiAgICAgIGlmIChtZXNzYWdlU2l6ZSA+IFdlYnNvY2tldENvbm5lY3Rpb24uTUFYX01FU1NBR0VfU0laRSkge1xuICAgICAgICB0aGlzLmV2ZW50cz8ub25TZWN1cml0eVZpb2xhdGlvbihcbiAgICAgICAgICB0aGlzLmNvbm5lY3Rpb25JZCxcbiAgICAgICAgICBcIk1lc3NhZ2Ugc2l6ZSBleGNlZWRlZFwiXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuc2VuZChKU09OLnN0cmluZ2lmeSh7IGVycm9yOiBcIk1lc3NhZ2UgdG9vIGxhcmdlXCIgfSkpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIFJhdGUgbGltaXRpbmdcbiAgICAgIGlmICh0aGlzLmlzUmF0ZUxpbWl0ZWQoKSkge1xuICAgICAgICB0aGlzLmV2ZW50cz8ub25SYXRlTGltaXQodGhpcy5jb25uZWN0aW9uSWQpO1xuICAgICAgICB0aGlzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogXCJSYXRlIGxpbWl0IGV4Y2VlZGVkXCIgfSkpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIERldGVjdCBtZXNzYWdlIHJlcGxheSBhdHRhY2tzXG4gICAgICBjb25zdCBtZXNzYWdlU3RyaW5nID0gdGhpcy5kYXRhVG9TdHJpbmcobWVzc2FnZSk7XG4gICAgICBjb25zdCBtZXNzYWdlSGFzaCA9IHRoaXMuY2FsY3VsYXRlTWVzc2FnZUhhc2gobWVzc2FnZVN0cmluZyk7XG4gICAgICBpZiAobWVzc2FnZUhhc2ggPT09IHRoaXMubGFzdE1lc3NhZ2VIYXNoKSB7XG4gICAgICAgIHRoaXMuZXZlbnRzPy5vblNlY3VyaXR5VmlvbGF0aW9uKFxuICAgICAgICAgIHRoaXMuY29ubmVjdGlvbklkLFxuICAgICAgICAgIFwiUG9zc2libGUgcmVwbGF5IGF0dGFja1wiXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMubGFzdE1lc3NhZ2VIYXNoID0gbWVzc2FnZUhhc2g7XG5cbiAgICAgIHRoaXMubWVzc2FnZUNvdW50Kys7XG4gICAgICBjb25zdCBwYXJzZWRNZXNzYWdlID0gSlNPTi5wYXJzZSh0aGlzLmRhdGFUb1N0cmluZyhtZXNzYWdlKSk7XG5cbiAgICAgIC8vIENoZWNrIGlmIGl0J3MgYSBoZWFydGJlYXQgcmVzcG9uc2VcbiAgICAgIGlmIChcbiAgICAgICAgcGFyc2VkTWVzc2FnZT8ucmVxdWVzdEhlYWRlcj8ucmVxdWVzdFR5cGUgPT09IFwiaGVhcnRiZWF0XCIgJiZcbiAgICAgICAgcGFyc2VkTWVzc2FnZT8uYm9keT8uc3VjY2Vzc1xuICAgICAgKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmhlYXJ0YmVhdFRpbWVvdXRUaW1lcik7XG4gICAgICAgIHRoaXMubGFzdEhlYXJ0YmVhdFJlc3BvbnNlID0gRGF0ZS5ub3coKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmhhbmRsZU1lc3NhZ2UobWVzc2FnZSwgdGhpcyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuZXZlbnRzPy5vbkVycm9yKHRoaXMuY29ubmVjdGlvbklkLCBlcnJvciBhcyBFcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVNZXNzYWdlSGFzaChtZXNzYWdlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBjcmVhdGVIYXNoKFwic2hhMjU2XCIpLnVwZGF0ZShtZXNzYWdlKS5kaWdlc3QoXCJoZXhcIik7XG4gIH1cblxuICBwcml2YXRlIGRhdGFUb1N0cmluZyhkYXRhOiBXZWJTb2NrZXQuRGF0YSk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGVvZiBkYXRhID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBCdWZmZXIpIHtcbiAgICAgIHJldHVybiBkYXRhLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHtcbiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShkYXRhKS50b1N0cmluZygpO1xuICAgIH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgcmV0dXJuIEJ1ZmZlci5jb25jYXQoZGF0YSkudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgcmV0dXJuIFwiXCI7XG4gIH1cblxuICBwcml2YXRlIGdldERhdGFTaXplKGRhdGE6IFdlYlNvY2tldC5EYXRhKTogbnVtYmVyIHtcbiAgICBpZiAodHlwZW9mIGRhdGEgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBCdWZmZXIuYnl0ZUxlbmd0aChkYXRhKTtcbiAgICB9XG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBCdWZmZXIpIHtcbiAgICAgIHJldHVybiBkYXRhLmxlbmd0aDtcbiAgICB9XG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikge1xuICAgICAgcmV0dXJuIGRhdGEuYnl0ZUxlbmd0aDtcbiAgICB9XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHtcbiAgICAgIHJldHVybiBkYXRhLnJlZHVjZSgoYWNjLCBidWYpID0+IGFjYyArIGJ1Zi5sZW5ndGgsIDApO1xuICAgIH1cbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIHByaXZhdGUgaXNSYXRlTGltaXRlZCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBvbmVNaW51dGVBZ28gPSBEYXRlLm5vdygpIC0gNjAwMDA7XG4gICAgaWYgKFxuICAgICAgdGhpcy5tZXNzYWdlQ291bnQgPiB0aGlzLm1heE1lc3NhZ2VzUGVyTWludXRlICYmXG4gICAgICB0aGlzLmxhc3RBY3Rpdml0eVRpbWUgPiBvbmVNaW51dGVBZ29cbiAgICApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAodGhpcy5sYXN0QWN0aXZpdHlUaW1lIDw9IG9uZU1pbnV0ZUFnbykge1xuICAgICAgdGhpcy5tZXNzYWdlQ291bnQgPSAwO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29ubmVjdGlvbklkKCkge1xuICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25JZDtcbiAgfVxuXG4gIHB1YmxpYyBzZXRBdXRoZW50aWNhdGVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5hdXRoZW50aWNhdGVkID0gdmFsdWU7XG4gIH1cblxuICBwdWJsaWMgaXNBdXRoZW50aWNhdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmF1dGhlbnRpY2F0ZWQ7XG4gIH1cblxuICBwdWJsaWMgY2xvc2UoY29kZT86IG51bWJlciwgcmVhc29uPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmNsb3NlUHJvbWlzZSkge1xuICAgICAgdGhpcy5jbG9zZVByb21pc2UgPSBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT4ge1xuICAgICAgICB0aGlzLnN0b3BTZXNzaW9uUmVmcmVzaCgpO1xuXG4gICAgICAgIGlmICghdGhpcy53ZWJzb2NrZXQgfHwgdGhpcy53ZWJzb2NrZXQucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0LkNMT1NFRCkge1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjbGVhbnVwID0gKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY2xlYW51cEV4aXN0aW5nQ29ubmVjdGlvbigpO1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBJbW1lZGlhdGVseSB0ZXJtaW5hdGUgYWZ0ZXIgdGltZW91dCBpbnN0ZWFkIG9mIHdhaXRpbmdcbiAgICAgICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMud2Vic29ja2V0KSB7XG4gICAgICAgICAgICB0aGlzLndlYnNvY2tldC50ZXJtaW5hdGUoKTtcbiAgICAgICAgICAgIGNsZWFudXAoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIFdlYnNvY2tldENvbm5lY3Rpb24uRk9SQ0VEX0NMT1NFX1RJTUVPVVQpO1xuXG4gICAgICAgIHRoaXMud2Vic29ja2V0Lm9uY2UoXCJjbG9zZVwiLCAoKSA9PiB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7XG4gICAgICAgICAgY2xlYW51cCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAodGhpcy5oZWFydGJlYXRUaW1lcikge1xuICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFydGJlYXRUaW1lcik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaGVhcnRiZWF0VGltZW91dFRpbWVyKSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaGVhcnRiZWF0VGltZW91dFRpbWVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEluaXRpYXRlIGdyYWNlZnVsIGNsb3NlXG4gICAgICAgIHRoaXMud2Vic29ja2V0LmNsb3NlKGNvZGUsIHJlYXNvbik7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5jbG9zZVByb21pc2U7XG4gIH1cblxuICBwdWJsaWMgcGluZygpIHtcbiAgICBpZiAodGhpcy53ZWJzb2NrZXQpIHtcbiAgICAgIHRoaXMud2Vic29ja2V0LnBpbmcoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaXNDb25uZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMud2Vic29ja2V0ICE9PSBudWxsICYmIHRoaXMud2Vic29ja2V0LnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOXG4gICAgKTtcbiAgfVxuXG4gIHNldE1ldGFkYXRhKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5tZXRhZGF0YS5zZXQoa2V5LCB2YWx1ZSk7XG4gIH1cblxuICBnZXRNZXRhZGF0YShrZXk6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMubWV0YWRhdGEuZ2V0KGtleSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVmcmVzaFNlc3Npb24oc2Vzc2lvblN0b3JlOiBJU2Vzc2lvblN0b3JlKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuZ2V0TWV0YWRhdGEoXCJzZXNzaW9uSWRcIik7XG4gICAgICBpZiAoIXNlc3Npb25JZCkgcmV0dXJuIGZhbHNlO1xuXG4gICAgICBjb25zdCBzZXNzaW9uID0gYXdhaXQgc2Vzc2lvblN0b3JlLmdldChzZXNzaW9uSWQpO1xuICAgICAgaWYgKCFzZXNzaW9uKSB7XG4gICAgICAgIC8vIFNlc3Npb24gaW52YWxpZCAtIGNsb3NlIGNvbm5lY3Rpb25cbiAgICAgICAgdGhpcy5jbG9zZSgxMDA4LCBcIlNlc3Npb24gZXhwaXJlZFwiKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBzZXNzaW9uLmxhc3RBY2Nlc3NlZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgIHJldHVybiBzZXNzaW9uU3RvcmUudXBkYXRlKHNlc3Npb25JZCwgc2Vzc2lvbik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuZXZlbnRzPy5vbkVycm9yKHRoaXMuY29ubmVjdGlvbklkLCBlcnJvciBhcyBFcnJvcik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHN0YXJ0U2Vzc2lvblJlZnJlc2goc2Vzc2lvblN0b3JlOiBJU2Vzc2lvblN0b3JlKSB7XG4gICAgaWYgKHRoaXMuc2Vzc2lvblJlZnJlc2hUaW1lcikge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnNlc3Npb25SZWZyZXNoVGltZXIpO1xuICAgIH1cblxuICAgIHRoaXMuc2Vzc2lvblJlZnJlc2hUaW1lciA9IHNldEludGVydmFsKFxuICAgICAgKCkgPT4gdGhpcy5yZWZyZXNoU2Vzc2lvbihzZXNzaW9uU3RvcmUpLFxuICAgICAgV2Vic29ja2V0Q29ubmVjdGlvbi5TRVNTSU9OX1JFRlJFU0hfSU5URVJWQUxcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHN0b3BTZXNzaW9uUmVmcmVzaCgpIHtcbiAgICBpZiAodGhpcy5zZXNzaW9uUmVmcmVzaFRpbWVyKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuc2Vzc2lvblJlZnJlc2hUaW1lcik7XG4gICAgICB0aGlzLnNlc3Npb25SZWZyZXNoVGltZXIgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgLy8gU3RhdGljIG1ldGhvZCBmb3IgYnJvYWRjYXN0aW5nIHRvIG11bHRpcGxlIGNvbm5lY3Rpb25zXG4gIHB1YmxpYyBzdGF0aWMgYnJvYWRjYXN0KG1lc3NhZ2U6IHN0cmluZywgY29ubmVjdGlvbnM6IFdlYnNvY2tldENvbm5lY3Rpb25bXSkge1xuICAgIGNvbm5lY3Rpb25zLmZvckVhY2goKGNvbm5lY3Rpb24pID0+IHtcbiAgICAgIGlmIChjb25uZWN0aW9uLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgY29ubmVjdGlvbi5zZW5kKG1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldFNlc3Npb25JZCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmdldE1ldGFkYXRhKFwic2Vzc2lvbklkXCIpO1xuICB9XG59XG4iXX0=