"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebsocketConnection = void 0;
const ws_1 = __importDefault(require("ws"));
const crypto_1 = require("crypto");
const core_1 = require("../core");
class WebsocketConnection {
    constructor(handleMessage, handleClose, maxMessagesPerMinute = 100, events, websocket, heartbeatInterval = 30000, // 30 seconds
    heartbeatTimeout = 5000 // 5 seconds
    ) {
        this.handleMessage = handleMessage;
        this.handleClose = handleClose;
        this.maxMessagesPerMinute = maxMessagesPerMinute;
        this.events = events;
        this.heartbeatInterval = heartbeatInterval;
        this.heartbeatTimeout = heartbeatTimeout;
        this.lastHeartbeatResponse = Date.now();
        this.messageCount = 0;
        this.authenticated = false;
        this.metadata = new Map();
        this.websocket = null;
        this.eventListenersSetup = false;
        this.closePromise = null;
        this.lastMessageHash = "";
        this.connectionId = crypto.randomUUID();
        this.lastActivityTime = Date.now();
        if (websocket) {
            this.setWebSocket(websocket);
        }
    }
    startHeartbeat() {
        if (this.heartbeatTimer) {
            clearInterval(this.heartbeatTimer);
        }
        this.heartbeatTimer = setInterval(() => {
            this.sendHeartbeat();
        }, this.heartbeatInterval);
    }
    sendHeartbeat() {
        if (!this.isConnected()) {
            return;
        }
        const heartbeatRequest = new core_1.RequestBuilder({ timestamp: Date.now() })
            .setRequiresResponse(true)
            .setRequestType("heartbeat")
            .setRequesterAddress(this.getSessionId() || this.connectionId);
        this.send(JSON.stringify(heartbeatRequest.build()));
        // Set timeout for response
        this.heartbeatTimeoutTimer = setTimeout(() => {
            this.events?.onError(this.connectionId, new Error("Heartbeat timeout"));
            this.close(1001, "Heartbeat timeout");
        }, this.heartbeatTimeout);
    }
    setWebSocket(websocket) {
        if (this.websocket) {
            // Clean up existing connection first
            this.cleanupExistingConnection();
        }
        this.websocket = websocket;
        this.setupEventListeners();
        this.lastActivityTime = Date.now();
        this.websocket.maxPayload = WebsocketConnection.MAX_MESSAGE_SIZE;
    }
    cleanupExistingConnection() {
        if (this.websocket) {
            try {
                // Remove listeners before terminating to prevent any race conditions
                this.websocket.removeAllListeners();
                if (this.websocket.readyState !== ws_1.default.CLOSED) {
                    this.websocket.terminate();
                }
                this.websocket = null; // Clear the reference
            }
            catch (error) {
                this.events?.onError(this.connectionId, error);
            }
        }
    }
    setupEventListeners() {
        if (!this.websocket || this.eventListenersSetup) {
            return;
        }
        this.websocket.on("message", this.handleWebsocketMessages.bind(this));
        this.websocket.on("close", this.handleCloseConnection.bind(this));
        this.websocket.on("pong", this.handlePong.bind(this));
        this.websocket.on("error", this.handleError.bind(this));
        this.websocket.on("unexpected-response", this.handleUnexpectedResponse.bind(this));
        this.startHeartbeat();
        this.eventListenersSetup = true;
    }
    handleError(error) {
        this.events?.onError(this.connectionId, error);
        this.close(1006, "Internal error occurred");
    }
    handleUnexpectedResponse() {
        this.events?.onSecurityViolation(this.connectionId, "Unexpected response received");
        this.close(1006, "Unexpected response");
    }
    handlePong() {
        this.lastActivityTime = Date.now();
    }
    send(message) {
        if (!this.websocket) {
            throw new Error("Cannot send message: WebSocket not initialized");
        }
        try {
            // Check message size before sending
            const messageSize = Buffer.byteLength(message);
            if (messageSize > WebsocketConnection.MAX_MESSAGE_SIZE) {
                throw new Error("Message exceeds maximum size limit");
            }
            this.websocket.send(message);
            this.lastActivityTime = Date.now();
        }
        catch (error) {
            this.events?.onError(this.connectionId, error);
            throw error;
        }
    }
    handleCloseConnection() {
        if (this.connectionId) {
            this.handleClose(this.connectionId).catch((error) => {
                this.events?.onError(this.connectionId, error);
            });
        }
    }
    async handleWebsocketMessages(message) {
        try {
            this.lastActivityTime = Date.now();
            // Size check
            const messageSize = this.getDataSize(message);
            if (messageSize > WebsocketConnection.MAX_MESSAGE_SIZE) {
                this.events?.onSecurityViolation(this.connectionId, "Message size exceeded");
                this.send(JSON.stringify({ error: "Message too large" }));
                return;
            }
            // Rate limiting
            if (this.isRateLimited()) {
                this.events?.onRateLimit(this.connectionId);
                this.send(JSON.stringify({ error: "Rate limit exceeded" }));
                return;
            }
            // Detect message replay attacks
            const messageString = this.dataToString(message);
            const messageHash = this.calculateMessageHash(messageString);
            if (messageHash === this.lastMessageHash) {
                this.events?.onSecurityViolation(this.connectionId, "Possible replay attack");
                return;
            }
            this.lastMessageHash = messageHash;
            this.messageCount++;
            //TODO: look for a more performant way to determine if message is heartbeat response (without JSON.parse it)
            const parsedMessage = JSON.parse(this.dataToString(message));
            // Check if it's a heartbeat response
            if (parsedMessage?.requestHeader?.requestType === "heartbeat" &&
                parsedMessage?.body?.success) {
                clearTimeout(this.heartbeatTimeoutTimer);
                this.lastHeartbeatResponse = Date.now();
                return;
            }
            this.handleMessage(message, this);
        }
        catch (error) {
            this.events?.onError(this.connectionId, error);
        }
    }
    calculateMessageHash(message) {
        return (0, crypto_1.createHash)("sha256").update(message).digest("hex");
    }
    dataToString(data) {
        if (typeof data === "string") {
            return data;
        }
        if (data instanceof Buffer) {
            return data.toString();
        }
        if (data instanceof ArrayBuffer) {
            return Buffer.from(data).toString();
        }
        if (Array.isArray(data)) {
            return Buffer.concat(data).toString();
        }
        return "";
    }
    getDataSize(data) {
        if (typeof data === "string") {
            return Buffer.byteLength(data);
        }
        if (data instanceof Buffer) {
            return data.length;
        }
        if (data instanceof ArrayBuffer) {
            return data.byteLength;
        }
        if (Array.isArray(data)) {
            return data.reduce((acc, buf) => acc + buf.length, 0);
        }
        return 0;
    }
    isRateLimited() {
        const oneMinuteAgo = Date.now() - 60000;
        if (this.messageCount > this.maxMessagesPerMinute &&
            this.lastActivityTime > oneMinuteAgo) {
            return true;
        }
        if (this.lastActivityTime <= oneMinuteAgo) {
            this.messageCount = 0;
        }
        return false;
    }
    getConnectionId() {
        return this.connectionId;
    }
    setAuthenticated(value) {
        this.authenticated = value;
    }
    isAuthenticated() {
        return this.authenticated;
    }
    close(code, reason) {
        if (!this.closePromise) {
            this.closePromise = new Promise((resolve) => {
                this.stopSessionRefresh();
                if (!this.websocket || this.websocket.readyState === ws_1.default.CLOSED) {
                    resolve();
                    return;
                }
                const cleanup = () => {
                    this.cleanupExistingConnection();
                    resolve();
                };
                // Immediately terminate after timeout instead of waiting
                const timeoutId = setTimeout(() => {
                    if (this.websocket) {
                        this.websocket.terminate();
                        cleanup();
                    }
                }, WebsocketConnection.FORCED_CLOSE_TIMEOUT);
                this.websocket.once("close", () => {
                    clearTimeout(timeoutId);
                    cleanup();
                });
                if (this.heartbeatTimer) {
                    clearInterval(this.heartbeatTimer);
                }
                if (this.heartbeatTimeoutTimer) {
                    clearTimeout(this.heartbeatTimeoutTimer);
                }
                // Initiate graceful close
                this.websocket.close(code, reason);
            });
        }
        return this.closePromise;
    }
    ping() {
        if (this.websocket) {
            this.websocket.ping();
        }
    }
    isConnected() {
        return (this.websocket !== null && this.websocket.readyState === ws_1.default.OPEN);
    }
    setMetadata(key, value) {
        this.metadata.set(key, value);
    }
    getMetadata(key) {
        return this.metadata.get(key);
    }
    async refreshSession(sessionStore) {
        try {
            const sessionId = this.getMetadata("sessionId");
            if (!sessionId)
                return false;
            const session = await sessionStore.get(sessionId);
            if (!session) {
                // Session invalid - close connection
                this.close(1008, "Session expired");
                return false;
            }
            session.lastAccessedAt = new Date();
            return sessionStore.update(sessionId, session);
        }
        catch (error) {
            this.events?.onError(this.connectionId, error);
            return false;
        }
    }
    startSessionRefresh(sessionStore) {
        if (this.sessionRefreshTimer) {
            clearInterval(this.sessionRefreshTimer);
        }
        this.sessionRefreshTimer = setInterval(() => this.refreshSession(sessionStore), WebsocketConnection.SESSION_REFRESH_INTERVAL);
    }
    stopSessionRefresh() {
        if (this.sessionRefreshTimer) {
            clearInterval(this.sessionRefreshTimer);
            this.sessionRefreshTimer = undefined;
        }
    }
    // Static method for broadcasting to multiple connections
    static broadcast(message, connections) {
        connections.forEach((connection) => {
            if (connection.isConnected()) {
                connection.send(message);
            }
        });
    }
    getSessionId() {
        return this.getMetadata("sessionId");
    }
    getConnectionStatus() {
        return {
            connectionId: this.getConnectionId(),
            lastActivityTime: this.lastActivityTime,
            lastHeartbeatResponse: this.lastHeartbeatResponse,
            messageCount: this.messageCount,
            authenticated: this.isAuthenticated(),
            sessionId: this.getSessionId(),
            metadata: Object.fromEntries(this.metadata.entries()),
        };
    }
}
exports.WebsocketConnection = WebsocketConnection;
WebsocketConnection.MAX_MESSAGE_SIZE = 1024 * 1024; // 1MB
WebsocketConnection.SESSION_REFRESH_INTERVAL = 60000; // 1 minute
WebsocketConnection.FORCED_CLOSE_TIMEOUT = 5000; // 5 seconds
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2Vic29ja2V0Q29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2aWNlcy9XZWJzb2NrZXRDb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRDQUEyQjtBQUUzQixtQ0FBb0M7QUFFcEMsa0NBQXlDO0FBUXpDLE1BQWEsbUJBQW1CO0lBbUI5QixZQUNVLGFBR0MsRUFDRCxXQUFvRCxFQUNwRCx1QkFBK0IsR0FBRyxFQUNsQyxNQUF5QixFQUNqQyxTQUFxQixFQUNiLG9CQUE0QixLQUFLLEVBQUUsYUFBYTtJQUNoRCxtQkFBMkIsSUFBSSxDQUFDLFlBQVk7O1FBVDVDLGtCQUFhLEdBQWIsYUFBYSxDQUdaO1FBQ0QsZ0JBQVcsR0FBWCxXQUFXLENBQXlDO1FBQ3BELHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBYztRQUNsQyxXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQUV6QixzQkFBaUIsR0FBakIsaUJBQWlCLENBQWdCO1FBQ2pDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBZTtRQXhCakMsMEJBQXFCLEdBQVcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBSzNDLGlCQUFZLEdBQVcsQ0FBQyxDQUFDO1FBQ3pCLGtCQUFhLEdBQVksS0FBSyxDQUFDO1FBQy9CLGFBQVEsR0FBcUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUN2QyxjQUFTLEdBQXFCLElBQUksQ0FBQztRQUNuQyx3QkFBbUIsR0FBWSxLQUFLLENBQUM7UUFDckMsaUJBQVksR0FBeUIsSUFBSSxDQUFDO1FBRTFDLG9CQUFlLEdBQVcsRUFBRSxDQUFDO1FBY25DLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3hDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFbkMsSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUNkLElBQUksQ0FBQyxZQUFZ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T0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDakMsSUFBSSxVQUFVLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQztnQkFDN0IsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMzQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sWUFBWTtRQUNqQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVNLG1CQUFtQjtRQUN4QixPQUFPO1lBQ0wsWUFBWSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDcEMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtZQUN2QyxxQkFBcUIsRUFBRSxJQUFJLENBQUMscUJBQXFCO1lBQ2pELFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtZQUMvQixhQUFhLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUNyQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUM5QixRQUFRLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3RELENBQUM7SUFDSixDQUFDOztBQWpaSCxrREFrWkM7QUFqWnlCLG9DQUFnQixHQUFHLElBQUksR0FBRyxJQUFJLEFBQWQsQ0FBZSxDQUFDLE1BQU07QUFDdEMsNENBQXdCLEdBQUcsS0FBSyxBQUFSLENBQVMsQ0FBQyxXQUFXO0FBQzdDLHdDQUFvQixHQUFHLElBQUksQUFBUCxDQUFRLENBQUMsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXZWJTb2NrZXQgZnJvbSBcIndzXCI7XG5pbXBvcnQgeyBJU2Vzc2lvblN0b3JlLCBJUmVxdWVzdCB9IGZyb20gXCIuLi9pbnRlcmZhY2VzXCI7XG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHsgSGVhcnRiZWF0UmVxdWVzdCB9IGZyb20gXCIuL1dlYlNvY2tldFNlcnZlclwiO1xuaW1wb3J0IHsgUmVxdWVzdEJ1aWxkZXIgfSBmcm9tIFwiLi4vY29yZVwiO1xuXG5pbnRlcmZhY2UgQ29ubmVjdGlvbkV2ZW50cyB7XG4gIG9uUmF0ZUxpbWl0OiAoY29ubmVjdGlvbklkOiBzdHJpbmcpID0+IHZvaWQ7XG4gIG9uRXJyb3I6IChjb25uZWN0aW9uSWQ6IHN0cmluZywgZXJyb3I6IEVycm9yKSA9PiB2b2lkO1xuICBvblNlY3VyaXR5VmlvbGF0aW9uOiAoY29ubmVjdGlvbklkOiBzdHJpbmcsIHZpb2xhdGlvbjogc3RyaW5nKSA9PiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgV2Vic29ja2V0Q29ubmVjdGlvbiB7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IE1BWF9NRVNTQUdFX1NJWkUgPSAxMDI0ICogMTAyNDsgLy8gMU1CXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IFNFU1NJT05fUkVGUkVTSF9JTlRFUlZBTCA9IDYwMDAwOyAvLyAxIG1pbnV0ZVxuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBGT1JDRURfQ0xPU0VfVElNRU9VVCA9IDUwMDA7IC8vIDUgc2Vjb25kc1xuXG4gIHByaXZhdGUgbGFzdEhlYXJ0YmVhdFJlc3BvbnNlOiBudW1iZXIgPSBEYXRlLm5vdygpO1xuICBwcml2YXRlIGhlYXJ0YmVhdFRpbWVyPzogTm9kZUpTLlRpbWVvdXQ7XG4gIHByaXZhdGUgaGVhcnRiZWF0VGltZW91dFRpbWVyPzogTm9kZUpTLlRpbWVvdXQ7XG4gIHByaXZhdGUgY29ubmVjdGlvbklkOiBzdHJpbmc7XG4gIHByaXZhdGUgbGFzdEFjdGl2aXR5VGltZTogbnVtYmVyO1xuICBwcml2YXRlIG1lc3NhZ2VDb3VudDogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBhdXRoZW50aWNhdGVkOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgbWV0YWRhdGE6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgd2Vic29ja2V0OiBXZWJTb2NrZXQgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBldmVudExpc3RlbmVyc1NldHVwOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgY2xvc2VQcm9taXNlOiBQcm9taXNlPHZvaWQ+IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgc2Vzc2lvblJlZnJlc2hUaW1lcj86IE5vZGVKUy5UaW1lb3V0O1xuICBwcml2YXRlIGxhc3RNZXNzYWdlSGFzaDogc3RyaW5nID0gXCJcIjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGhhbmRsZU1lc3NhZ2U6IChcbiAgICAgIGRhdGE6IFdlYlNvY2tldC5EYXRhLFxuICAgICAgd2Vic29ja2V0OiBXZWJzb2NrZXRDb25uZWN0aW9uXG4gICAgKSA9PiB2b2lkLFxuICAgIHByaXZhdGUgaGFuZGxlQ2xvc2U6IChjb25uZWN0aW9uSWQ6IHN0cmluZykgPT4gUHJvbWlzZTx2b2lkPixcbiAgICBwcml2YXRlIG1heE1lc3NhZ2VzUGVyTWludXRlOiBudW1iZXIgPSAxMDAsXG4gICAgcHJpdmF0ZSBldmVudHM/OiBDb25uZWN0aW9uRXZlbnRzLFxuICAgIHdlYnNvY2tldD86IFdlYlNvY2tldCxcbiAgICBwcml2YXRlIGhlYXJ0YmVhdEludGVydmFsOiBudW1iZXIgPSAzMDAwMCwgLy8gMzAgc2Vjb25kc1xuICAgIHByaXZhdGUgaGVhcnRiZWF0VGltZW91dDogbnVtYmVyID0gNTAwMCAvLyA1IHNlY29uZHNcbiAgKSB7XG4gICAgdGhpcy5jb25uZWN0aW9uSWQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpO1xuICAgIHRoaXMubGFzdEFjdGl2aXR5VGltZSA9IERhdGUubm93KCk7XG5cbiAgICBpZiAod2Vic29ja2V0KSB7XG4gICAgICB0aGlzLnNldFdlYlNvY2tldCh3ZWJzb2NrZXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhcnRIZWFydGJlYXQoKSB7XG4gICAgaWYgKHRoaXMuaGVhcnRiZWF0VGltZXIpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFydGJlYXRUaW1lcik7XG4gICAgfVxuXG4gICAgdGhpcy5oZWFydGJlYXRUaW1lciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHRoaXMuc2VuZEhlYXJ0YmVhdCgpO1xuICAgIH0sIHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWwpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZW5kSGVhcnRiZWF0KCkge1xuICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaGVhcnRiZWF0UmVxdWVzdCA9IG5ldyBSZXF1ZXN0QnVpbGRlcih7IHRpbWVzdGFtcDogRGF0ZS5ub3coKSB9KVxuICAgICAgLnNldFJlcXVpcmVzUmVzcG9uc2UodHJ1ZSlcbiAgICAgIC5zZXRSZXF1ZXN0VHlwZShcImhlYXJ0YmVhdFwiKVxuICAgICAgLnNldFJlcXVlc3RlckFkZHJlc3ModGhpcy5nZXRTZXNzaW9uSWQoKSB8fCB0aGlzLmNvbm5lY3Rpb25JZCk7XG5cbiAgICB0aGlzLnNlbmQoSlNPTi5zdHJpbmdpZnkoaGVhcnRiZWF0UmVxdWVzdC5idWlsZCgpKSk7XG5cbiAgICAvLyBTZXQgdGltZW91dCBmb3IgcmVzcG9uc2VcbiAgICB0aGlzLmhlYXJ0YmVhdFRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5ldmVudHM/Lm9uRXJyb3IodGhpcy5jb25uZWN0aW9uSWQsIG5ldyBFcnJvcihcIkhlYXJ0YmVhdCB0aW1lb3V0XCIpKTtcbiAgICAgIHRoaXMuY2xvc2UoMTAwMSwgXCJIZWFydGJlYXQgdGltZW91dFwiKTtcbiAgICB9LCB0aGlzLmhlYXJ0YmVhdFRpbWVvdXQpO1xuICB9XG5cbiAgcHVibGljIHNldFdlYlNvY2tldCh3ZWJzb2NrZXQ6IFdlYlNvY2tldCkge1xuICAgIGlmICh0aGlzLndlYnNvY2tldCkge1xuICAgICAgLy8gQ2xlYW4gdXAgZXhpc3RpbmcgY29ubmVjdGlvbiBmaXJzdFxuICAgICAgdGhpcy5jbGVhbnVwRXhpc3RpbmdDb25uZWN0aW9uKCk7XG4gICAgfVxuXG4gICAgdGhpcy53ZWJzb2NrZXQgPSB3ZWJzb2NrZXQ7XG4gICAgdGhpcy5zZXR1cEV2ZW50TGlzdGVuZXJzKCk7XG4gICAgdGhpcy5sYXN0QWN0aXZpdHlUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgICh0aGlzLndlYnNvY2tldCBhcyBhbnkpLm1heFBheWxvYWQgPSBXZWJzb2NrZXRDb25uZWN0aW9uLk1BWF9NRVNTQUdFX1NJWkU7XG4gIH1cblxuICBwcml2YXRlIGNsZWFudXBFeGlzdGluZ0Nvbm5lY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMud2Vic29ja2V0KSB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBSZW1vdmUgbGlzdGVuZXJzIGJlZm9yZSB0ZXJtaW5hdGluZyB0byBwcmV2ZW50IGFueSByYWNlIGNvbmRpdGlvbnNcbiAgICAgICAgdGhpcy53ZWJzb2NrZXQucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgICAgIGlmICh0aGlzLndlYnNvY2tldC5yZWFkeVN0YXRlICE9PSBXZWJTb2NrZXQuQ0xPU0VEKSB7XG4gICAgICAgICAgdGhpcy53ZWJzb2NrZXQudGVybWluYXRlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy53ZWJzb2NrZXQgPSBudWxsOyAvLyBDbGVhciB0aGUgcmVmZXJlbmNlXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmV2ZW50cz8ub25FcnJvcih0aGlzLmNvbm5lY3Rpb25JZCwgZXJyb3IgYXMgRXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBFdmVudExpc3RlbmVycygpIHtcbiAgICBpZiAoIXRoaXMud2Vic29ja2V0IHx8IHRoaXMuZXZlbnRMaXN0ZW5lcnNTZXR1cCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMud2Vic29ja2V0Lm9uKFwibWVzc2FnZVwiLCB0aGlzLmhhbmRsZVdlYnNvY2tldE1lc3NhZ2VzLmJpbmQodGhpcykpO1xuICAgIHRoaXMud2Vic29ja2V0Lm9uKFwiY2xvc2VcIiwgdGhpcy5oYW5kbGVDbG9zZUNvbm5lY3Rpb24uYmluZCh0aGlzKSk7XG4gICAgdGhpcy53ZWJzb2NrZXQub24oXCJwb25nXCIsIHRoaXMuaGFuZGxlUG9uZy5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLndlYnNvY2tldC5vbihcImVycm9yXCIsIHRoaXMuaGFuZGxlRXJyb3IuYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLndlYnNvY2tldC5vbihcbiAgICAgIFwidW5leHBlY3RlZC1yZXNwb25zZVwiLFxuICAgICAgdGhpcy5oYW5kbGVVbmV4cGVjdGVkUmVzcG9uc2UuYmluZCh0aGlzKVxuICAgICk7XG5cbiAgICB0aGlzLnN0YXJ0SGVhcnRiZWF0KCk7XG4gICAgdGhpcy5ldmVudExpc3RlbmVyc1NldHVwID0gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IEVycm9yKSB7XG4gICAgdGhpcy5ldmVudHM/Lm9uRXJyb3IodGhpcy5jb25uZWN0aW9uSWQsIGVycm9yKTtcbiAgICB0aGlzLmNsb3NlKDEwMDYsIFwiSW50ZXJuYWwgZXJyb3Igb2NjdXJyZWRcIik7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVVuZXhwZWN0ZWRSZXNwb25zZSgpIHtcbiAgICB0aGlzLmV2ZW50cz8ub25TZWN1cml0eVZpb2xhdGlvbihcbiAgICAgIHRoaXMuY29ubmVjdGlvbklkLFxuICAgICAgXCJVbmV4cGVjdGVkIHJlc3BvbnNlIHJlY2VpdmVkXCJcbiAgICApO1xuICAgIHRoaXMuY2xvc2UoMTAwNiwgXCJVbmV4cGVjdGVkIHJlc3BvbnNlXCIpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVQb25nKCkge1xuICAgIHRoaXMubGFzdEFjdGl2aXR5VGltZSA9IERhdGUubm93KCk7XG4gIH1cblxuICBwdWJsaWMgc2VuZChtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBpZiAoIXRoaXMud2Vic29ja2V0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3Qgc2VuZCBtZXNzYWdlOiBXZWJTb2NrZXQgbm90IGluaXRpYWxpemVkXCIpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBtZXNzYWdlIHNpemUgYmVmb3JlIHNlbmRpbmdcbiAgICAgIGNvbnN0IG1lc3NhZ2VTaXplID0gQnVmZmVyLmJ5dGVMZW5ndGgobWVzc2FnZSk7XG4gICAgICBpZiAobWVzc2FnZVNpemUgPiBXZWJzb2NrZXRDb25uZWN0aW9uLk1BWF9NRVNTQUdFX1NJWkUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTWVzc2FnZSBleGNlZWRzIG1heGltdW0gc2l6ZSBsaW1pdFwiKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy53ZWJzb2NrZXQuc2VuZChtZXNzYWdlKTtcbiAgICAgIHRoaXMubGFzdEFjdGl2aXR5VGltZSA9IERhdGUubm93KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuZXZlbnRzPy5vbkVycm9yKHRoaXMuY29ubmVjdGlvbklkLCBlcnJvciBhcyBFcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUNsb3NlQ29ubmVjdGlvbigpIHtcbiAgICBpZiAodGhpcy5jb25uZWN0aW9uSWQpIHtcbiAgICAgIHRoaXMuaGFuZGxlQ2xvc2UodGhpcy5jb25uZWN0aW9uSWQpLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICB0aGlzLmV2ZW50cz8ub25FcnJvcih0aGlzLmNvbm5lY3Rpb25JZCwgZXJyb3IgYXMgRXJyb3IpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBoYW5kbGVXZWJzb2NrZXRNZXNzYWdlcyhtZXNzYWdlOiBXZWJTb2NrZXQuRGF0YSkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxhc3RBY3Rpdml0eVRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgICAvLyBTaXplIGNoZWNrXG4gICAgICBjb25zdCBtZXNzYWdlU2l6ZSA9IHRoaXMuZ2V0RGF0YVNpemUobWVzc2FnZSk7XG4gICAgICBpZiAobWVzc2FnZVNpemUgPiBXZWJzb2NrZXRDb25uZWN0aW9uLk1BWF9NRVNTQUdFX1NJWkUpIHtcbiAgICAgICAgdGhpcy5ldmVudHM/Lm9uU2VjdXJpdHlWaW9sYXRpb24oXG4gICAgICAgICAgdGhpcy5jb25uZWN0aW9uSWQsXG4gICAgICAgICAgXCJNZXNzYWdlIHNpemUgZXhjZWVkZWRcIlxuICAgICAgICApO1xuICAgICAgICB0aGlzLnNlbmQoSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogXCJNZXNzYWdlIHRvbyBsYXJnZVwiIH0pKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBSYXRlIGxpbWl0aW5nXG4gICAgICBpZiAodGhpcy5pc1JhdGVMaW1pdGVkKCkpIHtcbiAgICAgICAgdGhpcy5ldmVudHM/Lm9uUmF0ZUxpbWl0KHRoaXMuY29ubmVjdGlvbklkKTtcbiAgICAgICAgdGhpcy5zZW5kKEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6IFwiUmF0ZSBsaW1pdCBleGNlZWRlZFwiIH0pKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBEZXRlY3QgbWVzc2FnZSByZXBsYXkgYXR0YWNrc1xuICAgICAgY29uc3QgbWVzc2FnZVN0cmluZyA9IHRoaXMuZGF0YVRvU3RyaW5nKG1lc3NhZ2UpO1xuICAgICAgY29uc3QgbWVzc2FnZUhhc2ggPSB0aGlzLmNhbGN1bGF0ZU1lc3NhZ2VIYXNoKG1lc3NhZ2VTdHJpbmcpO1xuICAgICAgaWYgKG1lc3NhZ2VIYXNoID09PSB0aGlzLmxhc3RNZXNzYWdlSGFzaCkge1xuICAgICAgICB0aGlzLmV2ZW50cz8ub25TZWN1cml0eVZpb2xhdGlvbihcbiAgICAgICAgICB0aGlzLmNvbm5lY3Rpb25JZCxcbiAgICAgICAgICBcIlBvc3NpYmxlIHJlcGxheSBhdHRhY2tcIlxuICAgICAgICApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLmxhc3RNZXNzYWdlSGFzaCA9IG1lc3NhZ2VIYXNoO1xuXG4gICAgICB0aGlzLm1lc3NhZ2VDb3VudCsrO1xuXG4gICAgICAvL1RPRE86IGxvb2sgZm9yIGEgbW9yZSBwZXJmb3JtYW50IHdheSB0byBkZXRlcm1pbmUgaWYgbWVzc2FnZSBpcyBoZWFydGJlYXQgcmVzcG9uc2UgKHdpdGhvdXQgSlNPTi5wYXJzZSBpdClcbiAgICAgIGNvbnN0IHBhcnNlZE1lc3NhZ2UgPSBKU09OLnBhcnNlKHRoaXMuZGF0YVRvU3RyaW5nKG1lc3NhZ2UpKTtcblxuICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhIGhlYXJ0YmVhdCByZXNwb25zZVxuICAgICAgaWYgKFxuICAgICAgICBwYXJzZWRNZXNzYWdlPy5yZXF1ZXN0SGVhZGVyPy5yZXF1ZXN0VHlwZSA9PT0gXCJoZWFydGJlYXRcIiAmJlxuICAgICAgICBwYXJzZWRNZXNzYWdlPy5ib2R5Py5zdWNjZXNzXG4gICAgICApIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaGVhcnRiZWF0VGltZW91dFRpbWVyKTtcbiAgICAgICAgdGhpcy5sYXN0SGVhcnRiZWF0UmVzcG9uc2UgPSBEYXRlLm5vdygpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMuaGFuZGxlTWVzc2FnZShtZXNzYWdlLCB0aGlzKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5ldmVudHM/Lm9uRXJyb3IodGhpcy5jb25uZWN0aW9uSWQsIGVycm9yIGFzIEVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNhbGN1bGF0ZU1lc3NhZ2VIYXNoKG1lc3NhZ2U6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNyZWF0ZUhhc2goXCJzaGEyNTZcIikudXBkYXRlKG1lc3NhZ2UpLmRpZ2VzdChcImhleFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgZGF0YVRvU3RyaW5nKGRhdGE6IFdlYlNvY2tldC5EYXRhKTogc3RyaW5nIHtcbiAgICBpZiAodHlwZW9mIGRhdGEgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH1cbiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgICAgcmV0dXJuIGRhdGEudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikge1xuICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGRhdGEpLnRvU3RyaW5nKCk7XG4gICAgfVxuICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XG4gICAgICByZXR1cm4gQnVmZmVyLmNvbmNhdChkYXRhKS50b1N0cmluZygpO1xuICAgIH1cbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGF0YVNpemUoZGF0YTogV2ViU29ja2V0LkRhdGEpOiBudW1iZXIge1xuICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIEJ1ZmZlci5ieXRlTGVuZ3RoKGRhdGEpO1xuICAgIH1cbiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgICAgcmV0dXJuIGRhdGEubGVuZ3RoO1xuICAgIH1cbiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7XG4gICAgICByZXR1cm4gZGF0YS5ieXRlTGVuZ3RoO1xuICAgIH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgICAgcmV0dXJuIGRhdGEucmVkdWNlKChhY2MsIGJ1ZikgPT4gYWNjICsgYnVmLmxlbmd0aCwgMCk7XG4gICAgfVxuICAgIHJldHVybiAwO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1JhdGVMaW1pdGVkKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG9uZU1pbnV0ZUFnbyA9IERhdGUubm93KCkgLSA2MDAwMDtcbiAgICBpZiAoXG4gICAgICB0aGlzLm1lc3NhZ2VDb3VudCA+IHRoaXMubWF4TWVzc2FnZXNQZXJNaW51dGUgJiZcbiAgICAgIHRoaXMubGFzdEFjdGl2aXR5VGltZSA+IG9uZU1pbnV0ZUFnb1xuICAgICkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmICh0aGlzLmxhc3RBY3Rpdml0eVRpbWUgPD0gb25lTWludXRlQWdvKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VDb3VudCA9IDA7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb25uZWN0aW9uSWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbklkO1xuICB9XG5cbiAgcHVibGljIHNldEF1dGhlbnRpY2F0ZWQodmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmF1dGhlbnRpY2F0ZWQgPSB2YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBpc0F1dGhlbnRpY2F0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRlZDtcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZShjb2RlPzogbnVtYmVyLCByZWFzb24/OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuY2xvc2VQcm9taXNlKSB7XG4gICAgICB0aGlzLmNsb3NlUHJvbWlzZSA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlKSA9PiB7XG4gICAgICAgIHRoaXMuc3RvcFNlc3Npb25SZWZyZXNoKCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLndlYnNvY2tldCB8fCB0aGlzLndlYnNvY2tldC5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuQ0xPU0VEKSB7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNsZWFudXAgPSAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5jbGVhbnVwRXhpc3RpbmdDb25uZWN0aW9uKCk7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8vIEltbWVkaWF0ZWx5IHRlcm1pbmF0ZSBhZnRlciB0aW1lb3V0IGluc3RlYWQgb2Ygd2FpdGluZ1xuICAgICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy53ZWJzb2NrZXQpIHtcbiAgICAgICAgICAgIHRoaXMud2Vic29ja2V0LnRlcm1pbmF0ZSgpO1xuICAgICAgICAgICAgY2xlYW51cCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgV2Vic29ja2V0Q29ubmVjdGlvbi5GT1JDRURfQ0xPU0VfVElNRU9VVCk7XG5cbiAgICAgICAgdGhpcy53ZWJzb2NrZXQub25jZShcImNsb3NlXCIsICgpID0+IHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcbiAgICAgICAgICBjbGVhbnVwKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLmhlYXJ0YmVhdFRpbWVyKSB7XG4gICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmhlYXJ0YmVhdFRpbWVyKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5oZWFydGJlYXRUaW1lb3V0VGltZXIpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5oZWFydGJlYXRUaW1lb3V0VGltZXIpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gSW5pdGlhdGUgZ3JhY2VmdWwgY2xvc2VcbiAgICAgICAgdGhpcy53ZWJzb2NrZXQuY2xvc2UoY29kZSwgcmVhc29uKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmNsb3NlUHJvbWlzZTtcbiAgfVxuXG4gIHB1YmxpYyBwaW5nKCkge1xuICAgIGlmICh0aGlzLndlYnNvY2tldCkge1xuICAgICAgdGhpcy53ZWJzb2NrZXQucGluZygpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpc0Nvbm5lY3RlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy53ZWJzb2NrZXQgIT09IG51bGwgJiYgdGhpcy53ZWJzb2NrZXQucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU5cbiAgICApO1xuICB9XG5cbiAgc2V0TWV0YWRhdGEoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLm1ldGFkYXRhLnNldChrZXksIHZhbHVlKTtcbiAgfVxuXG4gIGdldE1ldGFkYXRhKGtleTogc3RyaW5nKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5tZXRhZGF0YS5nZXQoa2V5KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZWZyZXNoU2Vzc2lvbihzZXNzaW9uU3RvcmU6IElTZXNzaW9uU3RvcmUpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2Vzc2lvbklkID0gdGhpcy5nZXRNZXRhZGF0YShcInNlc3Npb25JZFwiKTtcbiAgICAgIGlmICghc2Vzc2lvbklkKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCBzZXNzaW9uU3RvcmUuZ2V0KHNlc3Npb25JZCk7XG4gICAgICBpZiAoIXNlc3Npb24pIHtcbiAgICAgICAgLy8gU2Vzc2lvbiBpbnZhbGlkIC0gY2xvc2UgY29ubmVjdGlvblxuICAgICAgICB0aGlzLmNsb3NlKDEwMDgsIFwiU2Vzc2lvbiBleHBpcmVkXCIpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIHNlc3Npb24ubGFzdEFjY2Vzc2VkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgcmV0dXJuIHNlc3Npb25TdG9yZS51cGRhdGUoc2Vzc2lvbklkLCBzZXNzaW9uKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5ldmVudHM/Lm9uRXJyb3IodGhpcy5jb25uZWN0aW9uSWQsIGVycm9yIGFzIEVycm9yKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc3RhcnRTZXNzaW9uUmVmcmVzaChzZXNzaW9uU3RvcmU6IElTZXNzaW9uU3RvcmUpIHtcbiAgICBpZiAodGhpcy5zZXNzaW9uUmVmcmVzaFRpbWVyKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuc2Vzc2lvblJlZnJlc2hUaW1lcik7XG4gICAgfVxuXG4gICAgdGhpcy5zZXNzaW9uUmVmcmVzaFRpbWVyID0gc2V0SW50ZXJ2YWwoXG4gICAgICAoKSA9PiB0aGlzLnJlZnJlc2hTZXNzaW9uKHNlc3Npb25TdG9yZSksXG4gICAgICBXZWJzb2NrZXRDb25uZWN0aW9uLlNFU1NJT05fUkVGUkVTSF9JTlRFUlZBTFxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc3RvcFNlc3Npb25SZWZyZXNoKCkge1xuICAgIGlmICh0aGlzLnNlc3Npb25SZWZyZXNoVGltZXIpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5zZXNzaW9uUmVmcmVzaFRpbWVyKTtcbiAgICAgIHRoaXMuc2Vzc2lvblJlZnJlc2hUaW1lciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICAvLyBTdGF0aWMgbWV0aG9kIGZvciBicm9hZGNhc3RpbmcgdG8gbXVsdGlwbGUgY29ubmVjdGlvbnNcbiAgcHVibGljIHN0YXRpYyBicm9hZGNhc3QobWVzc2FnZTogc3RyaW5nLCBjb25uZWN0aW9uczogV2Vic29ja2V0Q29ubmVjdGlvbltdKSB7XG4gICAgY29ubmVjdGlvbnMuZm9yRWFjaCgoY29ubmVjdGlvbikgPT4ge1xuICAgICAgaWYgKGNvbm5lY3Rpb24uaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICBjb25uZWN0aW9uLnNlbmQobWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2Vzc2lvbklkKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0TWV0YWRhdGEoXCJzZXNzaW9uSWRcIik7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q29ubmVjdGlvblN0YXR1cygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpLFxuICAgICAgbGFzdEFjdGl2aXR5VGltZTogdGhpcy5sYXN0QWN0aXZpdHlUaW1lLFxuICAgICAgbGFzdEhlYXJ0YmVhdFJlc3BvbnNlOiB0aGlzLmxhc3RIZWFydGJlYXRSZXNwb25zZSxcbiAgICAgIG1lc3NhZ2VDb3VudDogdGhpcy5tZXNzYWdlQ291bnQsXG4gICAgICBhdXRoZW50aWNhdGVkOiB0aGlzLmlzQXV0aGVudGljYXRlZCgpLFxuICAgICAgc2Vzc2lvbklkOiB0aGlzLmdldFNlc3Npb25JZCgpLFxuICAgICAgbWV0YWRhdGE6IE9iamVjdC5mcm9tRW50cmllcyh0aGlzLm1ldGFkYXRhLmVudHJpZXMoKSksXG4gICAgfTtcbiAgfVxufVxuIl19