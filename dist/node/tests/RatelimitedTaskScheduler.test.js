"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const RateLimitedTaskScheduler_1 = require("../core/RateLimitedTaskScheduler");
const logging_1 = require("../logging");
class TestRateLimitedTaskScheduler extends RateLimitedTaskScheduler_1.RateLimitedTaskScheduler {
    getRunningTasks() {
        return this.runningTasks;
    }
    getTasksInitiatedInWindow() {
        return this.tasksInitiatedInWindow;
    }
    getQueueSize() {
        return this.queue.size();
    }
    debug(data) {
        console.log(data);
    }
}
describe("RateLimitedTaskScheduler", () => {
    let scheduler;
    let completedTasks;
    beforeEach(() => {
        jest.useFakeTimers();
        scheduler = new TestRateLimitedTaskScheduler(2, 3, 1000);
        completedTasks = [];
        scheduler.onTaskComplete((result) => completedTasks.push(result));
    });
    afterEach(() => {
        jest.useRealTimers();
        scheduler.destroy();
        logging_1.Loggable.shutdown();
    });
    const createTask = (delay) => async (input) => {
        await new Promise((resolve) => setTimeout(resolve, delay));
        return input * 2;
    };
    test("1. Scheduling a task will run it immediately if limits allow", async () => {
        const task = jest.fn().mockImplementation(async (input) => {
            await new Promise((resolve) => setImmediate(resolve));
            return input * 2;
        });
        scheduler.scheduleTask(task, 1);
        expect(scheduler.getRunningTasks()).toBe(1);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(1);
        expect(scheduler.getQueueSize()).toBe(0);
        // Advance all timers and wait for pending promises
        await jest.runAllTimersAsync();
        expect(completedTasks).toHaveLength(1);
        expect(completedTasks[0]).toEqual({ success: true, result: 2 });
    }, 10000);
    test("2. After reaching throttling limit, new tasks will be enqueued", async () => {
        const task = createTask(100);
        // Schedule tasks up to the concurrency limit
        scheduler.scheduleTask(task, 1);
        scheduler.scheduleTask(task, 2);
        // Check state after scheduling 2 tasks
        expect(scheduler.getRunningTasks()).toBe(2);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(2);
        expect(scheduler.getQueueSize()).toBe(0);
        // Schedule third task - should be enqueued due to concurrency limit
        scheduler.scheduleTask(task, 3);
        // Check state after scheduling 3rd task
        expect(scheduler.getRunningTasks()).toBe(2);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(2);
        expect(scheduler.getQueueSize()).toBe(1);
        // Schedule fourth task - should also be enqueued
        scheduler.scheduleTask(task, 4);
        // Check state after scheduling 4th task
        expect(scheduler.getRunningTasks()).toBe(2);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(2);
        expect(scheduler.getQueueSize()).toBe(2);
        // Advance time to complete the first two tasks
        await jest.advanceTimersByTimeAsync(100);
        // We will hit the throttling limit, so it should run 1 more task and enqueue the other.
        expect(scheduler.getRunningTasks()).toBe(1);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(3);
        expect(scheduler.getQueueSize()).toBe(1);
        // Complete the remaining tasks within the current window
        await jest.advanceTimersByTimeAsync(100);
        expect(scheduler.getRunningTasks()).toBe(0);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(3);
        expect(scheduler.getQueueSize()).toBe(1);
        // Next task should start running after the first throttling window elapses
        await jest.advanceTimersByTimeAsync(800);
        expect(scheduler.getRunningTasks()).toBe(1);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(1);
        expect(scheduler.getQueueSize()).toBe(0);
        // Finally all tasks must be complete
        await jest.advanceTimersByTimeAsync(800);
        expect(scheduler.getRunningTasks()).toBe(0);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(1);
        expect(scheduler.getQueueSize()).toBe(0);
    });
    test("3. After reaching concurrency limit, new tasks will be enqueued", async () => {
        const task = createTask(1000);
        // Schedule tasks up to the concurrency limit
        scheduler.scheduleTask(task, 1);
        scheduler.scheduleTask(task, 2);
        await jest.advanceTimersByTimeAsync(100);
        expect(scheduler.getRunningTasks()).toBe(2);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(2);
        expect(scheduler.getQueueSize()).toBe(0);
        // Schedule one more task
        scheduler.scheduleTask(task, 3);
        expect(scheduler.getRunningTasks()).toBe(2);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(2);
        expect(scheduler.getQueueSize()).toBe(1);
    });
    test("4. Task initiated immediately when slot becomes available within same throttling window", async () => {
        const fastTask = createTask(100);
        const slowTask = createTask(500);
        scheduler.scheduleTask(fastTask, 1);
        scheduler.scheduleTask(slowTask, 2);
        scheduler.scheduleTask(slowTask, 3);
        expect(scheduler.getRunningTasks()).toBe(2);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(2);
        expect(scheduler.getQueueSize()).toBe(1);
        await jest.advanceTimersByTimeAsync(100);
        expect(scheduler.getRunningTasks()).toBe(2);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(3);
        expect(scheduler.getQueueSize()).toBe(0);
    });
    test("5. Task initiated immediately when new throttling window starts", async () => {
        const task = createTask(1000);
        // Fill up the current window
        for (let i = 0; i < 3; i++) {
            scheduler.scheduleTask(task, i);
        }
        expect(scheduler.getTasksInitiatedInWindow()).toBe(2);
        expect(scheduler.getQueueSize()).toBe(1);
        // Move to the next window
        await jest.advanceTimersByTimeAsync(1000);
        expect(scheduler.getTasksInitiatedInWindow()).toBe(1);
        expect(scheduler.getRunningTasks()).toBe(1);
        expect(scheduler.getQueueSize()).toBe(0);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmF0ZWxpbWl0ZWRUYXNrU2NoZWR1bGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvdGVzdHMvUmF0ZWxpbWl0ZWRUYXNrU2NoZWR1bGVyLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrRUFHMEM7QUFDMUMsd0NBQXNDO0FBRXRDLE1BQU0sNEJBQTZCLFNBQVEsbURBRzFDO0lBQ1EsZUFBZTtRQUNwQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQztJQUVNLHlCQUF5QjtRQUM5QixPQUFPLElBQUksQ0FBQyxzQkFBc0IsQ0FBQztJQUNyQyxDQUFDO0lBRU0sWUFBWTtRQUNqQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVTLEtBQUssQ0FBQyxJQUFTO1FBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBRUQsUUFBUSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtJQUN4QyxJQUFJLFNBQXVDLENBQUM7SUFDNUMsSUFBSSxjQUFvQyxDQUFDO0lBRXpDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsU0FBUyxHQUFHLElBQUksNEJBQTRCLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN6RCxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNwRSxDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FB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QyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgUmF0ZUxpbWl0ZWRUYXNrU2NoZWR1bGVyLFxuICBUYXNrT3V0cHV0LFxufSBmcm9tIFwiLi4vY29yZS9SYXRlTGltaXRlZFRhc2tTY2hlZHVsZXJcIjtcbmltcG9ydCB7IExvZ2dhYmxlIH0gZnJvbSBcIi4uL2xvZ2dpbmdcIjtcblxuY2xhc3MgVGVzdFJhdGVMaW1pdGVkVGFza1NjaGVkdWxlciBleHRlbmRzIFJhdGVMaW1pdGVkVGFza1NjaGVkdWxlcjxcbiAgbnVtYmVyLFxuICBudW1iZXJcbj4ge1xuICBwdWJsaWMgZ2V0UnVubmluZ1Rhc2tzKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMucnVubmluZ1Rhc2tzO1xuICB9XG5cbiAgcHVibGljIGdldFRhc2tzSW5pdGlhdGVkSW5XaW5kb3coKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy50YXNrc0luaXRpYXRlZEluV2luZG93O1xuICB9XG5cbiAgcHVibGljIGdldFF1ZXVlU2l6ZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnF1ZXVlLnNpemUoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBkZWJ1ZyhkYXRhOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgfVxufVxuXG5kZXNjcmliZShcIlJhdGVMaW1pdGVkVGFza1NjaGVkdWxlclwiLCAoKSA9PiB7XG4gIGxldCBzY2hlZHVsZXI6IFRlc3RSYXRlTGltaXRlZFRhc2tTY2hlZHVsZXI7XG4gIGxldCBjb21wbGV0ZWRUYXNrczogVGFza091dHB1dDxudW1iZXI+W107XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC51c2VGYWtlVGltZXJzKCk7XG4gICAgc2NoZWR1bGVyID0gbmV3IFRlc3RSYXRlTGltaXRlZFRhc2tTY2hlZHVsZXIoMiwgMywgMTAwMCk7XG4gICAgY29tcGxldGVkVGFza3MgPSBbXTtcbiAgICBzY2hlZHVsZXIub25UYXNrQ29tcGxldGUoKHJlc3VsdCkgPT4gY29tcGxldGVkVGFza3MucHVzaChyZXN1bHQpKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcbiAgICBzY2hlZHVsZXIuZGVzdHJveSgpO1xuICAgIExvZ2dhYmxlLnNodXRkb3duKCk7XG4gIH0pO1xuXG4gIGNvbnN0IGNyZWF0ZVRhc2sgPVxuICAgIChkZWxheTogbnVtYmVyKSA9PlxuICAgIGFzeW5jIChpbnB1dDogbnVtYmVyKTogUHJvbWlzZTxudW1iZXI+ID0+IHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIGRlbGF5KSk7XG4gICAgICByZXR1cm4gaW5wdXQgKiAyO1xuICAgIH07XG5cbiAgdGVzdChcIjEuIFNjaGVkdWxpbmcgYSB0YXNrIHdpbGwgcnVuIGl0IGltbWVkaWF0ZWx5IGlmIGxpbWl0cyBhbGxvd1wiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgdGFzayA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKGlucHV0OiBudW1iZXIpID0+IHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRJbW1lZGlhdGUocmVzb2x2ZSkpO1xuICAgICAgcmV0dXJuIGlucHV0ICogMjtcbiAgICB9KTtcblxuICAgIHNjaGVkdWxlci5zY2hlZHVsZVRhc2sodGFzaywgMSk7XG5cbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFJ1bm5pbmdUYXNrcygpKS50b0JlKDEpO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0VGFza3NJbml0aWF0ZWRJbldpbmRvdygpKS50b0JlKDEpO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UXVldWVTaXplKCkpLnRvQmUoMCk7XG5cbiAgICAvLyBBZHZhbmNlIGFsbCB0aW1lcnMgYW5kIHdhaXQgZm9yIHBlbmRpbmcgcHJvbWlzZXNcbiAgICBhd2FpdCBqZXN0LnJ1bkFsbFRpbWVyc0FzeW5jKCk7XG5cbiAgICBleHBlY3QoY29tcGxldGVkVGFza3MpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICBleHBlY3QoY29tcGxldGVkVGFza3NbMF0pLnRvRXF1YWwoeyBzdWNjZXNzOiB0cnVlLCByZXN1bHQ6IDIgfSk7XG4gIH0sIDEwMDAwKTtcblxuICB0ZXN0KFwiMi4gQWZ0ZXIgcmVhY2hpbmcgdGhyb3R0bGluZyBsaW1pdCwgbmV3IHRhc2tzIHdpbGwgYmUgZW5xdWV1ZWRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHRhc2sgPSBjcmVhdGVUYXNrKDEwMCk7XG5cbiAgICAvLyBTY2hlZHVsZSB0YXNrcyB1cCB0byB0aGUgY29uY3VycmVuY3kgbGltaXRcbiAgICBzY2hlZHVsZXIuc2NoZWR1bGVUYXNrKHRhc2ssIDEpO1xuICAgIHNjaGVkdWxlci5zY2hlZHVsZVRhc2sodGFzaywgMik7XG5cbiAgICAvLyBDaGVjayBzdGF0ZSBhZnRlciBzY2hlZHVsaW5nIDIgdGFza3NcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFJ1bm5pbmdUYXNrcygpKS50b0JlKDIpO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0VGFza3NJbml0aWF0ZWRJbldpbmRvdygpKS50b0JlKDIpO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UXVldWVTaXplKCkpLnRvQmUoMCk7XG5cbiAgICAvLyBTY2hlZHVsZSB0aGlyZCB0YXNrIC0gc2hvdWxkIGJlIGVucXVldWVkIGR1ZSB0byBjb25jdXJyZW5jeSBsaW1pdFxuICAgIHNjaGVkdWxlci5zY2hlZHVsZVRhc2sodGFzaywgMyk7XG5cbiAgICAvLyBDaGVjayBzdGF0ZSBhZnRlciBzY2hlZHVsaW5nIDNyZCB0YXNrXG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRSdW5uaW5nVGFza3MoKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFRhc2tzSW5pdGlhdGVkSW5XaW5kb3coKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFF1ZXVlU2l6ZSgpKS50b0JlKDEpO1xuXG4gICAgLy8gU2NoZWR1bGUgZm91cnRoIHRhc2sgLSBzaG91bGQgYWxzbyBiZSBlbnF1ZXVlZFxuICAgIHNjaGVkdWxlci5zY2hlZHVsZVRhc2sodGFzaywgNCk7XG5cbiAgICAvLyBDaGVjayBzdGF0ZSBhZnRlciBzY2hlZHVsaW5nIDR0aCB0YXNrXG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRSdW5uaW5nVGFza3MoKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFRhc2tzSW5pdGlhdGVkSW5XaW5kb3coKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFF1ZXVlU2l6ZSgpKS50b0JlKDIpO1xuXG4gICAgLy8gQWR2YW5jZSB0aW1lIHRvIGNvbXBsZXRlIHRoZSBmaXJzdCB0d28gdGFza3NcbiAgICBhd2FpdCBqZXN0LmFkdmFuY2VUaW1lcnNCeVRpbWVBc3luYygxMDApO1xuXG4gICAgLy8gV2Ugd2lsbCBoaXQgdGhlIHRocm90dGxpbmcgbGltaXQsIHNvIGl0IHNob3VsZCBydW4gMSBtb3JlIHRhc2sgYW5kIGVucXVldWUgdGhlIG90aGVyLlxuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UnVubmluZ1Rhc2tzKCkpLnRvQmUoMSk7XG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRUYXNrc0luaXRpYXRlZEluV2luZG93KCkpLnRvQmUoMyk7XG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRRdWV1ZVNpemUoKSkudG9CZSgxKTtcblxuICAgIC8vIENvbXBsZXRlIHRoZSByZW1haW5pbmcgdGFza3Mgd2l0aGluIHRoZSBjdXJyZW50IHdpbmRvd1xuICAgIGF3YWl0IGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZUFzeW5jKDEwMCk7XG5cbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFJ1bm5pbmdUYXNrcygpKS50b0JlKDApO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0VGFza3NJbml0aWF0ZWRJbldpbmRvdygpKS50b0JlKDMpO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UXVldWVTaXplKCkpLnRvQmUoMSk7XG5cbiAgICAvLyBOZXh0IHRhc2sgc2hvdWxkIHN0YXJ0IHJ1bm5pbmcgYWZ0ZXIgdGhlIGZpcnN0IHRocm90dGxpbmcgd2luZG93IGVsYXBzZXNcbiAgICBhd2FpdCBqZXN0LmFkdmFuY2VUaW1lcnNCeVRpbWVBc3luYyg4MDApO1xuXG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRSdW5uaW5nVGFza3MoKSkudG9CZSgxKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFRhc2tzSW5pdGlhdGVkSW5XaW5kb3coKSkudG9CZSgxKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFF1ZXVlU2l6ZSgpKS50b0JlKDApO1xuXG4gICAgLy8gRmluYWxseSBhbGwgdGFza3MgbXVzdCBiZSBjb21wbGV0ZVxuICAgIGF3YWl0IGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZUFzeW5jKDgwMCk7XG5cbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFJ1bm5pbmdUYXNrcygpKS50b0JlKDApO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0VGFza3NJbml0aWF0ZWRJbldpbmRvdygpKS50b0JlKDEpO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UXVldWVTaXplKCkpLnRvQmUoMCk7XG4gIH0pO1xuXG4gIHRlc3QoXCIzLiBBZnRlciByZWFjaGluZyBjb25jdXJyZW5jeSBsaW1pdCwgbmV3IHRhc2tzIHdpbGwgYmUgZW5xdWV1ZWRcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHRhc2sgPSBjcmVhdGVUYXNrKDEwMDApO1xuXG4gICAgLy8gU2NoZWR1bGUgdGFza3MgdXAgdG8gdGhlIGNvbmN1cnJlbmN5IGxpbWl0XG4gICAgc2NoZWR1bGVyLnNjaGVkdWxlVGFzayh0YXNrLCAxKTtcbiAgICBzY2hlZHVsZXIuc2NoZWR1bGVUYXNrKHRhc2ssIDIpO1xuXG4gICAgYXdhaXQgamVzdC5hZHZhbmNlVGltZXJzQnlUaW1lQXN5bmMoMTAwKTtcblxuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UnVubmluZ1Rhc2tzKCkpLnRvQmUoMik7XG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRUYXNrc0luaXRpYXRlZEluV2luZG93KCkpLnRvQmUoMik7XG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRRdWV1ZVNpemUoKSkudG9CZSgwKTtcblxuICAgIC8vIFNjaGVkdWxlIG9uZSBtb3JlIHRhc2tcbiAgICBzY2hlZHVsZXIuc2NoZWR1bGVUYXNrKHRhc2ssIDMpO1xuXG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRSdW5uaW5nVGFza3MoKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFRhc2tzSW5pdGlhdGVkSW5XaW5kb3coKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFF1ZXVlU2l6ZSgpKS50b0JlKDEpO1xuICB9KTtcblxuICB0ZXN0KFwiNC4gVGFzayBpbml0aWF0ZWQgaW1tZWRpYXRlbHkgd2hlbiBzbG90IGJlY29tZXMgYXZhaWxhYmxlIHdpdGhpbiBzYW1lIHRocm90dGxpbmcgd2luZG93XCIsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBmYXN0VGFzayA9IGNyZWF0ZVRhc2soMTAwKTtcbiAgICBjb25zdCBzbG93VGFzayA9IGNyZWF0ZVRhc2soNTAwKTtcblxuICAgIHNjaGVkdWxlci5zY2hlZHVsZVRhc2soZmFzdFRhc2ssIDEpO1xuICAgIHNjaGVkdWxlci5zY2hlZHVsZVRhc2soc2xvd1Rhc2ssIDIpO1xuICAgIHNjaGVkdWxlci5zY2hlZHVsZVRhc2soc2xvd1Rhc2ssIDMpO1xuXG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRSdW5uaW5nVGFza3MoKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFRhc2tzSW5pdGlhdGVkSW5XaW5kb3coKSkudG9CZSgyKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFF1ZXVlU2l6ZSgpKS50b0JlKDEpO1xuXG4gICAgYXdhaXQgamVzdC5hZHZhbmNlVGltZXJzQnlUaW1lQXN5bmMoMTAwKTtcblxuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UnVubmluZ1Rhc2tzKCkpLnRvQmUoMik7XG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRUYXNrc0luaXRpYXRlZEluV2luZG93KCkpLnRvQmUoMyk7XG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRRdWV1ZVNpemUoKSkudG9CZSgwKTtcbiAgfSk7XG5cbiAgdGVzdChcIjUuIFRhc2sgaW5pdGlhdGVkIGltbWVkaWF0ZWx5IHdoZW4gbmV3IHRocm90dGxpbmcgd2luZG93IHN0YXJ0c1wiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgdGFzayA9IGNyZWF0ZVRhc2soMTAwMCk7XG5cbiAgICAvLyBGaWxsIHVwIHRoZSBjdXJyZW50IHdpbmRvd1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7XG4gICAgICBzY2hlZHVsZXIuc2NoZWR1bGVUYXNrKHRhc2ssIGkpO1xuICAgIH1cblxuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0VGFza3NJbml0aWF0ZWRJbldpbmRvdygpKS50b0JlKDIpO1xuICAgIGV4cGVjdChzY2hlZHVsZXIuZ2V0UXVldWVTaXplKCkpLnRvQmUoMSk7XG5cbiAgICAvLyBNb3ZlIHRvIHRoZSBuZXh0IHdpbmRvd1xuICAgIGF3YWl0IGplc3QuYWR2YW5jZVRpbWVyc0J5VGltZUFzeW5jKDEwMDApO1xuXG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRUYXNrc0luaXRpYXRlZEluV2luZG93KCkpLnRvQmUoMSk7XG4gICAgZXhwZWN0KHNjaGVkdWxlci5nZXRSdW5uaW5nVGFza3MoKSkudG9CZSgxKTtcbiAgICBleHBlY3Qoc2NoZWR1bGVyLmdldFF1ZXVlU2l6ZSgpKS50b0JlKDApO1xuICB9KTtcbn0pO1xuIl19