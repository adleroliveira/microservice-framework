"use strict";var MicroserviceFramework=(()=>{var G=Object.create;var R=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty;var F=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports),z=(n,t)=>{for(var e in t)R(n,e,{get:t[e],enumerable:!0})},T=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of B(t))!V.call(n,o)&&o!==e&&R(n,o,{get:()=>t[o],enumerable:!(r=U(t,o))||r.enumerable});return n};var X=(n,t,e)=>(e=n!=null?G(j(n)):{},T(t||!n||!n.__esModule?R(e,"default",{value:n,enumerable:!0}):e,n)),J=n=>T(R({},"__esModule",{value:!0}),n);var L=F((oe,E)=>{"use strict";var K=Object.prototype.hasOwnProperty,g="~";function b(){}Object.create&&(b.prototype=Object.create(null),new b().__proto__||(g=!1));function Y(n,t,e){this.fn=n,this.context=t,this.once=e||!1}function N(n,t,e,r,o){if(typeof e!="function")throw new TypeError("The listener must be a function");var i=new Y(e,r||n,o),a=g?g+t:t;return n._events[a]?n._events[a].fn?n._events[a]=[n._events[a],i]:n._events[a].push(i):(n._events[a]=i,n._eventsCount++),n}function M(n,t){--n._eventsCount===0?n._events=new b:delete n._events[t]}function l(){this._events=new b,this._eventsCount=0}l.prototype.eventNames=function(){var t=[],e,r;if(this._eventsCount===0)return t;for(r in e=this._events)K.call(e,r)&&t.push(g?r.slice(1):r);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};l.prototype.listeners=function(t){var e=g?g+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var o=0,i=r.length,a=new Array(i);o<i;o++)a[o]=r[o].fn;return a};l.prototype.listenerCount=function(t){var e=g?g+t:t,r=this._events[e];return r?r.fn?1:r.length:0};l.prototype.emit=function(t,e,r,o,i,a){var u=g?g+t:t;if(!this._events[u])return!1;var s=this._events[u],p=arguments.length,d,c;if(s.fn){switch(s.once&&this.removeListener(t,s.fn,void 0,!0),p){case 1:return s.fn.call(s.context),!0;case 2:return s.fn.call(s.context,e),!0;case 3:return s.fn.call(s.context,e,r),!0;case 4:return s.fn.call(s.context,e,r,o),!0;case 5:return s.fn.call(s.context,e,r,o,i),!0;case 6:return s.fn.call(s.context,e,r,o,i,a),!0}for(c=1,d=new Array(p-1);c<p;c++)d[c-1]=arguments[c];s.fn.apply(s.context,d)}else{var H=s.length,y;for(c=0;c<H;c++)switch(s[c].once&&this.removeListener(t,s[c].fn,void 0,!0),p){case 1:s[c].fn.call(s[c].context);break;case 2:s[c].fn.call(s[c].context,e);break;case 3:s[c].fn.call(s[c].context,e,r);break;case 4:s[c].fn.call(s[c].context,e,r,o);break;default:if(!d)for(y=1,d=new Array(p-1);y<p;y++)d[y-1]=arguments[y];s[c].fn.apply(s[c].context,d)}}return!0};l.prototype.on=function(t,e,r){return N(this,t,e,r,!1)};l.prototype.once=function(t,e,r){return N(this,t,e,r,!0)};l.prototype.removeListener=function(t,e,r,o){var i=g?g+t:t;if(!this._events[i])return this;if(!e)return M(this,i),this;var a=this._events[i];if(a.fn)a.fn===e&&(!o||a.once)&&(!r||a.context===r)&&M(this,i);else{for(var u=0,s=[],p=a.length;u<p;u++)(a[u].fn!==e||o&&!a[u].once||r&&a[u].context!==r)&&s.push(a[u]);s.length?this._events[i]=s.length===1?s[0]:s:M(this,i)}return this};l.prototype.removeAllListeners=function(t){var e;return t?(e=g?g+t:t,this._events[e]&&M(this,e)):(this._events=new b,this._eventsCount=0),this};l.prototype.off=l.prototype.removeListener;l.prototype.addListener=l.prototype.on;l.prefixed=g;l.EventEmitter=l;typeof E<"u"&&(E.exports=l)});var re={};z(re,{AuthMethod:()=>x,BrowserConsoleStrategy:()=>m,CommunicationsManager:()=>O,WebSocketManager:()=>S,WebSocketState:()=>$});var _=X(L(),1);var f=_.default;var k,Q=new Uint8Array(16);function q(){if(!k&&(k=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!k))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return k(Q)}var P=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Z(n){return typeof n=="string"&&P.test(n)}var W=Z;var h=[];for(A=0;A<256;++A)h.push((A+256).toString(16).substr(1));var A;function ee(n){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=(h[n[t+0]]+h[n[t+1]]+h[n[t+2]]+h[n[t+3]]+"-"+h[n[t+4]]+h[n[t+5]]+"-"+h[n[t+6]]+h[n[t+7]]+"-"+h[n[t+8]]+h[n[t+9]]+"-"+h[n[t+10]]+h[n[t+11]]+h[n[t+12]]+h[n[t+13]]+h[n[t+14]]+h[n[t+15]]).toLowerCase();if(!W(e))throw TypeError("Stringified UUID is invalid");return e}var D=ee;function te(n,t,e){n=n||{};var r=n.random||(n.rng||q)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){e=e||0;for(var o=0;o<16;++o)t[e+o]=r[o];return t}return D(r)}var v=te;var C=class n{constructor(){}async send(t,e){let r=n.truncateAndStringify(t,0,this.MAX_STRING_LENGTH,this.MAX_DEPTH),o={header:this.createRequestHeader(),body:r};await this.sendPackaged(o,e)}createRequestHeader(){return{timestamp:Date.now(),requestId:v(),requesterAddress:"log-strategy",requestType:"LOG::MESSAGE"}}static truncateAndStringify(t,e=0,r=5e3,o=10){if(e>o)return"[Object depth limit exceeded]";if(t==null)return t;if(typeof t=="string")return t.length>r?t.substring(0,r)+"...":t;if(typeof t=="number"||typeof t=="boolean")return t;if(t instanceof Error)return{name:t.name,message:this.truncateAndStringify(t.message),stack:this.truncateAndStringify(t.stack)};if(this.isBufferOrArrayBufferView(t))return`[Binary data of length ${t.byteLength}]`;if(Array.isArray(t))return t.map(i=>this.truncateAndStringify(i,e+1));if(typeof t=="object"){let i={};for(let[a,u]of Object.entries(t))i[a]=this.truncateAndStringify(u,e+1);return i}return"[Unserializable data]"}static isBufferOrArrayBufferView(t){return!!(typeof Buffer<"u"&&Buffer.isBuffer(t)||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)}};var w=class w extends C{constructor(t=5e3,e=10){super(),this.MAX_STRING_LENGTH=t,this.MAX_DEPTH=e}isLogMessage(t){return typeof t=="object"&&t!==null&&"timestamp"in t&&"level"in t&&"message"in t}async sendPackaged(t,e){let{header:r,body:o}=t,i=e?.logLevel||1;this.isLogMessage(o)?this.formatLogMessage(o,r.requestId):this.formatGenericMessage(o,i,r.timestamp,r.requestId)}formatLogMessage(t,e){let{sender:r,timestamp:o,level:i,message:a,payload:u}=t,s=parseInt(i)||1,p=w.LOG_COLORS[s];console.groupCollapsed(`%c[${s}] ${new Date(o).toISOString()}`,p),r&&console.log(`Sender: ${r}`),console.log(`Message: ${a}`),console.log(`RequestID: ${e}`),u&&console.log("Payload:",u),console.groupEnd()}formatGenericMessage(t,e,r,o){let i=w.LOG_COLORS[e];console.groupCollapsed(`%c[${e}] ${new Date(r).toISOString()}`,i),console.log(`RequestID: ${o}`),typeof t=="object"&&t!==null?console.log("Message:",t):console.log(`Message: ${t}`),console.groupEnd()}async log(t,e=1){await this.send(t,{logLevel:e})}async info(t,e){await this.log({message:t,data:e},1)}async warn(t,e){await this.log({message:t,data:e},2)}async error(t,e){await this.log({message:t,data:e},3)}async debug(t,e){await this.log({message:t,data:e},0)}};w.LOG_COLORS={1:"color: blue",2:"color: orange",3:"color: red",0:"color: green"};var m=w;var $=(o=>(o[o.CONNECTING=0]="CONNECTING",o[o.OPEN=1]="OPEN",o[o.CLOSING=2]="CLOSING",o[o.CLOSED=3]="CLOSED",o))($||{}),x=(r=>(r.TOKEN="token",r.CREDENTIALS="credentials",r.ANONYMOUS="anonymous",r))(x||{}),S=class extends f{constructor(e){super();this.reconnectAttempts=0;this.state=3;this.protocols=[];this.logger=new m,this.url=e.url,this.secure=e.secure||!1,this.auth=e.auth,this.maxReconnectAttempts=e.maxReconnectAttempts||5,this.reconnectInterval=e.reconnectInterval||5e3,this.connectionTimeout=e.connectionTimeout||1e4,this.setupAuthProtocols(),this.connect()}setupAuthProtocols(){if(this.auth)switch(this.auth.method){case"token":this.auth.token&&this.protocols.push(`token-${this.auth.token}`);break;case"credentials":if(this.auth.credentials){let{username:e,password:r}=this.auth.credentials,o=btoa(encodeURIComponent(r)).replace(/=/g,"");this.protocols.push(`auth-${e}-${o}`),this.logger.debug("Auth protocol",this.protocols)}break}}connect(){this.state=0;let e=this.getSecureUrl(this.url,this.secure),r=this.auth?.method==="token"&&this.auth.token?`${e}?token=${this.auth.token}`:e;this.logger.info(`Attempting to connect to ${r}`);try{this.ws=new WebSocket(r,this.protocols),this.setHooks(),this.setConnectionTimeout()}catch(o){this.handleConnectionError(o)}}handleConnectionError(e){this.logger.error("Connection error:",e),this.emit("error",{type:"CONNECTION_ERROR",message:"Failed to establish WebSocket connection",error:e})}getSecureUrl(e,r){return r?e.replace(/^ws:/,"wss:"):e}setHooks(){this.ws.onopen=()=>{this.clearConnectionTimeout(),this.state=1,this.reconnectAttempts=0,this.logger.info(`WebSocket opened. ReadyState: ${this.ws.readyState}`),this.emit("open")},this.ws.onerror=e=>{let r=e.target;if(r.readyState===WebSocket.CLOSED){let o={type:"CONNECTION_ERROR",message:"Connection failed",readyState:r.readyState,url:r.url};this.reconnectAttempts===0&&(o.type="AUTH_ERROR",o.message="Authentication required"),this.logger.error("WebSocket error:",o),this.emit("error",o)}else this.logger.error("WebSocket error:",e),this.emit("error",e)},this.ws.onclose=e=>{if(this.clearConnectionTimeout(),this.state=3,e.code===1001||e.code===1006||e.code===1008){let r={type:"AUTH_ERROR",code:e.code,reason:e.reason||"Authentication required"};this.emit("error",r);return}this.logger.info(`WebSocket closed. ReadyState: ${this.ws.readyState}. Code: ${e.code}, Reason: ${e.reason}`),this.emit("close",e),this.handleReconnection()},this.ws.onmessage=e=>{let r=this.parseMessage(e.data);this.emit("message",r)}}handleReconnection(){if(this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;let r=Math.max(1e3,this.reconnectInterval*Math.pow(2,this.reconnectAttempts-1));this.logger.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${r}ms...`),setTimeout(()=>this.connect(),r)}else this.logger.error("Max reconnection attempts reached. Please reconnect manually."),this.emit("maxReconnectAttemptsReached")}setConnectionTimeout(){this.connectionTimer=window.setTimeout(()=>{this.state===0&&(this.logger.error("Connection attempt timed out"),this.ws.close())},this.connectionTimeout)}clearConnectionTimeout(){this.connectionTimer&&window.clearTimeout(this.connectionTimer)}parseMessage(e){try{return JSON.parse(e)}catch{return e}}send(e){if(this.state===1){let r=typeof e=="string"?e:JSON.stringify(e);this.ws.send(r)}else{let r=new Error("WebSocket is not open");this.emit("error",r)}}close(){this.state=2,this.ws.close()}reconnect(){this.logger.debug("Manual reconnection initiated."),this.reconnectAttempts=0,this.close(),this.connect()}getState(){return this.state}getReadyState(){return this.ws.readyState}setAuthConfig(e){this.auth=e,this.setupAuthProtocols()}isAuthenticated(){return this.state===1}reconnectWithNewAuth(e){this.setAuthConfig(e),this.reconnect()}destroy(){this.clearConnectionTimeout(),this.ws&&(this.ws.onopen=null,this.ws.onclose=null,this.ws.onerror=null,this.ws.onmessage=null,this.state!==3&&this.close(),this.ws=null),this.removeAllListeners(),this.logger=null,this.auth=void 0,this.protocols=[]}};var I=class extends f{constructor(e){super();this.pendingRequests=new Map;this.logger=new m,this.requestTimeout=e.requestTimeout||3e4,this.webSocketManager=e.webSocketManager,this.webSocketManager.on("message",this.handleMessage.bind(this))}async request(e,r,o){return new Promise((i,a)=>{let u=this.createRequest(e,r,o),s=setTimeout(()=>{this.pendingRequests.delete(u.header.requestId),a(new Error("Request timeout"))},this.requestTimeout),p=d=>{clearTimeout(s),this.pendingRequests.delete(u.header.requestId),d.body.success?i(d.body):a(d.body.error||d.body.data)};this.pendingRequests.set(u.header.requestId,p),this.webSocketManager.send(JSON.stringify(u))})}createRequest(e,r,o){return{header:{timestamp:Date.now(),requestId:`RM-${v()}`,requesterAddress:"RequestManager",recipientAddress:o,requestType:e,authToken:this.authToken},body:r}}handleMessage(e){try{e.header&&e.header.requestType?this.handleIncomingRequest(e):e.requestHeader?this.handleResponse(e):this.logger.warn("Received message with unknown structure:",e)}catch(r){this.logger.error("Error parsing message:",r)}}handleIncomingRequest(e){let{requestType:r}=e.header;r&&this.listenerCount(r)>0?this.emit(r,e.body,o=>{let i={requestHeader:e.header,responseHeader:{responderAddress:"RequestManager",timestamp:Date.now()},body:{data:o,success:!0,error:null}};this.webSocketManager.send(JSON.stringify(i))}):this.logger.warn(`No handlers registered for requestType: ${r}`)}handleResponse(e){let r=this.pendingRequests.get(e.requestHeader.requestId);r&&(r(e),this.pendingRequests.delete(e.requestHeader.requestId))}setAuthToken(e){this.authToken=e}clearAuthToken(){this.authToken=void 0}clearState(){for(let[e]of this.pendingRequests)this.pendingRequests.delete(e);this.clearAuthToken()}destroy(){for(let[e]of this.pendingRequests)this.pendingRequests.delete(e);this.webSocketManager.removeListener("message",this.handleMessage.bind(this)),this.removeAllListeners(),this.clearAuthToken(),this.webSocketManager=null,this.logger=null,this.pendingRequests=null}};var O=class extends f{constructor(e){super();this.logger=new m;this.config=e,this.validateConfig(e);try{this.initializeManagers(e)}catch(r){throw this.logger.error("Error initializing CommunicationsManager",{error:r}),new Error("Failed to initialize CommunicationsManager")}}initializeManagers(e){this.webSocketManager=new S({url:e.url,secure:e.secure,auth:e.auth,maxReconnectAttempts:e.maxReconnectAttempts,reconnectInterval:e.reconnectInterval}),this.requestManager=new I({webSocketManager:this.webSocketManager,requestTimeout:e.requestTimeout}),this.setupWebSocketHooks()}async cleanupCurrentState(){this.webSocketManager.removeAllListeners(),this.requestManager.removeAllListeners(),this.webSocketManager&&await new Promise(e=>{this.webSocketManager.once("close",()=>e()),this.webSocketManager.close()}),this.requestManager&&this.requestManager.clearState()}setupWebSocketHooks(){this.webSocketManager.on("maxReconnectAttemptsReached",this.handleMaxReconnectAttemptsReached.bind(this)),this.webSocketManager.on("authError",e=>{this.logger.error("Authentication error",e),this.emit("authError",e)})}async authenticate(e){try{await this.cleanupCurrentState();let r={...this.config,auth:e};this.initializeManagers(r),this.logger.info("Switched to authenticated mode"),this.emit("modeChanged","authenticated")}catch(r){throw this.logger.error("Error switching to authenticated mode",r),r}}async switchToAnonymous(){try{await this.cleanupCurrentState();let e={...this.config,auth:{method:"anonymous"}};this.initializeManagers(e),this.logger.info("Switched to anonymous mode"),this.emit("modeChanged","anonymous")}catch(e){throw this.logger.error("Error switching to anonymous mode",e),e}}onOpen(e){this.logger.info("onOpen callback registered"),this.webSocketManager.on("open",e)}onClose(e){this.logger.info("onClose callback registered"),this.webSocketManager.on("close",e)}onError(e){this.logger.info("onError callback registered"),this.webSocketManager.on("error",e)}onMessage(e){this.logger.info("onMessage callback registered"),this.webSocketManager.on("message",e)}handleMaxReconnectAttemptsReached(){this.logger.error("Maximum reconnection attempts reached. To try again, please refresh the page.")}validateConfig(e){if(!e.url)throw new Error("URL is required in the configuration")}async request(e,r,o){try{return this.requestManager.request(e,r,o)}catch(i){throw this.logger.error("Error making request",{requestType:e,error:i}),i}}registerMessageHandler(e,r){this.requestManager.on(e,r)}getConnectionState(){return this.webSocketManager.getState()}updateAuthentication(e){this.webSocketManager.reconnectWithNewAuth(e)}isAuthenticated(){return this.webSocketManager.isAuthenticated()}getCurrentMode(){return this.config.auth?.method==="anonymous"?"anonymous":"authenticated"}destroy(){this.removeAllListeners(),this.webSocketManager&&(this.webSocketManager.destroy(),this.webSocketManager=null),this.requestManager&&(this.requestManager.destroy(),this.requestManager=null),this.logger=null,this.config=null}};return J(re);})();
//# sourceMappingURL=bundle.js.map
