"use strict";var MicroserviceFramework=(()=>{var G=Object.create;var S=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var V=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports),z=(s,t)=>{for(var e in t)S(s,e,{get:t[e],enumerable:!0})},N=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of B(t))!F.call(s,n)&&n!==e&&S(s,n,{get:()=>t[n],enumerable:!(r=U(t,n))||r.enumerable});return s};var X=(s,t,e)=>(e=s!=null?G(j(s)):{},N(t||!s||!s.__esModule?S(e,"default",{value:s,enumerable:!0}):e,s)),J=s=>N(S({},"__esModule",{value:!0}),s);var L=V((se,C)=>{"use strict";var K=Object.prototype.hasOwnProperty,g="~";function b(){}Object.create&&(b.prototype=Object.create(null),new b().__proto__||(g=!1));function Y(s,t,e){this.fn=s,this.context=t,this.once=e||!1}function H(s,t,e,r,n){if(typeof e!="function")throw new TypeError("The listener must be a function");var i=new Y(e,r||s,n),a=g?g+t:t;return s._events[a]?s._events[a].fn?s._events[a]=[s._events[a],i]:s._events[a].push(i):(s._events[a]=i,s._eventsCount++),s}function M(s,t){--s._eventsCount===0?s._events=new b:delete s._events[t]}function l(){this._events=new b,this._eventsCount=0}l.prototype.eventNames=function(){var t=[],e,r;if(this._eventsCount===0)return t;for(r in e=this._events)K.call(e,r)&&t.push(g?r.slice(1):r);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};l.prototype.listeners=function(t){var e=g?g+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,i=r.length,a=new Array(i);n<i;n++)a[n]=r[n].fn;return a};l.prototype.listenerCount=function(t){var e=g?g+t:t,r=this._events[e];return r?r.fn?1:r.length:0};l.prototype.emit=function(t,e,r,n,i,a){var c=g?g+t:t;if(!this._events[c])return!1;var o=this._events[c],d=arguments.length,p,u;if(o.fn){switch(o.once&&this.removeListener(t,o.fn,void 0,!0),d){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,e),!0;case 3:return o.fn.call(o.context,e,r),!0;case 4:return o.fn.call(o.context,e,r,n),!0;case 5:return o.fn.call(o.context,e,r,n,i),!0;case 6:return o.fn.call(o.context,e,r,n,i,a),!0}for(u=1,p=new Array(d-1);u<d;u++)p[u-1]=arguments[u];o.fn.apply(o.context,p)}else{var $=o.length,y;for(u=0;u<$;u++)switch(o[u].once&&this.removeListener(t,o[u].fn,void 0,!0),d){case 1:o[u].fn.call(o[u].context);break;case 2:o[u].fn.call(o[u].context,e);break;case 3:o[u].fn.call(o[u].context,e,r);break;case 4:o[u].fn.call(o[u].context,e,r,n);break;default:if(!p)for(y=1,p=new Array(d-1);y<d;y++)p[y-1]=arguments[y];o[u].fn.apply(o[u].context,p)}}return!0};l.prototype.on=function(t,e,r){return H(this,t,e,r,!1)};l.prototype.once=function(t,e,r){return H(this,t,e,r,!0)};l.prototype.removeListener=function(t,e,r,n){var i=g?g+t:t;if(!this._events[i])return this;if(!e)return M(this,i),this;var a=this._events[i];if(a.fn)a.fn===e&&(!n||a.once)&&(!r||a.context===r)&&M(this,i);else{for(var c=0,o=[],d=a.length;c<d;c++)(a[c].fn!==e||n&&!a[c].once||r&&a[c].context!==r)&&o.push(a[c]);o.length?this._events[i]=o.length===1?o[0]:o:M(this,i)}return this};l.prototype.removeAllListeners=function(t){var e;return t?(e=g?g+t:t,this._events[e]&&M(this,e)):(this._events=new b,this._eventsCount=0),this};l.prototype.off=l.prototype.removeListener;l.prototype.addListener=l.prototype.on;l.prefixed=g;l.EventEmitter=l;typeof C<"u"&&(C.exports=l)});var re={};z(re,{AuthMethod:()=>O,BrowserConsoleStrategy:()=>m,CommunicationsManager:()=>x,WebSocketManager:()=>v,WebSocketState:()=>T});var P=X(L(),1);var f=P.default;var k,Q=new Uint8Array(16);function E(){if(!k&&(k=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!k))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return k(Q)}var _=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Z(s){return typeof s=="string"&&_.test(s)}var W=Z;var h=[];for(q=0;q<256;++q)h.push((q+256).toString(16).substr(1));var q;function ee(s){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=(h[s[t+0]]+h[s[t+1]]+h[s[t+2]]+h[s[t+3]]+"-"+h[s[t+4]]+h[s[t+5]]+"-"+h[s[t+6]]+h[s[t+7]]+"-"+h[s[t+8]]+h[s[t+9]]+"-"+h[s[t+10]]+h[s[t+11]]+h[s[t+12]]+h[s[t+13]]+h[s[t+14]]+h[s[t+15]]).toLowerCase();if(!W(e))throw TypeError("Stringified UUID is invalid");return e}var D=ee;function te(s,t,e){s=s||{};var r=s.random||(s.rng||E)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){e=e||0;for(var n=0;n<16;++n)t[e+n]=r[n];return t}return D(r)}var w=te;var A=class s{constructor(){}async send(t,e){let r=s.truncateAndStringify(t,0,this.MAX_STRING_LENGTH,this.MAX_DEPTH),n={header:this.createRequestHeader(),body:r};await this.sendPackaged(n,e)}createRequestHeader(){return{timestamp:Date.now(),requestId:w(),requesterAddress:"log-strategy",requestType:"LOG::MESSAGE"}}static truncateAndStringify(t,e=0,r=5e3,n=10){if(e>n)return"[Object depth limit exceeded]";if(t==null)return t;if(typeof t=="string")return t.length>r?t.substring(0,r)+"...":t;if(typeof t=="number"||typeof t=="boolean")return t;if(t instanceof Error)return{name:t.name,message:this.truncateAndStringify(t.message),stack:this.truncateAndStringify(t.stack)};if(this.isBufferOrArrayBufferView(t))return`[Binary data of length ${t.byteLength}]`;if(Array.isArray(t))return t.map(i=>this.truncateAndStringify(i,e+1));if(typeof t=="object"){let i={};for(let[a,c]of Object.entries(t))i[a]=this.truncateAndStringify(c,e+1);return i}return"[Unserializable data]"}static isBufferOrArrayBufferView(t){return!!(typeof Buffer<"u"&&Buffer.isBuffer(t)||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)}};var R=class R extends A{constructor(t=5e3,e=10){super(),this.MAX_STRING_LENGTH=t,this.MAX_DEPTH=e}isLogMessage(t){return typeof t=="object"&&t!==null&&"timestamp"in t&&"level"in t&&"message"in t}async sendPackaged(t,e){let{header:r,body:n}=t,i=e?.logLevel||1;this.isLogMessage(n)?this.formatLogMessage(n,r.requestId):this.formatGenericMessage(n,i,r.timestamp,r.requestId)}formatLogMessage(t,e){let{sender:r,timestamp:n,level:i,message:a,payload:c}=t,o=parseInt(i)||1,d=R.LOG_COLORS[o];console.groupCollapsed(`%c[${o}] ${new Date(n).toISOString()}`,d),r&&console.log(`Sender: ${r}`),console.log(`Message: ${a}`),console.log(`RequestID: ${e}`),c&&console.log("Payload:",c),console.groupEnd()}formatGenericMessage(t,e,r,n){let i=R.LOG_COLORS[e];console.groupCollapsed(`%c[${e}] ${new Date(r).toISOString()}`,i),console.log(`RequestID: ${n}`),typeof t=="object"&&t!==null?console.log("Message:",t):console.log(`Message: ${t}`),console.groupEnd()}async log(t,e=1){await this.send(t,{logLevel:e})}async info(t,e){await this.log({message:t,data:e},1)}async warn(t,e){await this.log({message:t,data:e},2)}async error(t,e){await this.log({message:t,data:e},3)}async debug(t,e){await this.log({message:t,data:e},0)}};R.LOG_COLORS={1:"color: blue",2:"color: orange",3:"color: red",0:"color: green"};var m=R;var T=(n=>(n[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED",n))(T||{}),O=(r=>(r.TOKEN="token",r.CREDENTIALS="credentials",r.ANONYMOUS="anonymous",r))(O||{}),v=class extends f{constructor(e){super();this.reconnectAttempts=0;this.state=3;this.protocols=[];this.logger=new m,this.url=e.url,this.secure=e.secure||!1,this.auth=e.auth,this.maxReconnectAttempts=e.maxReconnectAttempts||5,this.reconnectInterval=e.reconnectInterval||5e3,this.connectionTimeout=e.connectionTimeout||1e4,this.setupAuthProtocols(),this.connect()}setupAuthProtocols(){if(this.auth)switch(this.auth.method){case"token":this.auth.token&&this.protocols.push(`token-${this.auth.token}`);break;case"credentials":if(this.auth.credentials){let{username:e,password:r}=this.auth.credentials,n=btoa(encodeURIComponent(r)).replace(/=/g,"");this.protocols.push(`auth-${e}-${n}`),this.logger.debug("Auth protocol",this.protocols)}break}}connect(){this.state=0;let e=this.getSecureUrl(this.url,this.secure),r=this.auth?.method==="token"&&this.auth.token?`${e}?token=${this.auth.token}`:e;this.logger.info(`Attempting to connect to ${r}`);try{this.ws=new WebSocket(r,this.protocols),this.setHooks(),this.setConnectionTimeout()}catch(n){this.handleConnectionError(n)}}handleConnectionError(e){this.logger.error("Connection error:",e),this.emit("error",{type:"CONNECTION_ERROR",message:"Failed to establish WebSocket connection",error:e})}getSecureUrl(e,r){return r?e.replace(/^ws:/,"wss:"):e}setHooks(){this.ws.onopen=()=>{this.clearConnectionTimeout(),this.state=1,this.reconnectAttempts=0,this.logger.info(`WebSocket opened. ReadyState: ${this.ws.readyState}`),this.emit("open")},this.ws.onerror=e=>{let r=e.target;if(r.readyState===WebSocket.CLOSED){let n={type:"CONNECTION_ERROR",message:"Connection failed",readyState:r.readyState,url:r.url};this.reconnectAttempts===0&&(n.type="AUTH_ERROR",n.message="Authentication required"),this.logger.error("WebSocket error:",n),this.emit("error",n)}else this.logger.error("WebSocket error:",e),this.emit("error",e)},this.ws.onclose=e=>{if(this.clearConnectionTimeout(),this.state=3,e.code===1001||e.code===1006||e.code===1008){let r={type:"AUTH_ERROR",code:e.code,reason:e.reason||"Authentication required"};this.emit("error",r);return}this.logger.info(`WebSocket closed. ReadyState: ${this.ws.readyState}. Code: ${e.code}, Reason: ${e.reason}`),this.emit("close",e),this.handleReconnection()},this.ws.onmessage=e=>{let r=this.parseMessage(e.data);this.emit("message",r)}}handleReconnection(){if(this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;let r=Math.max(1e3,this.reconnectInterval*Math.pow(2,this.reconnectAttempts-1));this.logger.info(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${r}ms...`),setTimeout(()=>this.connect(),r)}else this.logger.error("Max reconnection attempts reached. Please reconnect manually."),this.emit("maxReconnectAttemptsReached")}setConnectionTimeout(){this.connectionTimer=window.setTimeout(()=>{this.state===0&&(this.logger.error("Connection attempt timed out"),this.ws.close())},this.connectionTimeout)}clearConnectionTimeout(){this.connectionTimer&&window.clearTimeout(this.connectionTimer)}parseMessage(e){try{return JSON.parse(e)}catch{return e}}send(e){if(this.state===1){let r=typeof e=="string"?e:JSON.stringify(e);this.ws.send(r)}else{let r=new Error("WebSocket is not open");this.emit("error",r)}}close(){this.state=2,this.ws.close()}reconnect(){this.logger.debug("Manual reconnection initiated."),this.reconnectAttempts=0,this.close(),this.connect()}getState(){return this.state}getReadyState(){return this.ws.readyState}setAuthConfig(e){this.auth=e,this.setupAuthProtocols()}isAuthenticated(){return this.state===1}reconnectWithNewAuth(e){this.setAuthConfig(e),this.reconnect()}destroy(){this.clearConnectionTimeout(),this.ws&&(this.ws.onopen=null,this.ws.onclose=null,this.ws.onerror=null,this.ws.onmessage=null,this.state!==3&&this.close(),this.ws=null),this.removeAllListeners(),this.logger=null,this.auth=void 0,this.protocols=[]}};var I=class extends f{constructor(e){super();this.pendingRequests=new Map;this.requestHandlers=new Map;this.logger=new m,this.requestTimeout=e.requestTimeout||3e4,this.webSocketManager=e.webSocketManager,this.webSocketManager.on("message",this.handleMessage.bind(this))}async request(e,r,n){return new Promise((i,a)=>{let c=this.createRequest(e,r,n),o=setTimeout(()=>{this.pendingRequests.delete(c.header.requestId),a(new Error("Request timeout"))},this.requestTimeout),d=p=>{clearTimeout(o),this.pendingRequests.delete(c.header.requestId),p.body.success?i(p.body):a(p.body.error||p.body.data)};this.pendingRequests.set(c.header.requestId,d),this.webSocketManager.send(JSON.stringify(c))})}createRequest(e,r,n){return{header:{timestamp:Date.now(),requestId:`RM-${w()}`,requesterAddress:"RequestManager",recipientAddress:n,requestType:e,authToken:this.authToken},body:r}}handleMessage(e){try{e.header&&e.header.requestType?this.handleIncomingRequest(e):e.requestHeader?this.handleResponse(e):this.logger.warn("Received message with unknown structure:",e)}catch(r){this.logger.error("Error parsing message:",r)}}async handleIncomingRequest(e){let{requestType:r}=e.header;if(!r){this.logger.warn("Received request without requestType");return}if(this.listenerCount(r)>0)this.emit(r,e.body,e.header);else{this.logger.warn(`No handlers registered for requestType: ${r}`);let n={requestHeader:e.header,responseHeader:{responderAddress:"RequestManager",timestamp:Date.now()},body:{data:null,success:!1,error:new Error(`No handler registered for requestType: ${r}`)}};this.webSocketManager.send(JSON.stringify(n))}}handleResponse(e){let{requestType:r}=e.requestHeader;if(r=="MicroserviceFramework::StatusUpdate"&&this.listenerCount(r)>0){this.emit(r,e.body.data,e.requestHeader);return}let n=this.pendingRequests.get(e.requestHeader.requestId);n&&(n(e),this.pendingRequests.delete(e.requestHeader.requestId))}registerHandler(e,r){if(this.requestHandlers.has(e))throw new Error(`Handler already registered for requestType: ${e}`);this.requestHandlers.set(e,r),this.on(e,async(n,i)=>{try{let a=await r(n,i);if(!i.requiresResponse)return;let c={requestHeader:i,responseHeader:{responderAddress:"RequestManager",timestamp:Date.now()},body:{data:a,success:!0,error:null}};this.webSocketManager.send(JSON.stringify(c))}catch(a){if(!i.requiresResponse){this.logger.warn(`Request error not sent. No response required for requestType: ${e}`,a);return}let c={requestHeader:i,responseHeader:{responderAddress:"RequestManager",timestamp:Date.now()},body:{data:null,success:!1,error:a instanceof Error?a:new Error(String(a))}};this.webSocketManager.send(JSON.stringify(c))}})}removeHandler(e){this.requestHandlers.delete(e),this.removeAllListeners(e)}setAuthToken(e){this.authToken=e}clearAuthToken(){this.authToken=void 0}clearState(){for(let[e]of this.pendingRequests)this.pendingRequests.delete(e);this.clearAuthToken()}destroy(){for(let[e]of this.pendingRequests)this.pendingRequests.delete(e);this.webSocketManager.removeListener("message",this.handleMessage.bind(this)),this.removeAllListeners(),this.clearAuthToken(),this.webSocketManager=null,this.logger=null,this.pendingRequests=null}};var x=class extends f{constructor(e){super();this.logger=new m;this.lastHeartbeatTimestamp=0;this.config=e,this.validateConfig(e);try{this.initializeManagers(e)}catch(r){throw this.logger.error("Error initializing CommunicationsManager",{error:r}),new Error("Failed to initialize CommunicationsManager")}}initializeManagers(e){this.webSocketManager=new v({url:e.url,secure:e.secure,auth:e.auth,maxReconnectAttempts:e.maxReconnectAttempts,reconnectInterval:e.reconnectInterval}),this.requestManager=new I({webSocketManager:this.webSocketManager,requestTimeout:e.requestTimeout}),this.setupWebSocketHooks()}async cleanupCurrentState(){this.webSocketManager.removeAllListeners(),this.requestManager.removeAllListeners(),this.webSocketManager&&await new Promise(e=>{this.webSocketManager.once("close",()=>e()),this.webSocketManager.close()}),this.requestManager&&this.requestManager.clearState()}setupWebSocketHooks(){this.webSocketManager.on("maxReconnectAttemptsReached",this.handleMaxReconnectAttemptsReached.bind(this)),this.webSocketManager.on("authError",e=>{this.logger.error("Authentication error",e),this.emit("authError",e)}),this.registerMessageHandler("heartbeat",async(e,r)=>{let n=Date.now()-e.timestamp;return this.lastHeartbeatTimestamp=Date.now(),this.emit("heartbeat",{latency:n}),{requestTimestamp:e.timestamp,responseTimestamp:Date.now()}})}async authenticate(e){try{await this.cleanupCurrentState();let r={...this.config,auth:e};this.initializeManagers(r),this.logger.info("Switched to authenticated mode"),this.emit("modeChanged","authenticated")}catch(r){throw this.logger.error("Error switching to authenticated mode",r),r}}async switchToAnonymous(){try{await this.cleanupCurrentState();let e={...this.config,auth:{method:"anonymous"}};this.initializeManagers(e),this.logger.info("Switched to anonymous mode"),this.emit("modeChanged","anonymous")}catch(e){throw this.logger.error("Error switching to anonymous mode",e),e}}onOpen(e){this.logger.info("onOpen callback registered"),this.webSocketManager.on("open",e)}onClose(e){this.logger.info("onClose callback registered"),this.webSocketManager.on("close",e)}onError(e){this.logger.info("onError callback registered"),this.webSocketManager.on("error",e)}onMessage(e){this.logger.info("onMessage callback registered"),this.webSocketManager.on("message",e)}handleMaxReconnectAttemptsReached(){this.logger.error("Maximum reconnection attempts reached. To try again, please refresh the page.")}validateConfig(e){if(!e.url)throw new Error("URL is required in the configuration")}async request(e,r,n){try{return this.requestManager.request(e,r,n)}catch(i){throw this.logger.error("Error making request",{requestType:e,error:i}),i}}registerMessageHandler(e,r){this.requestManager.registerHandler(e,async(n,i)=>{try{return await r(n,i)}catch(a){throw a instanceof Error?a:new Error(String(a))}})}getConnectionState(){return this.webSocketManager.getState()}updateAuthentication(e){this.webSocketManager.reconnectWithNewAuth(e)}isAuthenticated(){return this.webSocketManager.isAuthenticated()}getCurrentMode(){return this.config.auth?.method==="anonymous"?"anonymous":"authenticated"}destroy(){this.removeAllListeners(),this.webSocketManager&&(this.webSocketManager.destroy(),this.webSocketManager=null),this.requestManager&&(this.requestManager.destroy(),this.requestManager=null),this.logger=null,this.config=null}getConnectionHealth(){return{connected:this.webSocketManager.getState()===1,lastHeartbeat:this.lastHeartbeatTimestamp}}};return J(re);})();
//# sourceMappingURL=bundle.js.map
