"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryPubSubConsumer = exports.PubSubConsumerClient = void 0;
const PubSubConsumer_1 = require("../../PubSubConsumer");
class PubSubConsumerClient {
    constructor() {
        this.channels = new Map();
    }
    async subscribe(channel) {
        if (!this.channels.has(channel)) {
            this.channels.set(channel, new Set());
        }
    }
    async unsubscribe(channel) {
        this.channels.delete(channel);
    }
    async publish(channel, message) {
        if (this.channels.has(channel)) {
            for (const callback of this.channels.get(channel)) {
                callback(message);
            }
        }
    }
    addCallback(channel, callback) {
        if (!this.channels.has(channel)) {
            this.channels.set(channel, new Set());
        }
        this.channels.get(channel).add(callback);
    }
    removeCallback(channel, callback) {
        if (this.channels.has(channel)) {
            this.channels.get(channel).delete(callback);
            if (this.channels.get(channel).size === 0) {
                this.channels.delete(channel);
            }
        }
    }
}
exports.PubSubConsumerClient = PubSubConsumerClient;
class MemoryPubSubConsumer extends PubSubConsumer_1.PubSubConsumer {
    constructor(client, options) {
        super(client, options);
        this.client = client;
        this.callbacks = new Map();
    }
    async subscribe(channel, callback) {
        await this.client.subscribe(channel);
        this.client.addCallback(channel, callback);
        if (!this.callbacks.has(channel)) {
            this.callbacks.set(channel, new Set());
        }
        this.callbacks.get(channel).add(callback);
    }
    async unsubscribe(channel) {
        if (this.callbacks.has(channel)) {
            for (const callback of this.callbacks.get(channel)) {
                this.client.removeCallback(channel, callback);
            }
            this.callbacks.delete(channel);
        }
        await this.client.unsubscribe(channel);
    }
    async publish(channel, message) {
        await this.client.publish(channel, message);
    }
}
exports.MemoryPubSubConsumer = MemoryPubSubConsumer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHViU3ViQ29uc3VtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvZXhhbXBsZS9iYWNrZW5kL1B1YlN1YkNvbnN1bWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHlEQUE2RTtBQUc3RSxNQUFhLG9CQUFvQjtJQUcvQjtRQUZRLGFBQVEsR0FBNkMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUV4RCxDQUFDO0lBRWhCLEtBQUssQ0FBQyxTQUFTLENBQUMsT0FBZTtRQUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ3hDLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFlO1FBQy9CLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQWUsRUFBRSxPQUFZO1FBQ3pDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUMvQixLQUFLLE1BQU0sUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBRSxFQUFFLENBQUM7Z0JBQ25ELFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNwQixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxXQUFXLENBQUMsT0FBZSxFQUFFLFFBQWdDO1FBQzNELElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDeEMsQ0FBQztRQUNELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBRSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsY0FBYyxDQUFDLE9BQWUsRUFBRSxRQUFnQztRQUM5RCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFFLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzdDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFFLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUMzQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoQyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXRDRCxvREFzQ0M7QUFJRCxNQUFhLG9CQUFxQixTQUFRLCtCQUFjO0lBR3RELFlBQ1ksTUFBNEIsRUFDdEMsT0FBb0M7UUFFcEMsS0FBSyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUhiLFdBQU0sR0FBTixNQUFNLENBQXNCO1FBSGhDLGNBQVMsR0FBNkMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQU94RSxDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQVMsQ0FDYixPQUFlLEVBQ2YsUUFBZ0M7UUFFaEMsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDakMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksR0FBRyxFQUFFLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQWU7UUFDL0IsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ2hDLEtBQUssTUFBTSxRQUFRLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFFLEVBQUUsQ0FBQztnQkFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ2hELENBQUM7WUFDRCxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNqQyxDQUFDO1FBQ0QsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFlLEVBQUUsT0FBWTtRQUN6QyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0Y7QUFuQ0Qsb0RBbUNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHViU3ViQ29uc3VtZXIsIFB1YlN1YkNvbnN1bWVyT3B0aW9ucyB9IGZyb20gXCIuLi8uLi9QdWJTdWJDb25zdW1lclwiO1xuaW1wb3J0IHsgSVB1YlN1YkNsaWVudCB9IGZyb20gXCIuLi8uLi9pbnRlcmZhY2VzXCI7XG5cbmV4cG9ydCBjbGFzcyBQdWJTdWJDb25zdW1lckNsaWVudCBpbXBsZW1lbnRzIElQdWJTdWJDbGllbnQge1xuICBwcml2YXRlIGNoYW5uZWxzOiBNYXA8c3RyaW5nLCBTZXQ8KG1lc3NhZ2U6IGFueSkgPT4gdm9pZD4+ID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKCkge31cblxuICBhc3luYyBzdWJzY3JpYmUoY2hhbm5lbDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmNoYW5uZWxzLmhhcyhjaGFubmVsKSkge1xuICAgICAgdGhpcy5jaGFubmVscy5zZXQoY2hhbm5lbCwgbmV3IFNldCgpKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB1bnN1YnNjcmliZShjaGFubmVsOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmNoYW5uZWxzLmRlbGV0ZShjaGFubmVsKTtcbiAgfVxuXG4gIGFzeW5jIHB1Ymxpc2goY2hhbm5lbDogc3RyaW5nLCBtZXNzYWdlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5jaGFubmVscy5oYXMoY2hhbm5lbCkpIHtcbiAgICAgIGZvciAoY29uc3QgY2FsbGJhY2sgb2YgdGhpcy5jaGFubmVscy5nZXQoY2hhbm5lbCkhKSB7XG4gICAgICAgIGNhbGxiYWNrKG1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFkZENhbGxiYWNrKGNoYW5uZWw6IHN0cmluZywgY2FsbGJhY2s6IChtZXNzYWdlOiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY2hhbm5lbHMuaGFzKGNoYW5uZWwpKSB7XG4gICAgICB0aGlzLmNoYW5uZWxzLnNldChjaGFubmVsLCBuZXcgU2V0KCkpO1xuICAgIH1cbiAgICB0aGlzLmNoYW5uZWxzLmdldChjaGFubmVsKSEuYWRkKGNhbGxiYWNrKTtcbiAgfVxuXG4gIHJlbW92ZUNhbGxiYWNrKGNoYW5uZWw6IHN0cmluZywgY2FsbGJhY2s6IChtZXNzYWdlOiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jaGFubmVscy5oYXMoY2hhbm5lbCkpIHtcbiAgICAgIHRoaXMuY2hhbm5lbHMuZ2V0KGNoYW5uZWwpIS5kZWxldGUoY2FsbGJhY2spO1xuICAgICAgaWYgKHRoaXMuY2hhbm5lbHMuZ2V0KGNoYW5uZWwpIS5zaXplID09PSAwKSB7XG4gICAgICAgIHRoaXMuY2hhbm5lbHMuZGVsZXRlKGNoYW5uZWwpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5pbnRlcmZhY2UgTWVtb3J5UHViU3ViQ29uc3VtZXJPcHRpb25zIGV4dGVuZHMgUHViU3ViQ29uc3VtZXJPcHRpb25zIHt9XG5cbmV4cG9ydCBjbGFzcyBNZW1vcnlQdWJTdWJDb25zdW1lciBleHRlbmRzIFB1YlN1YkNvbnN1bWVyIHtcbiAgcHJpdmF0ZSBjYWxsYmFja3M6IE1hcDxzdHJpbmcsIFNldDwobWVzc2FnZTogYW55KSA9PiB2b2lkPj4gPSBuZXcgTWFwKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGNsaWVudDogUHViU3ViQ29uc3VtZXJDbGllbnQsXG4gICAgb3B0aW9uczogTWVtb3J5UHViU3ViQ29uc3VtZXJPcHRpb25zXG4gICkge1xuICAgIHN1cGVyKGNsaWVudCwgb3B0aW9ucyk7XG4gIH1cblxuICBhc3luYyBzdWJzY3JpYmUoXG4gICAgY2hhbm5lbDogc3RyaW5nLFxuICAgIGNhbGxiYWNrOiAobWVzc2FnZTogYW55KSA9PiB2b2lkXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuY2xpZW50LnN1YnNjcmliZShjaGFubmVsKTtcbiAgICB0aGlzLmNsaWVudC5hZGRDYWxsYmFjayhjaGFubmVsLCBjYWxsYmFjayk7XG4gICAgaWYgKCF0aGlzLmNhbGxiYWNrcy5oYXMoY2hhbm5lbCkpIHtcbiAgICAgIHRoaXMuY2FsbGJhY2tzLnNldChjaGFubmVsLCBuZXcgU2V0KCkpO1xuICAgIH1cbiAgICB0aGlzLmNhbGxiYWNrcy5nZXQoY2hhbm5lbCkhLmFkZChjYWxsYmFjayk7XG4gIH1cblxuICBhc3luYyB1bnN1YnNjcmliZShjaGFubmVsOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5jYWxsYmFja3MuaGFzKGNoYW5uZWwpKSB7XG4gICAgICBmb3IgKGNvbnN0IGNhbGxiYWNrIG9mIHRoaXMuY2FsbGJhY2tzLmdldChjaGFubmVsKSEpIHtcbiAgICAgICAgdGhpcy5jbGllbnQucmVtb3ZlQ2FsbGJhY2soY2hhbm5lbCwgY2FsbGJhY2spO1xuICAgICAgfVxuICAgICAgdGhpcy5jYWxsYmFja3MuZGVsZXRlKGNoYW5uZWwpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLmNsaWVudC51bnN1YnNjcmliZShjaGFubmVsKTtcbiAgfVxuXG4gIGFzeW5jIHB1Ymxpc2goY2hhbm5lbDogc3RyaW5nLCBtZXNzYWdlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmNsaWVudC5wdWJsaXNoKGNoYW5uZWwsIG1lc3NhZ2UpO1xuICB9XG59XG4iXX0=